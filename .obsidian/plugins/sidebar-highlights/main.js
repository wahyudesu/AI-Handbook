/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var St=Object.defineProperty;var Lt=Object.getOwnPropertyDescriptor;var Bt=Object.getOwnPropertyNames;var Rt=Object.prototype.hasOwnProperty;var $t=($,r)=>{for(var t in r)St($,t,{get:r[t],enumerable:!0})},Ot=($,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Bt(r))!Rt.call($,s)&&s!==t&&St($,s,{get:()=>r[s],enumerable:!(e=Lt(r,s))||e.enumerable});return $};var Vt=$=>Ot(St({},"__esModule",{value:!0}),$);var Gt={};$t(Gt,{CollectionsManager:()=>kt,default:()=>wt});module.exports=Vt(Gt);var b=require("obsidian");var f=require("obsidian");var U=require("obsidian");var Pt=require("obsidian");var Dt={commands:{createHighlight:"Create highlight from selection",toggle:"Toggle",goToCollection:"Go to {{name}}",applyDisplayMode:"Apply display mode: {{name}}"},tabs:{currentNote:"Current note",allNotes:"All notes",collections:"Collections",tasks:"Tasks"},settings:{display:{heading:"Display",showTitles:{name:"Show note titles in all notes and collections",desc:"Display the filename/note title below highlights when viewing All Notes or Collections."},showTimestamps:{name:"Show note timestamps",desc:"Display creation timestamps for highlights."},showActions:{name:"Show highlight actions",desc:"Display the actions area below each highlight (filename, stats, and buttons)."},showToolbar:{name:"Show toolbar",desc:"Display the toolbar with search, grouping, and other action buttons."},autoUnfold:{name:"Auto-unfold on focus",desc:"Automatically unfold content when focusing highlights from the sidebar."},dateFormat:{name:"Date format",desc:"Format string for timestamps using moment.js syntax (e.g., YYYY-MM-DD HH:mm, MMM DD YYYY, DD/MM/YYYY h:mm A).",placeholder:"YYYY-MM-DD HH:mm"},minimumCharCount:{name:"Minimum character count",desc:"Hide highlights and native comments shorter than this character count from the sidebar (default 0).",placeholder:"0"}},views:{heading:"Views",showCurrentNoteTab:{name:"Show Current Note tab",desc:"Show the Current Note tab in the sidebar."},showAllNotesTab:{name:"Show All Notes tab",desc:"Show the All Notes tab in the sidebar."},showCollectionsTab:{name:"Show Collections tab",desc:"Show the Collections tab in the sidebar."},showTasksTab:{name:"Show Tasks tab",desc:"Show the Tasks tab in the sidebar."}},displayModes:{heading:"Display modes",saveCurrentLabel:"Save current settings as a display mode",saveCurrentDesc:"Create a new display mode from your current Display and Views settings. Saved modes can be applied from the Command Palette or using the Apply button below.",saveButton:"Add display mode",noModes:"No display modes saved yet. Create one to get started.",applyButton:"Apply",appliedButton:"Applied",updateButton:"Update",updateTooltip:"Update this mode with current settings",renameButton:"Rename",deleteButton:"Delete"},typography:{heading:"Typography",highlightTextSize:{name:"Main highlight text",desc:"Adjust main highlight text size (default 11).",placeholder:"11"},detailsTextSize:{name:"Details text size",desc:"Adjust details text size (filename, line number, etc) (default 11).",placeholder:"11"},commentTextSize:{name:"Comment text size",desc:"Adjust comment text size (default 11).",placeholder:"11"},highlightTextWeight:{name:"Highlight text weight",desc:"Adjust font weight for sidebar highlights (default Normal)."},taskTextWeight:{name:"Task text weight",desc:"Adjust font weight for sidebar tasks (default Normal)."},fontWeight:{light:"Light (300)",normal:"Normal (400)",medium:"Medium (500)",semiBold:"Semi Bold (600)",bold:"Bold (700)"}},styling:{heading:"Styling"},colors:{heading:"Colors",highlightColor:"Highlight color: {{color}}",customizeFirst:"Customize the first highlight color for the sidebar hover color picker.",customizeSecond:"Customize the second highlight color for the sidebar hover color picker.",customizeThird:"Customize the third highlight color for the sidebar hover color picker.",customizeFourth:"Customize the fourth highlight color for the sidebar hover color picker.",customizeFifth:"Customize the fifth highlight color for the sidebar hover color picker.",reset:"Reset",resetToYellow:"Reset to default yellow (#ffd700)",resetToRed:"Reset to default red (#ff6b6b)",resetToTeal:"Reset to default teal (#4ecdc4)",resetToBlue:"Reset to default blue (#45b7d1)",resetToGreen:"Reset to default green (#96ceb4)"},colorNames:{heading:"Color names",nameFor:"Name for {{color}}",desc:"Optional: Add a custom name for this color to use in Group By Color instead of the hex code.",placeholder:'e.g., "Important", "Research"'},comments:{heading:"Comments",useInlineFootnotes:{name:"Use inline footnotes by default",desc:"When adding comments via the sidebar, use inline footnotes (^[comment]) instead of standard footnotes ([^ref]: comment)."},selectTextOnClick:{name:"Select text on click",desc:"When clicking a comment, select the comment instead of positioning the cursor in front of it. Note: Only works for inline footnotes (^[...]) and standard footnotes ([^1]), not HTML comments or custom patterns."}},detection:{heading:"Detection",detectHtmlComments:{name:"Detect HTML comments",desc:"Detect HTML comments (<!-- -->) as highlights. Note: HTML comments are hidden in Live Preview mode and only visible in Source mode."},detectAdjacentNativeComments:{name:"Detect adjacent native comments",desc:"When enabled, native Obsidian comments (%% %%) that appear immediately after a highlight will be treated as comments for that highlight. When disabled, all native comments appear separately in the sidebar."},customPatterns:{heading:"Custom patterns",experimental:"Experimental",desc:"Define custom highlight or comment patterns using regex. This allows detection of syntax from other plugins or custom formats.",examples:"Examples:",forRegexMark:"for Regex Mark plugin, or",forWikilinks:"for wikilinks.",addButton:"Add custom pattern",editButton:"Edit",deleteButton:"Delete"}},filters:{heading:"Filters",excludeExcalidraw:{name:"Exclude Excalidraw files",desc:"Skip .excalidraw files when scanning for highlights. This prevents highlights from being detected in Excalidraw drawing files."},excludedFiles:{name:"File filters",desc:"Include or exclude specific files and folders from being scanned for highlights and tasks.",manageButton:"Manage"}},tasks:{heading:"Tasks",showTaskContext:{name:"Show task notes",desc:"Tasks containing bulleted text will display as notes under the task."},showCompletedTasks:{name:"Show completed tasks",desc:"Include completed tasks (- [x]) in the Tasks tab."},showCurrentNoteSection:{name:"Show current note tasks",desc:"Display a dedicated section at the top of the Tasks tab showing tasks from the currently active note."},showOnlyCurrentNoteTasks:{name:"Only display current note tasks",desc:"When enabled, hide all other tasks and only show tasks from the current note."},taskDateFormat:{name:"Due date format",desc:"Date format for parsing due dates in tasks (e.g., YYYY-MM-DD, MM/DD/YYYY). Due dates matching this format will be displayed as badges.",placeholder:"YYYY-MM-DD"}},backupRestore:{heading:"Backup and restore",restoreLatest:{name:"Restore from backup",desc:"Restore collections that contain highlights from a backup. Sidebar Highlights automatically creates periodic backups. Highlights in Collections that no longer exist in your vault will not be restored.",button:"Restore latest"},choose:{button:"Choose"},createManual:{name:"Create backup",desc:"Create a backup of your collections.",button:"Create"},noBackups:"No backups found. Backups are created automatically when settings are migrated or when external changes are detected.",emptyBackup:"The latest backup does not contain any collections.",unknownDate:"Unknown date",confirmTitle:"Confirm Restore",confirmRestore:`Restore {{collections}} collection(s) (containing {{highlights}} highlight(s)) from backup created at {{date}}?

This will replace your current collections.`,cancel:"Cancel",restore:"Restore",restoreSuccess:"Successfully restored {{collections}} collection(s) (containing {{highlights}} highlight(s)).",orphanedCleaned:"Removed {{count}} reference(s) to deleted highlights.",restoreFailed:"Failed to restore from backup. Please check the console for details.",manualBackupCreated:"Manual backup created successfully"}},sidebar:{title:"Highlights"},toolbar:{search:"Search",searchPlaceholder:"Search highlights, use #tag @collection (-# to exclude)...",group:"Group highlights",secondaryGroup:"Secondary grouping",sort:"Sort highlights",toggleComments:"Toggle native comments",toggleHighlightComments:"Toggle highlight comments",revertColors:"Revert highlight colors",filter:"Filter",actions:"Actions",backToCollections:"Back to Collections",newCollection:"New collection",closeSearch:"Close search"},actions:{moveToCollection:"Move to...",removeFromCollection:"Remove from Collection",clearSelection:"Clear selection"},grouping:{none:"None",color:"Color",commentsAsc:"Highlight comments \u2191",commentsDesc:"Highlight comments \u2193",dateAsc:"Date created \u2191",dateDesc:"Date created \u2193",dueDate:"Due date",parent:"Parent",collection:"Collection",filename:"Filename",tag:"Tag",date:"Date",flagged:"Flagged"},sorting:{none:"None",aToZ:"A \u2192 Z",zToA:"Z \u2192 A",priority:"Priority",dateEarliestFirst:"Date (Earliest First)",dateLatestFirst:"Date (Latest First)"},emptyStates:{noComments:"No Comments",noTags:"No Tags",root:"Root",noCollections:"No Collections",noDate:"No Date",noSection:"No section",allTasks:"All Tasks",default:"Default",noCollectionsYet:"No collections.",noDescription:"No description",noHighlightsInCollection:"No highlights in collection.",noMatchingInCollection:"No matching highlights in collection.",noFileOpen:"No file open.",pdfNotSupported:"PDF highlights are not supported.",noMatching:"No matching highlights.",noHighlightsInFile:"No highlights in this file.",noMatchingAcrossAll:"No matching highlights across all files.",noHighlightsAcrossAll:"No highlights found across all files.",loadingTasks:"Loading tasks...",noMatchingTasks:"No matching tasks across all files.",noTasksAcrossAll:"No tasks found across all files.",noCollectionsAvailable:"No collections available",noTagsOrFilters:"No tags or filters found",overdue:"Overdue",today:"Today",upcoming:"Upcoming",flagged:"Flagged",unflagged:"Unflagged"},contextMenu:{openNewTab:"Open in new tab",openRight:"Open to the right",edit:"Edit",delete:"Delete",markUnread:"Mark as Unread",markRead:"Mark as Read",markAboveRead:"Mark above as read",markBelowRead:"Mark below as read"},filterMenu:{clear:"Clear",flagged:"Flagged",upcoming:"This Week",completed:"Completed",incomplete:"Incomplete",dueToday:"Due Today",overdue:"Overdue",noDate:"No Date",noteCreated:"Note Created",last7Days:"Last 7 days",last30Days:"Last 30 days",lastYear:"Last year"},dateSuggestions:{today:"Today",tomorrow:"Tomorrow",yesterday:"Yesterday",endOfWeek:"End of this week",inOneWeek:"In one week",inTwoWeeks:"In two weeks",dayFromNow:"{{count}} day from now",daysFromNow:"{{count}} days from now",dayAgo:"{{count}} day ago",daysAgo:"{{count}} days ago",weekFromNow:"{{count}} week from now",weeksFromNow:"{{count}} weeks from now",weekAgo:"{{count}} week ago",weeksAgo:"{{count}} weeks ago",monthFromNow:"{{count}} month from now",monthsFromNow:"{{count}} months from now",monthAgo:"{{count}} month ago",monthsAgo:"{{count}} months ago",next:"Next",last:"Last",this:"This",monday:"Monday",tuesday:"Tuesday",wednesday:"Wednesday",thursday:"Thursday",friday:"Friday",saturday:"Saturday",sunday:"Sunday"},tasks:{currentNote:"Current Note"},modals:{collection:{createTitle:"Create a new collection",editTitle:"Edit collection",nameLabel:"Collection name",nameDesc:"The name of your collection (Required)",namePlaceholder:"Important Highlights",descLabel:"Collection description",descDesc:"Provide more context about the collection (Optional)",descPlaceholder:"Research, etc.",cancel:"Cancel",create:"Create collection",save:"Save changes",nameRequired:"Collection name is required"},excludedFiles:{title:"File filters",noFilter:"No file filters are applied. Add one below.",currentlyExcluded:"Files matching the following filters are currently excluded:",currentlyIncluded:"Files matching the following filters are currently included:",included:"Included",excluded:"Excluded",filterLabel:"Add filter",filterPlaceholder:"Enter file or folder path...",exclude:"Exclude",include:"Include",add:"Add",cancel:"Cancel",save:"Save",removedNonExistent:"Removed {{count}} {{paths}} that no longer exist",alreadyExists:"{{path}} is already in the filter list"},taskDate:{title:"Due Date"},customPattern:{editTitle:"Edit custom pattern",addTitle:"Add custom pattern",nameLabel:"Name",nameDesc:'A descriptive name for this pattern (e.g., "Regex Mark", "IA Writer comments")',namePlaceholder:"Pattern name",patternLabel:"Pattern",patternDesc:"Regex pattern with a capturing group for the content. Examples:",patternPlaceholder:"//(.+)//",typeLabel:"Type",typeDesc:"Whether to treat matches as highlights or comments",typeHighlight:"Highlight",typeComment:"Comment",cancel:"Cancel",save:"Save",nameRequired:"Please enter a name for the pattern",patternRequired:"Please enter a regex pattern",invalidRegex:"Invalid regex pattern",capturingGroupRequired:"Pattern must include a capturing group, e.g., //(.+)//",conflictWarning:"Warning: Pattern may conflict with built-in {{name}}. This could cause unexpected behavior."},displayMode:{createTitle:"Add display mode",renameTitle:"Rename display mode",nameLabel:"Name",nameDesc:"A descriptive name for this display configuration",namePlaceholder:'e.g., "Reading Mode", "Full View"',cancel:"Cancel",save:"Save",nameRequired:"Please enter a name for the display mode"},backupSelector:{title:"Choose Backup",manual:"Manual",automatic:"Automatic",stats:"{{collections}} Collections \u2022 {{highlights}} Collection Highlights",restore:"Restore",close:"Close"}},notices:{highlightCreated:"Highlight created",noTextSelected:"Please select some text first",noActiveFile:"No active file",displayModeSaved:'Display mode "{{name}}" saved',displayModeApplied:'Applied display mode "{{name}}"',displayModeUpdated:'Display mode "{{name}}" updated',displayModeRenamed:'Display mode renamed to "{{name}}"',displayModeDeleted:'Display mode "{{name}}" deleted'}};var Nt={commands:{createHighlight:"\u4ECE\u9009\u4E2D\u6587\u672C\u521B\u5EFA\u9AD8\u4EAE",toggle:"\u5207\u6362",goToCollection:"\u8F6C\u5230{{name}}",applyDisplayMode:"\u5E94\u7528\u663E\u793A\u6A21\u5F0F\uFF1A{{name}}"},tabs:{currentNote:"\u5F53\u524D\u7B14\u8BB0",allNotes:"\u6240\u6709\u7B14\u8BB0",collections:"\u5408\u96C6",tasks:"\u4EFB\u52A1"},settings:{display:{heading:"\u663E\u793A",showTitles:{name:"\u5728\u6240\u6709\u7B14\u8BB0\u548C\u5408\u96C6\u4E2D\u663E\u793A\u7B14\u8BB0\u6807\u9898",desc:"\u5728\u67E5\u770B\u6240\u6709\u7B14\u8BB0\u6216\u5408\u96C6\u65F6\uFF0C\u5728\u9AD8\u4EAE\u4E0B\u65B9\u663E\u793A\u6587\u4EF6\u540D/\u7B14\u8BB0\u6807\u9898\u3002"},showTimestamps:{name:"\u663E\u793A\u7B14\u8BB0\u65F6\u95F4\u6233",desc:"\u663E\u793A\u9AD8\u4EAE\u7684\u521B\u5EFA\u65F6\u95F4\u6233\u3002"},showActions:{name:"\u663E\u793A\u9AD8\u4EAE\u64CD\u4F5C",desc:"\u5728\u6BCF\u4E2A\u9AD8\u4EAE\u4E0B\u65B9\u663E\u793A\u64CD\u4F5C\u533A\u57DF\uFF08\u6587\u4EF6\u540D\u3001\u7EDF\u8BA1\u4FE1\u606F\u548C\u6309\u94AE\uFF09\u3002"},showToolbar:{name:"\u663E\u793A\u5DE5\u5177\u680F",desc:"\u663E\u793A\u5305\u542B\u641C\u7D22\u3001\u5206\u7EC4\u548C\u5176\u4ED6\u64CD\u4F5C\u6309\u94AE\u7684\u5DE5\u5177\u680F\u3002"},autoUnfold:{name:"\u805A\u7126\u65F6\u81EA\u52A8\u5C55\u5F00",desc:"\u4ECE\u4FA7\u8FB9\u680F\u805A\u7126\u9AD8\u4EAE\u65F6\u81EA\u52A8\u5C55\u5F00\u5185\u5BB9\u3002"},dateFormat:{name:"\u65E5\u671F\u683C\u5F0F",desc:"\u4F7F\u7528 moment.js \u8BED\u6CD5\u7684\u65F6\u95F4\u6233\u683C\u5F0F\u5B57\u7B26\u4E32\uFF08\u4F8B\u5982\uFF1AYYYY-MM-DD HH:mm\u3001MMM DD YYYY\u3001DD/MM/YYYY h:mm A\uFF09\u3002",placeholder:"YYYY-MM-DD HH:mm"},minimumCharCount:{name:"\u6700\u5C0F\u5B57\u7B26\u6570",desc:"\u5728\u4FA7\u8FB9\u680F\u4E2D\u9690\u85CF\u5C11\u4E8E\u6B64\u5B57\u7B26\u6570\u7684\u9AD8\u4EAE\u548C\u539F\u751F\u6CE8\u91CA\uFF08\u9ED8\u8BA4\u4E3A 0\uFF09\u3002",placeholder:"0"}},views:{heading:"\u89C6\u56FE",showCurrentNoteTab:{name:"\u663E\u793A\u3010\u5F53\u524D\u7B14\u8BB0\u3011\u6807\u7B7E\u9875",desc:"\u5728\u4FA7\u8FB9\u680F\u4E2D\u663E\u793A\u3010\u5F53\u524D\u7B14\u8BB0\u3011\u6807\u7B7E\u9875\u3002"},showAllNotesTab:{name:"\u663E\u793A\u3010\u6240\u6709\u7B14\u8BB0\u3011\u6807\u7B7E\u9875",desc:"\u5728\u4FA7\u8FB9\u680F\u4E2D\u663E\u793A\u3010\u6240\u6709\u7B14\u8BB0\u3011\u6807\u7B7E\u9875\u3002"},showCollectionsTab:{name:"\u663E\u793A\u3010\u5408\u96C6\u3011\u6807\u7B7E\u9875",desc:"\u5728\u4FA7\u8FB9\u680F\u4E2D\u663E\u793A\u3010\u5408\u96C6\u3011\u6807\u7B7E\u9875\u3002"},showTasksTab:{name:"\u663E\u793A\u3010\u4EFB\u52A1\u3011\u6807\u7B7E\u9875",desc:"\u5728\u4FA7\u8FB9\u680F\u4E2D\u663E\u793A\u3010\u4EFB\u52A1\u3011\u6807\u7B7E\u9875\u3002"}},displayModes:{heading:"\u663E\u793A\u6A21\u5F0F",saveCurrentLabel:"\u5C06\u5F53\u524D\u8BBE\u7F6E\u4FDD\u5B58\u4E3A\u663E\u793A\u6A21\u5F0F",saveCurrentDesc:"\u4ECE\u5F53\u524D\u7684\u3010\u663E\u793A\u3011\u548C\u3010\u89C6\u56FE\u3011\u8BBE\u7F6E\u521B\u5EFA\u65B0\u7684\u663E\u793A\u6A21\u5F0F\u3002\u4FDD\u5B58\u7684\u6A21\u5F0F\u53EF\u4EE5\u901A\u8FC7\u547D\u4EE4\u9762\u677F\u6216\u4E0B\u65B9\u7684\u3010\u5E94\u7528\u3011\u6309\u94AE\u4F7F\u7528\u3002",saveButton:"\u6DFB\u52A0\u663E\u793A\u6A21\u5F0F",noModes:"\u5C1A\u672A\u4FDD\u5B58\u663E\u793A\u6A21\u5F0F\u3002\u521B\u5EFA\u4E00\u4E2A\u5F00\u59CB\u4F7F\u7528\u3002",applyButton:"\u5E94\u7528",appliedButton:"\u5DF2\u5E94\u7528",updateButton:"\u66F4\u65B0",updateTooltip:"\u4F7F\u7528\u5F53\u524D\u8BBE\u7F6E\u66F4\u65B0\u6B64\u6A21\u5F0F",renameButton:"\u91CD\u547D\u540D",deleteButton:"\u5220\u9664"},typography:{heading:"\u6392\u7248",highlightTextSize:{name:"\u4E3B\u9AD8\u4EAE\u6587\u672C",desc:"\u8C03\u6574\u4E3B\u9AD8\u4EAE\u6587\u672C\u5927\u5C0F\uFF08\u9ED8\u8BA4\u4E3A 11\uFF09\u3002",placeholder:"11"},detailsTextSize:{name:"\u8BE6\u7EC6\u4FE1\u606F\u6587\u672C\u5927\u5C0F",desc:"\u8C03\u6574\u8BE6\u7EC6\u4FE1\u606F\u6587\u672C\u5927\u5C0F\uFF08\u6587\u4EF6\u540D\u3001\u884C\u53F7\u7B49\uFF09\uFF08\u9ED8\u8BA4\u4E3A 11\uFF09\u3002",placeholder:"11"},commentTextSize:{name:"\u6CE8\u91CA\u6587\u672C\u5927\u5C0F",desc:"\u8C03\u6574\u6CE8\u91CA\u6587\u672C\u5927\u5C0F\uFF08\u9ED8\u8BA4\u4E3A 11\uFF09\u3002",placeholder:"11"}},styling:{heading:"\u6837\u5F0F"},colors:{heading:"\u989C\u8272",highlightColor:"\u9AD8\u4EAE\u989C\u8272\uFF1A{{color}}",customizeFirst:"\u4E3A\u4FA7\u8FB9\u680F\u60AC\u505C\u989C\u8272\u9009\u62E9\u5668\u81EA\u5B9A\u4E49\u7B2C\u4E00\u4E2A\u9AD8\u4EAE\u989C\u8272\u3002",customizeSecond:"\u4E3A\u4FA7\u8FB9\u680F\u60AC\u505C\u989C\u8272\u9009\u62E9\u5668\u81EA\u5B9A\u4E49\u7B2C\u4E8C\u4E2A\u9AD8\u4EAE\u989C\u8272\u3002",customizeThird:"\u4E3A\u4FA7\u8FB9\u680F\u60AC\u505C\u989C\u8272\u9009\u62E9\u5668\u81EA\u5B9A\u4E49\u7B2C\u4E09\u4E2A\u9AD8\u4EAE\u989C\u8272\u3002",customizeFourth:"\u4E3A\u4FA7\u8FB9\u680F\u60AC\u505C\u989C\u8272\u9009\u62E9\u5668\u81EA\u5B9A\u4E49\u7B2C\u56DB\u4E2A\u9AD8\u4EAE\u989C\u8272\u3002",customizeFifth:"\u4E3A\u4FA7\u8FB9\u680F\u60AC\u505C\u989C\u8272\u9009\u62E9\u5668\u81EA\u5B9A\u4E49\u7B2C\u4E94\u4E2A\u9AD8\u4EAE\u989C\u8272\u3002",reset:"\u91CD\u7F6E",resetToYellow:"\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u9EC4\u8272 (#ffd700)",resetToRed:"\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u7EA2\u8272 (#ff6b6b)",resetToTeal:"\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u9752\u8272 (#4ecdc4)",resetToBlue:"\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u84DD\u8272 (#45b7d1)",resetToGreen:"\u91CD\u7F6E\u4E3A\u9ED8\u8BA4\u7EFF\u8272 (#96ceb4)"},colorNames:{heading:"\u989C\u8272\u540D\u79F0",nameFor:"{{color}} \u7684\u540D\u79F0",desc:"\u53EF\u9009\uFF1A\u4E3A\u6B64\u989C\u8272\u6DFB\u52A0\u81EA\u5B9A\u4E49\u540D\u79F0\uFF0C\u4EE5\u4FBF\u5728\u3010\u6309\u989C\u8272\u5206\u7EC4\u3011\u4E2D\u4F7F\u7528\uFF0C\u800C\u4E0D\u662F\u663E\u793A\u5341\u516D\u8FDB\u5236\u4EE3\u7801\u3002",placeholder:"\u4F8B\u5982\uFF1A\u3010\u91CD\u8981\u3011\u3001\u3010\u7814\u7A76\u3011"},comments:{heading:"\u6CE8\u91CA",useInlineFootnotes:{name:"\u9ED8\u8BA4\u4F7F\u7528\u5185\u8054\u811A\u6CE8",desc:"\u901A\u8FC7\u4FA7\u8FB9\u680F\u6DFB\u52A0\u6CE8\u91CA\u65F6\uFF0C\u4F7F\u7528\u5185\u8054\u811A\u6CE8 (^[\u6CE8\u91CA]) \u800C\u4E0D\u662F\u6807\u51C6\u811A\u6CE8 ([^ref]: \u6CE8\u91CA)\u3002"},selectTextOnClick:{name:"\u70B9\u51FB\u65F6\u9009\u62E9\u6587\u672C",desc:"\u70B9\u51FB\u6CE8\u91CA\u65F6\uFF0C\u9009\u62E9\u6CE8\u91CA\u800C\u4E0D\u662F\u5C06\u5149\u6807\u5B9A\u4F4D\u5728\u5176\u524D\u9762\u3002\u6CE8\u610F\uFF1A\u4EC5\u9002\u7528\u4E8E\u5185\u8054\u811A\u6CE8 (^[...]) \u548C\u6807\u51C6\u811A\u6CE8 ([^1])\uFF0C\u4E0D\u9002\u7528\u4E8E HTML \u6CE8\u91CA\u6216\u81EA\u5B9A\u4E49\u6A21\u5F0F\u3002"}},detection:{heading:"\u68C0\u6D4B",detectHtmlComments:{name:"\u68C0\u6D4B HTML \u6CE8\u91CA",desc:"\u5C06 HTML \u6CE8\u91CA (<!-- -->) \u68C0\u6D4B\u4E3A\u9AD8\u4EAE\u3002\u6CE8\u610F\uFF1AHTML \u6CE8\u91CA\u5728\u5B9E\u65F6\u9884\u89C8\u6A21\u5F0F\u4E0B\u9690\u85CF\uFF0C\u4EC5\u5728\u6E90\u7801\u6A21\u5F0F\u4E0B\u53EF\u89C1\u3002"},detectAdjacentNativeComments:{name:"\u68C0\u6D4B\u76F8\u90BB\u7684\u539F\u751F\u6CE8\u91CA",desc:"\u542F\u7528\u65F6\uFF0C\u7D27\u8DDF\u5728\u9AD8\u4EAE\u540E\u7684 Obsidian \u539F\u751F\u6CE8\u91CA (%% %%) \u5C06\u88AB\u89C6\u4E3A\u8BE5\u9AD8\u4EAE\u7684\u6CE8\u91CA\u3002\u7981\u7528\u65F6\uFF0C\u6240\u6709\u539F\u751F\u6CE8\u91CA\u5C06\u5355\u72EC\u663E\u793A\u5728\u4FA7\u8FB9\u680F\u4E2D\u3002"},customPatterns:{heading:"\u81EA\u5B9A\u4E49\u6A21\u5F0F",experimental:"\u5B9E\u9A8C\u6027",desc:"\u4F7F\u7528\u6B63\u5219\u8868\u8FBE\u5F0F\u5B9A\u4E49\u81EA\u5B9A\u4E49\u9AD8\u4EAE\u6216\u6CE8\u91CA\u6A21\u5F0F\u3002\u8FD9\u5141\u8BB8\u68C0\u6D4B\u6765\u81EA\u5176\u4ED6\u63D2\u4EF6\u6216\u81EA\u5B9A\u4E49\u683C\u5F0F\u7684\u8BED\u6CD5\u3002",examples:"\u793A\u4F8B\uFF1A",forRegexMark:"\u7528\u4E8E Regex Mark \u63D2\u4EF6\uFF0C\u6216",forWikilinks:"\u7528\u4E8E\u7EF4\u57FA\u94FE\u63A5\u3002",addButton:"\u6DFB\u52A0\u81EA\u5B9A\u4E49\u6A21\u5F0F",editButton:"\u7F16\u8F91",deleteButton:"\u5220\u9664"}},filters:{heading:"\u8FC7\u6EE4\u5668",excludeExcalidraw:{name:"\u6392\u9664 Excalidraw \u6587\u4EF6",desc:"\u626B\u63CF\u9AD8\u4EAE\u65F6\u8DF3\u8FC7 .excalidraw \u6587\u4EF6\u3002\u8FD9\u53EF\u4EE5\u9632\u6B62\u5728 Excalidraw \u7ED8\u56FE\u6587\u4EF6\u4E2D\u68C0\u6D4B\u5230\u9AD8\u4EAE\u3002"},excludedFiles:{name:"\u6587\u4EF6\u8FC7\u6EE4\u5668",desc:"\u5305\u542B\u6216\u6392\u9664\u7279\u5B9A\u6587\u4EF6\u548C\u6587\u4EF6\u5939\uFF0C\u4E0D\u626B\u63CF\u5176\u9AD8\u4EAE\u548C\u4EFB\u52A1\u3002",manageButton:"\u7BA1\u7406"}},tasks:{heading:"\u4EFB\u52A1",showTaskContext:{name:"\u663E\u793A\u4EFB\u52A1\u7B14\u8BB0",desc:"\u5305\u542B\u9879\u76EE\u7B26\u53F7\u6587\u672C\u7684\u4EFB\u52A1\u5C06\u5728\u4EFB\u52A1\u4E0B\u65B9\u663E\u793A\u4E3A\u7B14\u8BB0\u3002"},showCompletedTasks:{name:"\u663E\u793A\u5DF2\u5B8C\u6210\u7684\u4EFB\u52A1",desc:"\u5728\u3010\u4EFB\u52A1\u3011\u6807\u7B7E\u9875\u4E2D\u5305\u542B\u5DF2\u5B8C\u6210\u7684\u4EFB\u52A1 (- [x])\u3002"},showCurrentNoteSection:{name:"\u663E\u793A\u5F53\u524D\u7B14\u8BB0\u4EFB\u52A1",desc:"\u5728\u3010\u4EFB\u52A1\u3011\u6807\u7B7E\u9875\u9876\u90E8\u663E\u793A\u4E00\u4E2A\u4E13\u95E8\u90E8\u5206,\u663E\u793A\u5F53\u524D\u6D3B\u52A8\u7B14\u8BB0\u4E2D\u7684\u4EFB\u52A1\u3002"},showOnlyCurrentNoteTasks:{name:"\u4EC5\u663E\u793A\u5F53\u524D\u7B14\u8BB0\u4EFB\u52A1",desc:"\u542F\u7528\u65F6\uFF0C\u9690\u85CF\u6240\u6709\u5176\u4ED6\u4EFB\u52A1\uFF0C\u4EC5\u663E\u793A\u5F53\u524D\u7B14\u8BB0\u4E2D\u7684\u4EFB\u52A1\u3002"},taskDateFormat:{name:"\u622A\u6B62\u65E5\u671F\u683C\u5F0F",desc:"\u7528\u4E8E\u89E3\u6790\u4EFB\u52A1\u4E2D\u622A\u6B62\u65E5\u671F\u7684\u65E5\u671F\u683C\u5F0F\uFF08\u4F8B\u5982\uFF1AYYYY-MM-DD\u3001MM/DD/YYYY\uFF09\u3002\u5339\u914D\u6B64\u683C\u5F0F\u7684\u622A\u6B62\u65E5\u671F\u5C06\u663E\u793A\u4E3A\u5FBD\u7AE0\u3002",placeholder:"YYYY-MM-DD"}},backupRestore:{heading:"\u5907\u4EFD\u548C\u6062\u590D",restoreLatest:{name:"\u4ECE\u5907\u4EFD\u6062\u590D",desc:"\u4ECE\u5907\u4EFD\u6062\u590D\u5305\u542B\u9AD8\u4EAE\u7684\u6536\u85CF\u3002Sidebar Highlights \u4F1A\u81EA\u52A8\u521B\u5EFA\u5B9A\u671F\u5907\u4EFD\u3002\u6536\u85CF\u4E2D\u4E0D\u518D\u5B58\u5728\u4E8E\u60A8\u7B14\u8BB0\u5E93\u4E2D\u7684\u9AD8\u4EAE\u5C06\u4E0D\u4F1A\u88AB\u6062\u590D\u3002",button:"\u6062\u590D\u6700\u65B0"},choose:{button:"\u9009\u62E9"},createManual:{name:"\u521B\u5EFA\u5907\u4EFD",desc:"\u521B\u5EFA\u60A8\u6536\u85CF\u7684\u5907\u4EFD\u3002",button:"\u521B\u5EFA"},noBackups:"\u672A\u627E\u5230\u5907\u4EFD\u3002\u5907\u4EFD\u4F1A\u5728\u8BBE\u7F6E\u8FC1\u79FB\u6216\u68C0\u6D4B\u5230\u5916\u90E8\u66F4\u6539\u65F6\u81EA\u52A8\u521B\u5EFA\u3002",emptyBackup:"\u6700\u65B0\u5907\u4EFD\u4E0D\u5305\u542B\u4EFB\u4F55\u6536\u85CF\u3002",unknownDate:"\u672A\u77E5\u65E5\u671F",confirmTitle:"\u786E\u8BA4\u6062\u590D",confirmRestore:`\u4ECE {{date}} \u521B\u5EFA\u7684\u5907\u4EFD\u4E2D\u6062\u590D {{collections}} \u4E2A\u6536\u85CF\uFF08\u5305\u542B {{highlights}} \u4E2A\u9AD8\u4EAE\uFF09\uFF1F

\u8FD9\u5C06\u66FF\u6362\u60A8\u5F53\u524D\u7684\u6536\u85CF\u3002`,cancel:"\u53D6\u6D88",restore:"\u6062\u590D",restoreSuccess:"\u6210\u529F\u6062\u590D {{collections}} \u4E2A\u6536\u85CF\uFF08\u5305\u542B {{highlights}} \u4E2A\u9AD8\u4EAE\uFF09\u3002",orphanedCleaned:"\u5DF2\u79FB\u9664 {{count}} \u4E2A\u5DF2\u5220\u9664\u9AD8\u4EAE\u7684\u5F15\u7528\u3002",restoreFailed:"\u4ECE\u5907\u4EFD\u6062\u590D\u5931\u8D25\u3002\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u4E86\u89E3\u8BE6\u60C5\u3002",manualBackupCreated:"\u624B\u52A8\u5907\u4EFD\u521B\u5EFA\u6210\u529F"}},sidebar:{title:"\u9AD8\u4EAE"},toolbar:{search:"\u641C\u7D22",searchPlaceholder:"\u641C\u7D22\u9AD8\u4EAE\uFF0C\u4F7F\u7528 #\u6807\u7B7E @\u5408\u96C6\uFF08-# \u6392\u9664\uFF09...",group:"\u5206\u7EC4\u9AD8\u4EAE",secondaryGroup:"\u4E8C\u7EA7\u5206\u7EC4",sort:"\u6392\u5E8F\u9AD8\u4EAE",toggleComments:"\u5207\u6362\u539F\u751F\u6CE8\u91CA",toggleHighlightComments:"\u5207\u6362\u9AD8\u4EAE\u6CE8\u91CA",revertColors:"\u8FD8\u539F\u9AD8\u4EAE\u989C\u8272",filter:"\u8FC7\u6EE4",actions:"\u64CD\u4F5C",backToCollections:"\u8FD4\u56DE\u5408\u96C6",newCollection:"\u65B0\u5EFA\u5408\u96C6",closeSearch:"\u5173\u95ED\u641C\u7D22"},actions:{moveToCollection:"\u79FB\u52A8\u5230...",removeFromCollection:"\u4ECE\u5408\u96C6\u4E2D\u79FB\u9664",clearSelection:"\u6E05\u9664\u9009\u62E9"},grouping:{none:"\u65E0",color:"\u989C\u8272",commentsAsc:"\u9AD8\u4EAE\u6CE8\u91CA \u2191",commentsDesc:"\u9AD8\u4EAE\u6CE8\u91CA \u2193",dateAsc:"\u521B\u5EFA\u65E5\u671F \u2191",dateDesc:"\u521B\u5EFA\u65E5\u671F \u2193",dueDate:"\u622A\u6B62\u65E5\u671F",parent:"\u7236\u7EA7",collection:"\u5408\u96C6",filename:"\u6587\u4EF6\u540D",tag:"\u6807\u7B7E",date:"\u65E5\u671F",flagged:"\u5DF2\u6807\u8BB0"},sorting:{none:"\u65E0",aToZ:"A \u2192 Z",zToA:"Z \u2192 A",priority:"\u4F18\u5148\u7EA7",dateEarliestFirst:"\u65E5\u671F\uFF08\u6700\u65E9\u4F18\u5148\uFF09",dateLatestFirst:"\u65E5\u671F\uFF08\u6700\u665A\u4F18\u5148\uFF09"},emptyStates:{noComments:"\u65E0\u6CE8\u91CA",noTags:"\u65E0\u6807\u7B7E",root:"\u6839\u76EE\u5F55",noCollections:"\u65E0\u5408\u96C6",noDate:"\u65E0\u65E5\u671F",noSection:"\u65E0\u7AE0\u8282",allTasks:"\u6240\u6709\u4EFB\u52A1",default:"\u9ED8\u8BA4",noCollectionsYet:"\u6682\u65E0\u5408\u96C6\u3002",noDescription:"\u65E0\u63CF\u8FF0",noHighlightsInCollection:"\u5408\u96C6\u4E2D\u65E0\u9AD8\u4EAE\u3002",noMatchingInCollection:"\u5408\u96C6\u4E2D\u65E0\u5339\u914D\u7684\u9AD8\u4EAE\u3002",noFileOpen:"\u672A\u6253\u5F00\u6587\u4EF6\u3002",pdfNotSupported:"\u4E0D\u652F\u6301 PDF \u9AD8\u4EAE\u3002",noMatching:"\u65E0\u5339\u914D\u7684\u9AD8\u4EAE\u3002",noHighlightsInFile:"\u6B64\u6587\u4EF6\u4E2D\u65E0\u9AD8\u4EAE\u3002",noMatchingAcrossAll:"\u6240\u6709\u6587\u4EF6\u4E2D\u65E0\u5339\u914D\u7684\u9AD8\u4EAE\u3002",noHighlightsAcrossAll:"\u6240\u6709\u6587\u4EF6\u4E2D\u672A\u627E\u5230\u9AD8\u4EAE\u3002",loadingTasks:"\u52A0\u8F7D\u4EFB\u52A1\u4E2D...",noMatchingTasks:"\u6240\u6709\u6587\u4EF6\u4E2D\u65E0\u5339\u914D\u7684\u4EFB\u52A1\u3002",noTasksAcrossAll:"\u6240\u6709\u6587\u4EF6\u4E2D\u672A\u627E\u5230\u4EFB\u52A1\u3002",noCollectionsAvailable:"\u65E0\u53EF\u7528\u5408\u96C6",noTagsOrFilters:"\u672A\u627E\u5230\u6807\u7B7E\u6216\u8FC7\u6EE4\u5668",overdue:"\u5DF2\u903E\u671F",today:"\u4ECA\u5929",upcoming:"\u5373\u5C06\u5230\u6765",flagged:"\u5DF2\u6807\u8BB0",unflagged:"\u672A\u6807\u8BB0"},contextMenu:{openNewTab:"\u5728\u65B0\u6807\u7B7E\u9875\u4E2D\u6253\u5F00",openRight:"\u5728\u53F3\u4FA7\u6253\u5F00",edit:"\u7F16\u8F91",delete:"\u5220\u9664",markUnread:"\u6807\u8BB0\u4E3A\u672A\u8BFB",markRead:"\u6807\u8BB0\u4E3A\u5DF2\u8BFB",markAboveRead:"\u5C06\u4E0A\u65B9\u6807\u8BB0\u4E3A\u5DF2\u8BFB",markBelowRead:"\u5C06\u4E0B\u65B9\u6807\u8BB0\u4E3A\u5DF2\u8BFB"},filterMenu:{clear:"\u6E05\u9664",flagged:"\u5DF2\u6807\u8BB0",upcoming:"\u672C\u5468",completed:"\u5DF2\u5B8C\u6210",incomplete:"\u672A\u5B8C\u6210",dueToday:"\u4ECA\u5929\u5230\u671F",overdue:"\u5DF2\u903E\u671F",noDate:"\u65E0\u65E5\u671F",noteCreated:"\u7B14\u8BB0\u521B\u5EFA",last7Days:"\u6700\u8FD17\u5929",last30Days:"\u6700\u8FD130\u5929",lastYear:"\u6700\u8FD1\u4E00\u5E74"},dateSuggestions:{today:"\u4ECA\u5929",tomorrow:"\u660E\u5929",yesterday:"\u6628\u5929",endOfWeek:"\u672C\u5468\u7ED3\u675F",inOneWeek:"\u4E00\u5468\u540E",inTwoWeeks:"\u4E24\u5468\u540E",dayFromNow:"{{count}} \u5929\u540E",daysFromNow:"{{count}} \u5929\u540E",dayAgo:"{{count}} \u5929\u524D",daysAgo:"{{count}} \u5929\u524D",weekFromNow:"{{count}} \u5468\u540E",weeksFromNow:"{{count}} \u5468\u540E",weekAgo:"{{count}} \u5468\u524D",weeksAgo:"{{count}} \u5468\u524D",monthFromNow:"{{count}} \u6708\u540E",monthsFromNow:"{{count}} \u6708\u540E",monthAgo:"{{count}} \u6708\u524D",monthsAgo:"{{count}} \u6708\u524D",next:"\u4E0B",last:"\u4E0A",this:"\u672C",monday:"\u5468\u4E00",tuesday:"\u5468\u4E8C",wednesday:"\u5468\u4E09",thursday:"\u5468\u56DB",friday:"\u5468\u4E94",saturday:"\u5468\u516D",sunday:"\u5468\u65E5"},tasks:{currentNote:"\u5F53\u524D\u7B14\u8BB0"},modals:{collection:{createTitle:"\u521B\u5EFA\u65B0\u5408\u96C6",editTitle:"\u7F16\u8F91\u5408\u96C6",nameLabel:"\u5408\u96C6\u540D\u79F0",nameDesc:"\u5408\u96C6\u7684\u540D\u79F0\uFF08\u5FC5\u586B\uFF09",namePlaceholder:"\u91CD\u8981\u9AD8\u4EAE",descLabel:"\u5408\u96C6\u63CF\u8FF0",descDesc:"\u63D0\u4F9B\u6709\u5173\u5408\u96C6\u7684\u66F4\u591A\u4E0A\u4E0B\u6587\uFF08\u53EF\u9009\uFF09",descPlaceholder:"\u7814\u7A76\u7B49",cancel:"\u53D6\u6D88",create:"\u521B\u5EFA\u5408\u96C6",save:"\u4FDD\u5B58\u66F4\u6539",nameRequired:"\u5408\u96C6\u540D\u79F0\u4E3A\u5FC5\u586B\u9879"},excludedFiles:{title:"\u6587\u4EF6\u8FC7\u6EE4\u5668",noFilter:"\u5F53\u524D\u672A\u5E94\u7528\u6587\u4EF6\u8FC7\u6EE4\u5668\u3002\u5728\u4E0B\u65B9\u6DFB\u52A0\u4E00\u4E2A\u3002",currentlyExcluded:"\u5F53\u524D\u6392\u9664\u4E86\u5339\u914D\u4EE5\u4E0B\u8FC7\u6EE4\u5668\u7684\u6587\u4EF6\uFF1A",currentlyIncluded:"\u5F53\u524D\u5305\u542B\u4E86\u5339\u914D\u4EE5\u4E0B\u8FC7\u6EE4\u5668\u7684\u6587\u4EF6\uFF1A",included:"\u5DF2\u5305\u542B",excluded:"\u5DF2\u6392\u9664",filterLabel:"\u6DFB\u52A0\u8FC7\u6EE4\u5668",filterPlaceholder:"\u8F93\u5165\u6587\u4EF6\u6216\u6587\u4EF6\u5939\u8DEF\u5F84...",exclude:"\u6392\u9664",include:"\u5305\u542B",add:"\u6DFB\u52A0",cancel:"\u53D6\u6D88",save:"\u4FDD\u5B58",removedNonExistent:"\u5DF2\u5220\u9664 {{count}} \u4E2A\u4E0D\u5B58\u5728\u7684{{paths}}",alreadyExists:"{{path}} \u5DF2\u5728\u8FC7\u6EE4\u5668\u5217\u8868\u4E2D"},taskDate:{title:"\u622A\u6B62\u65E5\u671F"},customPattern:{editTitle:"\u7F16\u8F91\u81EA\u5B9A\u4E49\u6A21\u5F0F",addTitle:"\u6DFB\u52A0\u81EA\u5B9A\u4E49\u6A21\u5F0F",nameLabel:"\u540D\u79F0",nameDesc:"\u6B64\u6A21\u5F0F\u7684\u63CF\u8FF0\u6027\u540D\u79F0\uFF08\u4F8B\u5982\uFF1A\u3010Regex Mark\u3011\u3001\u3010IA Writer \u6CE8\u91CA\u3011\uFF09",namePlaceholder:"\u6A21\u5F0F\u540D\u79F0",patternLabel:"\u6A21\u5F0F",patternDesc:"\u5305\u542B\u5185\u5BB9\u6355\u83B7\u7EC4\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u6A21\u5F0F\u3002\u793A\u4F8B\uFF1A",patternPlaceholder:"//(.+)//",typeLabel:"\u7C7B\u578B",typeDesc:"\u5C06\u5339\u914D\u9879\u89C6\u4E3A\u9AD8\u4EAE\u8FD8\u662F\u6CE8\u91CA",typeHighlight:"\u9AD8\u4EAE",typeComment:"\u6CE8\u91CA",cancel:"\u53D6\u6D88",save:"\u4FDD\u5B58",nameRequired:"\u8BF7\u8F93\u5165\u6A21\u5F0F\u540D\u79F0",patternRequired:"\u8BF7\u8F93\u5165\u6B63\u5219\u8868\u8FBE\u5F0F\u6A21\u5F0F",invalidRegex:"\u65E0\u6548\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u6A21\u5F0F",capturingGroupRequired:"\u6A21\u5F0F\u5FC5\u987B\u5305\u542B\u6355\u83B7\u7EC4\uFF0C\u4F8B\u5982\uFF1A//(.+)//",conflictWarning:"\u8B66\u544A\uFF1A\u6A21\u5F0F\u53EF\u80FD\u4E0E\u5185\u7F6E{{name}}\u51B2\u7A81\u3002\u8FD9\u53EF\u80FD\u5BFC\u81F4\u610F\u5916\u884C\u4E3A\u3002"},displayMode:{createTitle:"\u6DFB\u52A0\u663E\u793A\u6A21\u5F0F",renameTitle:"\u91CD\u547D\u540D\u663E\u793A\u6A21\u5F0F",nameLabel:"\u540D\u79F0",nameDesc:"\u6B64\u663E\u793A\u914D\u7F6E\u7684\u63CF\u8FF0\u6027\u540D\u79F0",namePlaceholder:"\u4F8B\u5982\uFF1A\u3010\u9605\u8BFB\u6A21\u5F0F\u3011\u3001\u3010\u5B8C\u6574\u89C6\u56FE\u3011",cancel:"\u53D6\u6D88",save:"\u4FDD\u5B58",nameRequired:"\u8BF7\u8F93\u5165\u663E\u793A\u6A21\u5F0F\u540D\u79F0"},backupSelector:{title:"\u9009\u62E9\u5907\u4EFD",manual:"\u624B\u52A8",automatic:"\u81EA\u52A8",stats:"{{collections}} \u4E2A\u6536\u85CF \u2022 {{highlights}} \u4E2A\u6536\u85CF\u9AD8\u4EAE",restore:"\u6062\u590D",close:"\u5173\u95ED"}},notices:{highlightCreated:"\u5DF2\u521B\u5EFA\u9AD8\u4EAE",noTextSelected:"\u8BF7\u5148\u9009\u62E9\u4E00\u4E9B\u6587\u672C",noActiveFile:"\u6CA1\u6709\u6D3B\u52A8\u6587\u4EF6",displayModeSaved:"\u663E\u793A\u6A21\u5F0F\u3010{{name}}\u3011\u5DF2\u4FDD\u5B58",displayModeApplied:"\u5DF2\u5E94\u7528\u663E\u793A\u6A21\u5F0F\u3010{{name}}\u3011",displayModeUpdated:"\u663E\u793A\u6A21\u5F0F\u3010{{name}}\u3011\u5DF2\u66F4\u65B0",displayModeRenamed:"\u663E\u793A\u6A21\u5F0F\u5DF2\u91CD\u547D\u540D\u4E3A\u3010{{name}}\u3011",displayModeDeleted:"\u663E\u793A\u6A21\u5F0F\u3010{{name}}\u3011\u5DF2\u5220\u9664"}};var At={en:Dt,"zh-cn":Nt},Et=class{constructor(){this.locale="en";this.translations={};this.fallbackTranslations={}}async init(){try{if(this.locale=this.normalizeLocale(Pt.moment.locale()),this.fallbackTranslations=this.loadTranslations("en"),this.locale!=="en"){let r=this.loadTranslations(this.locale);r?this.translations=r:(console.warn(`[i18n] No translations found for locale "${this.locale}", falling back to English`),this.translations=this.fallbackTranslations,this.locale="en")}else this.translations=this.fallbackTranslations}catch(r){console.error("[i18n] Critical error during initialization:",r),this.fallbackTranslations={},this.translations={},this.locale="en"}}normalizeLocale(r){return r.toLowerCase().startsWith("zh")?"zh-cn":"en"}loadTranslations(r){return At[r]||At.en}getNestedValue(r,t){let e=t.split("."),s=r;for(let n of e)if(s&&typeof s=="object"&&n in s)s=s[n];else return;return typeof s=="string"?s:void 0}t(r,t){let e=this.getNestedValue(this.translations,r);return e===void 0&&(e=this.getNestedValue(this.fallbackTranslations,r),e===void 0)?(console.warn(`Translation key not found: "${r}"`),r):t?this.interpolate(e,t):e}interpolate(r,t){return r.replace(/\{\{(\w+)\}\}/g,(e,s)=>t[s]!==void 0?String(t[s]):e)}getLocale(){return this.locale}},Mt=new Et,d=($,r)=>Mt.t($,r);var lt=class extends U.Modal{constructor(t,e){super(t);this.onSubmit=e}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:d("modals.collection.createTitle")});e.style.marginBottom="20px",new U.Setting(t).setName(d("modals.collection.nameLabel")).setDesc(d("modals.collection.nameDesc")).addText(a=>{this.nameInput=a.inputEl,a.setPlaceholder(d("modals.collection.namePlaceholder")).onChange(l=>{let o=t.querySelector(".mod-cta");o&&(o.disabled=!l.trim())}),window.setTimeout(()=>a.inputEl.focus(),100)}),new U.Setting(t).setName(d("modals.collection.descLabel")).setDesc(d("modals.collection.descDesc")).addText(a=>{this.descriptionInput=a.inputEl,a.setPlaceholder(d("modals.collection.descPlaceholder"))});let s=t.createDiv({cls:"modal-button-container"});s.createEl("button",{text:d("modals.collection.cancel")}).addEventListener("click",()=>this.close());let i=s.createEl("button",{text:d("modals.collection.create"),cls:"mod-cta"});i.disabled=!0,i.addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",a=>{a.key==="Enter"&&(a.ctrlKey||a.metaKey)?this.handleSubmit():a.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new U.Notice(d("modals.collection.nameRequired")),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}},rt=class extends U.Modal{constructor(t,e,s){super(t);this.collection=e,this.onSubmit=s}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:d("modals.collection.editTitle")});e.style.marginBottom="20px",new U.Setting(t).setName(d("modals.collection.nameLabel")).setDesc(d("modals.collection.nameDesc")).addText(a=>{this.nameInput=a.inputEl,a.setPlaceholder(d("modals.collection.namePlaceholder")).setValue(this.collection.name).onChange(l=>{let o=t.querySelector(".mod-cta");o&&(o.disabled=!l.trim())}),window.setTimeout(()=>{a.inputEl.focus(),a.inputEl.select()},100)}),new U.Setting(t).setName(d("modals.collection.descLabel")).setDesc(d("modals.collection.descDesc")).addText(a=>{this.descriptionInput=a.inputEl,a.setPlaceholder(d("modals.collection.descPlaceholder")).setValue(this.collection.description||"")});let s=t.createDiv({cls:"modal-button-container"});s.createEl("button",{text:d("modals.collection.cancel")}).addEventListener("click",()=>this.close()),s.createEl("button",{text:d("modals.collection.save"),cls:"mod-cta"}).addEventListener("click",()=>this.handleSubmit()),t.addEventListener("keydown",a=>{a.key==="Enter"&&(a.ctrlKey||a.metaKey)?this.handleSubmit():a.key==="Escape"&&this.close()})}handleSubmit(){let t=this.nameInput.value.trim(),e=this.descriptionInput.value.trim();if(!t){new U.Notice(d("modals.collection.nameRequired")),this.nameInput.focus();return}this.onSubmit(t,e),this.close()}onClose(){let{contentEl:t}=this;t.empty()}};var tt=require("obsidian"),ct=class{constructor(){this.activeDropdown=null;this.secondaryPanel=null;this.documentClickHandlers=[];this.keydownHandlers=[];this.isOpen=!1;this.checkboxElements=new Map;this.activeItems=[];this.expandedItemId=null;this.triggerElement=null}isDropdownOpen(){return this.isOpen}closeActiveDropdown(){this.activeDropdown&&this.activeDropdown.parentNode&&(this.activeDropdown.classList.remove("dropdown-constrained-height"),this.activeDropdown.style.removeProperty("--dropdown-max-height"),this.activeDropdown.style.removeProperty("--dropdown-top"),this.activeDropdown.style.removeProperty("--dropdown-left"),this.activeDropdown.parentNode.removeChild(this.activeDropdown)),this.secondaryPanel&&this.secondaryPanel.parentNode&&this.secondaryPanel.parentNode.removeChild(this.secondaryPanel),this.activeDropdown=null,this.secondaryPanel=null,this.triggerElement=null,this.isOpen=!1,this.checkboxElements.clear(),this.activeItems=[],this.expandedItemId=null,this.documentClickHandlers.forEach(r=>{document.removeEventListener("click",r)}),this.documentClickHandlers=[],this.keydownHandlers.forEach(r=>{document.removeEventListener("keydown",r)}),this.keydownHandlers=[]}showDropdown(r,t,e={position:"below"}){if(this.isOpen){this.closeActiveDropdown();return}this.triggerElement=r;let s=r.getBoundingClientRect(),n=document.createElement("div");n.className=`menu highlights-dropdown-menu ${e.className||""}`,n.classList.add("dropdown-positioned"),this.activeDropdown=n,this.isOpen=!0,this.activeItems=[...t],this.expandedItemId=null,this.renderItems(n,t,!1),document.body.appendChild(n);let i=n.getBoundingClientRect(),a=i.height,l=i.width,o=window.innerHeight,c=window.innerWidth,h=o-s.bottom,g=s.top,u,m;h>=a+8?(u=s.bottom+4,n.classList.add("dropdown-positioned-below")):g>=a+8?(u=s.top-a-4,n.classList.add("dropdown-positioned-above")):h>g?(u=s.bottom+4,n.classList.add("dropdown-positioned-below-constrained"),n.style.setProperty("--dropdown-max-height",`${h-8}px`),n.classList.add("dropdown-constrained-height")):(u=8,n.classList.add("dropdown-positioned-above-constrained"),n.style.setProperty("--dropdown-max-height",`${s.top-12}px`),n.classList.add("dropdown-constrained-height")),m=s.left,s.left+l>c-8&&(m=Math.max(8,s.right-l)),n.classList.add("dropdown-left-aligned"),n.style.setProperty("--dropdown-top",`${u}px`),n.style.setProperty("--dropdown-left",`${m}px`);let p=v=>{let S=n.contains(v.target),k=r.contains(v.target),I=this.secondaryPanel&&this.secondaryPanel.contains(v.target);!S&&!k&&!I&&this.closeActiveDropdown()};this.documentClickHandlers.push(p),window.setTimeout(()=>{document.addEventListener("click",p)},100);let y=v=>{v.key==="Escape"&&this.closeActiveDropdown()};this.keydownHandlers.push(y),document.addEventListener("keydown",y),n.addEventListener("mouseleave",v=>{setTimeout(()=>{let S=v.relatedTarget;this.secondaryPanel&&this.secondaryPanel.contains(S)||this.closeSecondaryPanel()},100)})}renderItems(r,t,e,s=0,n=!1){t.forEach((i,a)=>{if(i.separator){let l=document.createElement("div");l.className="menu-separator",r.appendChild(l);return}if(i.heading){let l=document.createElement("div");l.className="highlights-dropdown-heading",l.textContent=i.text,r.appendChild(l);return}this.renderItem(r,i,a,s,n),e&&i.children&&i.children.forEach((l,o)=>{this.renderItem(r,l,o,s+1,n)})})}renderItem(r,t,e,s,n=!1){let i=document.createElement("div");if(i.className=`menu-item ${t.className||"highlights-dropdown-item"}`,s>0&&i.classList.add("dropdown-child-item"),t.expandable){if(i.classList.add("dropdown-expandable-item"),t.icon){let l=document.createElement("div");l.className="menu-item-icon",(0,tt.setIcon)(l,t.icon),i.appendChild(l)}let a=document.createElement("span");a.textContent=t.text,i.appendChild(a),i.addEventListener("mouseenter",l=>{t.children&&(this.showSecondaryPanel(t.children,i),this.expandedItemId=t.id)})}else{if(t.checked!==void 0){let l=document.createElement("div");l.className="highlights-dropdown-check",t.checked?((0,tt.setIcon)(l,"check"),i.classList.add("is-checked")):t.uncheckedIcon&&(0,tt.setIcon)(l,t.uncheckedIcon),i.appendChild(l);let o=t.id||`item-${e}`;this.checkboxElements.set(o,{element:i,checkDiv:l})}else if(t.icon){let l=document.createElement("div");l.className="menu-item-icon",(0,tt.setIcon)(l,t.icon),i.appendChild(l)}let a=document.createElement("span");a.textContent=t.text,i.appendChild(a),i.addEventListener("click",l=>{if(l.preventDefault(),l.stopPropagation(),t.onClick&&t.onClick(),t.checked!==void 0){let o=t.id||`item-${e}`,c=!t.checked;t.checked=c,this.updateCheckboxState(o,c),n||this.checkShouldAutoClose()}})}r.appendChild(i)}findItem(r,t){for(let e of r){if(e.id===t)return e;if(e.children){let s=this.findItem(e.children,t);if(s)return s}}return null}closeSecondaryPanel(){this.secondaryPanel&&this.secondaryPanel.parentNode&&this.secondaryPanel.parentNode.removeChild(this.secondaryPanel),this.secondaryPanel=null}showSecondaryPanel(r,t){if(!this.activeDropdown)return;if(!this.secondaryPanel){let c=document.createElement("div");c.className="menu highlights-dropdown-menu highlights-dropdown-secondary",this.secondaryPanel=c,document.body.appendChild(c),c.addEventListener("mouseenter",()=>{}),c.addEventListener("mouseleave",()=>{this.closeSecondaryPanel()})}this.secondaryPanel.empty(),this.renderItems(this.secondaryPanel,r,!0,0,!0);let e=this.activeDropdown.getBoundingClientRect(),s=t.getBoundingClientRect(),n=window.innerWidth,i=e.left<n/2,a=this.secondaryPanel.getBoundingClientRect(),l;i?l=e.right-2:l=e.left-a.width+2;let o=s.top-4;this.secondaryPanel.style.setProperty("--dropdown-top",`${o}px`),this.secondaryPanel.style.setProperty("--dropdown-left",`${l}px`)}updateCheckboxState(r,t){let e=this.checkboxElements.get(r);if(!e)return;let{element:s,checkDiv:n}=e,i=this.findItemRecursive(this.activeItems,r);t?((0,tt.setIcon)(n,"check"),s.classList.add("is-checked")):(n.empty(),s.classList.remove("is-checked"),i&&i.uncheckedIcon&&(0,tt.setIcon)(n,i.uncheckedIcon))}findItemRecursive(r,t){for(let e of r){if((e.id||`item-${r.indexOf(e)}`)===t)return e;if(e.children){let n=this.findItemRecursive(e.children,t);if(n)return n}}return null}checkShouldAutoClose(){this.activeItems.some(t=>t.checked!==void 0&&t.checked===!0)||window.setTimeout(()=>{this.closeActiveDropdown()},100)}updateAllCheckboxStates(r){this.activeItems.forEach((t,e)=>{if(t.checked!==void 0){let s=t.id||`item-${e}`;r.hasOwnProperty(s)&&(t.checked=r[s],this.updateCheckboxState(s,r[s]))}}),this.checkShouldAutoClose()}cleanup(){this.closeActiveDropdown()}};var G=require("obsidian"),ht=class{constructor(r){this.plugin=r}createFileContextMenu(r){let t=new G.Menu;return t.addItem(e=>{e.setTitle("Open in new tab").setIcon("lucide-plus").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","tab")})}),t.addItem(e=>{e.setTitle("Open to the right").setIcon("lucide-separator-vertical").onClick(()=>{this.plugin.app.workspace.openLinkText(r.path,"","split")})}),t.addSeparator(),t}createHighlightItem(r,t,e={}){let s=r.createDiv({cls:`highlight-item-card${this.plugin.selectedHighlightId===t.id?" selected":""}`,attr:{"data-highlight-id":t.id}});return this.applyHighlightStyling(s,t),this.createHoverColorPicker(s,t,e),this.createQuoteSection(s,t,e),this.createActionsSection(s,t,e),this.createCommentsSection(s,t,e),s}applyHighlightStyling(r,t){if(t.isNativeComment&&!t.color)r.classList.add("highlight-native-comment");else{let e=t.color||this.plugin.settings.highlightColor,s=this.getColorClassName(e);r.classList.add(s),s==="highlight-color-default"&&(r.classList.remove("highlight-color-default"),r.classList.add("highlight-color-custom"),r.style.setProperty("--highlight-color",e))}this.plugin.selectedHighlightId===t.id&&r.classList.add("highlight-selected")}getColorClassName(r){return{[this.plugin.settings.customColors.yellow]:"highlight-color-yellow",[this.plugin.settings.customColors.red]:"highlight-color-red",[this.plugin.settings.customColors.teal]:"highlight-color-teal",[this.plugin.settings.customColors.blue]:"highlight-color-blue",[this.plugin.settings.customColors.green]:"highlight-color-green"}[r]||"highlight-color-default"}createQuoteSection(r,t,e){let s=r.createDiv({cls:"highlight-quote"});this.renderMarkdownToElement(s,t.text),e.searchTerm&&e.searchTerm.length>0&&this.highlightSearchMatches(s,e.searchTerm),this.addTagsToQuote(s,t,e),this.createCopyButtonInQuote(s,t),s.addEventListener("click",n=>{var i;(i=e.onHighlightClick)==null||i.call(e,t,n)}),s.addEventListener("mouseover",n=>{this.plugin.app.workspace.trigger("hover-link",{event:n,source:"sidebar-highlights",hoverParent:s,targetEl:s,linktext:t.filePath,state:{scroll:t.startOffset}})})}addTagsToQuote(r,t,e){let s=this.extractTagsFromHighlight(t);if(s.length>0){let n=r.createDiv({cls:"highlight-tags"});s.forEach(i=>{n.createEl("span",{cls:"highlight-tag",text:i}).addEventListener("click",l=>{var o;l.stopPropagation(),(o=e.onTagClick)==null||o.call(e,i)})})}}createActionsSection(r,t,e){if(e.showHighlightActions===!1)return;let s=r.createDiv({cls:"highlight-actions"});this.addFileNameInfo(s,t,e);let n=s.createDiv({cls:"highlight-info-container"});this.addStatsInfo(n,t,e),this.addActionButtons(s,t,e)}addFileNameInfo(r,t,e){var s;if(e.showFilename){let n=((s=t.filePath.split("/").pop())==null?void 0:s.replace(/\.md$/,""))||t.filePath,i=r.createEl("small",{cls:"highlight-filename",text:n,attr:{title:t.filePath}});i.addEventListener("click",a=>{var l;a.stopPropagation(),(l=e.onFileNameClick)==null||l.call(e,t.filePath,a)}),i.addEventListener("contextmenu",a=>{a.preventDefault(),a.stopPropagation();let l=this.plugin.app.vault.getAbstractFileByPath(t.filePath);if(l instanceof G.TFile){let o=this.createFileContextMenu(l);this.plugin.app.workspace.trigger("file-menu",o,l,"sidebar-highlights"),o.showAtMouseEvent(a)}}),i.addEventListener("mouseover",a=>{this.plugin.app.workspace.trigger("hover-link",{event:a,source:"sidebar-highlights",hoverParent:i,targetEl:i,linktext:t.filePath})})}}addStatsInfo(r,t,e){var c;let s=t.line>=0?t.line+1:"Unknown",n=r.createDiv({cls:"highlight-info-line"}),i=n.createDiv({cls:"highlight-stats-section"});this.createInfoItem(i,"text",`${s}`,"highlight-line-info");let a=t.isNativeComment?0:((c=t.footnoteContents)==null?void 0:c.filter(h=>h.trim()!=="").length)||0,l=t.isNativeComment?"highlight-line-info highlight-comment-stat disabled":"highlight-line-info highlight-comment-stat clickable",o=this.createInfoItem(i,"message-square",`${a}`,l);if(t.isNativeComment||o.addEventListener("click",h=>{var g;h.stopPropagation(),(g=e.onCommentToggle)==null||g.call(e,t.id)}),this.plugin.settings.showCollectionsTab){let h=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);this.createInfoItem(i,"folder-open",`${h}`,"highlight-line-info highlight-collection-stat clickable").addEventListener("click",u=>{var m;u.stopPropagation(),(m=e.onCollectionsMenu)==null||m.call(e,u,t)})}this.addTimestampToInfoLine(n,t,e)}createInfoItem(r,t,e,s){let n=r.createDiv({cls:s}),i=n.createDiv({cls:t==="message-square"?"comment-icon":"line-icon"});return(0,G.setIcon)(i,t),n.createSpan({text:e}),n}createCopyButtonInQuote(r,t){let e=r.createDiv({cls:"highlight-quote-copy-button"}),n=!t.isNativeComment&&t.footnoteContents&&t.footnoteContents.length>0?"Copy highlight with comments":"Copy highlight";e.setAttribute("title",n);let i=e.createDiv({cls:"copy-icon"});return(0,G.setIcon)(i,"copy"),e.addEventListener("click",async a=>{a.stopPropagation();let l="";t.isNativeComment?l=`%%${t.text}%%`:t.type==="html"?l=`==${t.text}==`:l=`==${t.text}==`,!t.isNativeComment&&t.footnoteContents&&t.footnoteContents.length>0&&t.footnoteContents.forEach(o=>{l+=`^[${o}]`});try{await navigator.clipboard.writeText(l),new G.Notice("Copied to clipboard")}catch(o){let c=document.createElement("textarea");c.value=l,c.style.position="fixed",c.style.left="-999999px",document.body.appendChild(c),c.select();try{document.execCommand("copy"),new G.Notice("Copied to clipboard")}catch(h){new G.Notice("Failed to copy to clipboard")}document.body.removeChild(c)}}),e}addTimestampToInfoLine(r,t,e){if(e.showTimestamp&&t.createdAt){let s=(0,G.moment)(t.createdAt),n=e.dateFormat?s.format(e.dateFormat):s.format("YYYY-MM-DD HH:mm"),a=r.createDiv({cls:"highlight-timestamp-container"}).createDiv({cls:"highlight-timestamp-info",text:n,attr:{title:`Created: ${n}`}})}}addActionButtons(r,t,e){let s=r.createDiv({cls:"comment-buttons"})}createCommentsSection(r,t,e){var n;if(!e.isCommentsVisible)return;let s=r.createDiv({cls:"highlight-comments"});if(!t.isNativeComment){let i=((n=t.footnoteContents)==null?void 0:n.filter(a=>a.trim()!==""))||[];i.length>0&&i.forEach((a,l)=>{let o=s.createDiv({cls:"highlight-comment"});this.renderMarkdownToElement(o,a),o.addEventListener("click",c=>{var h;c.stopPropagation(),(h=e.onCommentClick)==null||h.call(e,t,l,c)})})}this.createAddCommentLine(s,t,e)}createAddCommentLine(r,t,e){let s=r.createDiv({cls:"highlight-add-comment-line"}),n=s.createDiv({cls:"highlight-add-comment-icon"});(0,G.setIcon)(n,"plus"),s.createSpan({text:"Add comment"}),s.addEventListener("click",i=>{var a;i.stopPropagation(),(a=e.onAddComment)==null||a.call(e,t)})}highlightSearchMatches(r,t){if(!t)return;let e=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(e,"gi"),n=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,null),i,a=[];for(;i=n.nextNode();)i.nodeValue&&i.nodeValue.trim()!==""&&!(i.parentElement&&i.parentElement.classList.contains("search-term-highlight"))&&a.push(i);a.forEach(l=>{let o=l.nodeValue,c=[],h=0,g;for(;(g=s.exec(o))!==null;){g.index>h&&c.push(document.createTextNode(o.substring(h,g.index)));let u=document.createElement("span");u.className="search-term-highlight",u.textContent=g[0],c.push(u),h=s.lastIndex}h<o.length&&c.push(document.createTextNode(o.substring(h))),c.length>0&&l.parentNode&&(c.forEach(u=>l.parentNode.insertBefore(u,l)),l.parentNode.removeChild(l))})}renderMarkdownToElement(r,t){r.empty();let e=this.parseMarkdownSegments(t);for(let s of e)if(s.type==="text")r.appendText(s.content||"");else if(s.type==="strong"){let n=r.createEl("strong");n.textContent=s.content||""}else if(s.type==="em"){let n=r.createEl("em");n.textContent=s.content||""}else if(s.type==="strong-em"){let i=r.createEl("strong").createEl("em");i.textContent=s.content||""}else if(s.type==="code"){let n=r.createEl("code");n.textContent=s.content||""}else if(s.type==="del"){let n=r.createEl("del");n.textContent=s.content||""}else if(s.type==="link"){let n=r.createEl("a");n.textContent=s.text||"",n.href=s.url||"",n.target="_blank"}else if(s.type==="wikilink"){let n=r.createEl("a");n.textContent=s.text||"",n.addClass("internal-link");let i=s.url||"";i.startsWith("http://")||i.startsWith("https://")?(n.href=i,n.target="_blank",n.addClass("external-link")):(n.setAttribute("data-href",i),n.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.plugin.app.workspace.openLinkText(i,"",a.ctrlKey||a.metaKey)}))}}parseMarkdownSegments(r){let t=[],e=new Map,s=0;r=r.replace(/\\([*_~`\[\]\\])/g,(o,c)=>{let h=`\0ESC${s}\0`;return e.set(h,c),s++,h});let n=[{regex:/\*\*\*(.*?)\*\*\*/g,type:"strong-em"},{regex:/___(.*?)___/g,type:"strong-em"},{regex:/\*\*(.*?)\*\*/g,type:"strong"},{regex:/__(.*?)__/g,type:"strong"},{regex:/~~(.*?)~~/g,type:"del"},{regex:/`([^`]+?)`/g,type:"code"},{regex:/\[\[([^\]]+?)\]\]/g,type:"wikilink"},{regex:/\[([^\]]+)\]\(([^)]+)\)/g,type:"link"}],i=[];for(let o of n){let c;for(o.regex.lastIndex=0;(c=o.regex.exec(r))!==null;)if(o.type==="link")i.push({start:c.index,end:c.index+c[0].length,type:o.type,text:c[1],url:c[2]});else if(o.type==="wikilink"){let g=c[1].split("|"),u=g[0],m=g[1]||g[0];i.push({start:c.index,end:c.index+c[0].length,type:o.type,text:m,url:u})}else{if(o.type==="strong"&&c[0].startsWith("__")||o.type==="strong-em"&&c[0].startsWith("___")){let h=c.index>0?r[c.index-1]:" ",g=c.index+c[0].length<r.length?r[c.index+c[0].length]:" ",u=/[a-zA-Z0-9]/.test(h),m=/[a-zA-Z0-9]/.test(g);if(u&&m)continue}i.push({start:c.index,end:c.index+c[0].length,type:o.type,content:c[1]})}}this.findItalicMatches(r,i),i.sort((o,c)=>o.start-c.start);let a=[];for(let o of i)a.some(c=>o.start>=c.start&&o.start<c.end||o.end>c.start&&o.end<=c.end)||a.push(o);let l=0;for(let o of a)l<o.start&&t.push({type:"text",content:r.substring(l,o.start)}),t.push(o),l=o.end;l<r.length&&t.push({type:"text",content:r.substring(l)});for(let o of t){if(o.content)for(let[c,h]of e)o.content=o.content.replace(new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),h);if(o.text)for(let[c,h]of e)o.text=o.text.replace(new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),h)}return t}findItalicMatches(r,t){for(let e=0;e<r.length;e++)if(r[e]==="*"&&(e===0||r[e-1]!=="*")&&(e===r.length-1||r[e+1]!=="*")){for(let s=e+1;s<r.length;s++)if(r[s]==="*"&&(s===r.length-1||r[s+1]!=="*")&&(s===0||r[s-1]!=="*")){let n=r.substring(e+1,s);if(n.length>0&&n.indexOf("*")===-1){t.push({start:e,end:s+1,type:"em",content:n}),e=s;break}}}for(let e=0;e<r.length;e++)if(r[e]==="_"&&(e===0||r[e-1]!=="_")&&(e===r.length-1||r[e+1]!=="_")){let s=e>0?r[e-1]:" ",n=e<r.length-1?r[e+1]:" ",i=/[a-zA-Z0-9]/.test(s),a=/[a-zA-Z0-9]/.test(n);if(i&&a)continue;for(let l=e+1;l<r.length;l++)if(r[l]==="_"&&(l===r.length-1||r[l+1]!=="_")&&(l===0||r[l-1]!=="_")){let o=l>0?r[l-1]:" ",c=l<r.length-1?r[l+1]:" ",h=/[a-zA-Z0-9]/.test(o),g=/[a-zA-Z0-9]/.test(c);if(h&&g)continue;let u=r.substring(e+1,l);if(u.length>0&&u.indexOf("_")===-1){t.push({start:e,end:l+1,type:"em",content:u}),e=l;break}}}}extractTagsFromHighlight(r){let t=[];if(r.footnoteContents){for(let e of r.footnoteContents)if(e.trim()!==""){let s=e.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);s&&s.forEach(n=>{let i=n.substring(1);t.includes(i)||t.push(i)})}}return t}isColorChangeable(r){return!this.isHtmlHighlight(r)}isHtmlHighlight(r){return r.type==="html"}createHoverColorPicker(r,t,e){if(!this.isColorChangeable(t))return;let s=r.createDiv({cls:"highlight-border-hover-zone"}),n=r.createDiv({cls:"hover-color-picker"}),i=n.createDiv({cls:"hover-color-options"}),a=[{name:"yellow",value:this.plugin.settings.customColors.yellow},{name:"red",value:this.plugin.settings.customColors.red},{name:"teal",value:this.plugin.settings.customColors.teal},{name:"blue",value:this.plugin.settings.customColors.blue},{name:"green",value:this.plugin.settings.customColors.green}];t.isNativeComment&&a.push({name:"default",value:""}),a.forEach((h,g)=>{i.createDiv({cls:`hover-color-option${h.name==="default"?" hover-color-option-default":""}`,attr:{"data-color":h.value,"data-color-name":h.name,style:h.name==="default"?`background-color: var(--text-faint); --option-index: ${g}`:`background-color: ${h.value}; --option-index: ${g}`}}).addEventListener("click",m=>{var p;m.stopPropagation(),(p=e.onColorChange)==null||p.call(e,t,h.value)})});let l,o=()=>{l=window.setTimeout(()=>{n.classList.add("sh-visible")},500)},c=()=>{window.clearTimeout(l),n.classList.remove("sh-visible")};s.addEventListener("mouseenter",o),s.addEventListener("mouseleave",c),n.addEventListener("mouseenter",()=>{window.clearTimeout(l),n.classList.add("sh-visible")}),n.addEventListener("mouseleave",c)}createEmptyState(r,t){let e=r.createDiv({cls:"highlight-empty-state"}),s=e.createDiv({cls:"highlight-empty-icon"});(0,G.setIcon)(s,"highlighter");let n=e.createEl("p",{cls:"highlight-empty-text",text:t});return e}};var q=require("obsidian"),dt=class{constructor(r){this.plugin=r}createTaskItem(r,t,e={}){let s=r.createDiv({cls:`task-item-card${t.completed?" task-completed":""}${e.hideFilename!==void 0?" task-grouped":""}`,attr:{"data-task-id":t.id}});return this.createQuoteSection(s,t,e),e.hideFilename===void 0&&this.createActionsSection(s,t,e),s}createQuoteSection(r,t,e){var g;let s=r.createDiv({cls:"task-quote"});t.indentLevel>0&&!e.parentTask&&(s.style.paddingLeft=`${8+t.indentLevel*28}px`);let i=s.createDiv({cls:"task-checkbox-container"}).createDiv({cls:"task-checkbox"});t.indentLevel>0&&!e.parentTask?(0,q.setIcon)(i,t.completed?"circle-check":"circle"):(0,q.setIcon)(i,t.completed?"square-check":"square"),t.priority&&i.classList.add(`task-checkbox-priority-${t.priority}`),i.addEventListener("click",u=>{var m;u.stopPropagation(),(m=e.onTaskToggle)==null||m.call(e,t,i)});let a=s.createDiv({cls:"task-text-content"});if(t.date&&!e.hideDateBadge){let u=a.createSpan({cls:"task-date-badge"}),m=(0,q.moment)(t.date,"YYYY-MM-DD").format("MM-DD");u.textContent=m}let l=t.text;t.dateText&&(l=t.text.replace(t.dateText,"").trim());let o=a.createDiv();if(this.renderTaskTextWithTags(o,l,e.searchTerm),t.context.length>0){let u=a.createDiv({cls:"task-context"});t.context.forEach(m=>{let p=u.createDiv({cls:"task-context-line"}),y=m.trim().replace(/^-\s*/,"");this.renderTaskTextWithTags(p,y,e.searchTerm)})}if(!e.hideFilename&&(t.indentLevel===0||e.parentTask)){let u=((g=t.filePath.split("/").pop())==null?void 0:g.replace(/\.md$/,""))||t.filePath,m=a.createDiv({cls:"task-filename-inline"}),p=m.createSpan({cls:"task-filename-icon"});(0,q.setIcon)(p,"file-text");let y=m.createSpan({cls:"task-filename-text",text:u,attr:{title:t.filePath}});if(e.parentTask){m.createSpan({cls:"task-parent-separator",text:" \u203A "});let v=m.createSpan({cls:"task-parent-icon"});(0,q.setIcon)(v,"git-branch");let S=e.parentTask.text;e.parentTask.dateText&&(S=S.replace(e.parentTask.dateText,"").trim()),S=S.replace(/#[a-zA-Z0-9_/-]+/g,"").trim(),m.createSpan({cls:"task-parent-text",text:S,attr:{title:`Parent task: ${S}`}})}m.addEventListener("click",v=>{var S;v.stopPropagation(),(S=e.onFileNameClick)==null||S.call(e,t.filePath,v)})}let c=s.createDiv({cls:"task-flag-button"});(0,q.setIcon)(c,"flag"),c.addEventListener("click",u=>{var m;u.stopPropagation(),(m=e.onFlagToggle)==null||m.call(e,t,u)});let h=s.createDiv({cls:"task-calendar-button"});t.date?(0,q.setIcon)(h,"calendar-cog"):(0,q.setIcon)(h,"calendar"),h.addEventListener("click",u=>{var m;u.stopPropagation(),(m=e.onCalendarToggle)==null||m.call(e,t)}),s.addEventListener("click",u=>{var m;u.target.classList.contains("task-checkbox")||u.target.classList.contains("task-flag-button")||u.target.classList.contains("task-calendar-button")||(m=e.onTaskClick)==null||m.call(e,t,u)})}createActionsSection(r,t,e){var c;let s=r.createDiv({cls:"task-actions"}),n=((c=t.filePath.split("/").pop())==null?void 0:c.replace(/\.md$/,""))||t.filePath;s.createEl("small",{cls:"task-filename",text:n,attr:{title:t.filePath}}).addEventListener("click",h=>{var g;h.stopPropagation(),(g=e.onFileNameClick)==null||g.call(e,t.filePath,h)});let o=s.createDiv({cls:"task-info-container"}).createDiv({cls:"task-info-line"}).createDiv({cls:"task-stats-section"})}renderTaskTextWithTags(r,t,e){r.empty();let s=this.parseMarkdownSegments(t);for(let n of s)if(n.type==="text")this.renderTextWithTags(r,n.content||"",e);else if(n.type==="strong"){let i=r.createEl("strong");this.renderTextWithTags(i,n.content||"",e)}else if(n.type==="em"){let i=r.createEl("em");this.renderTextWithTags(i,n.content||"",e)}else if(n.type==="strong-em"){let a=r.createEl("strong").createEl("em");this.renderTextWithTags(a,n.content||"",e)}else if(n.type==="code"){let i=r.createEl("code");i.textContent=n.content||""}else if(n.type==="del"){let i=r.createEl("del");this.renderTextWithTags(i,n.content||"",e)}else if(n.type==="highlight"){let i=r.createEl("span",{cls:"cm-highlight"});this.renderTextWithTags(i,n.content||"",e)}else if(n.type==="link"){let i=r.createEl("a");i.textContent=n.text||"",i.href=n.url||"",i.target="_blank"}else if(n.type==="wikilink"){let i=r.createEl("a");i.textContent=n.text||"",i.addClass("internal-link");let a=n.url||"";a.startsWith("http://")||a.startsWith("https://")?(i.href=a,i.target="_blank",i.addClass("external-link")):(i.setAttribute("data-href",a),i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.plugin.app.workspace.openLinkText(a,"",l.ctrlKey||l.metaKey)}))}}renderTextWithTags(r,t,e){let s=/#([a-zA-Z0-9_/-]+)/g,n=0,i,a=!1;for(;(i=s.exec(t))!==null;){if(a=!0,i.index>n){let u=t.substring(n,i.index);this.appendTextWithHighlight(r,u,e)}let l=i[1],o=`#${l}`,c=e&&o.toLowerCase().includes(e.toLowerCase()),h=r.createSpan({cls:`cm-hashtag cm-hashtag-begin cm-meta${c?" task-search-match-tag":""}`,text:"#"}),g=r.createSpan({cls:`cm-hashtag cm-hashtag-end${c?" task-search-match-tag":""}`,text:l,attr:{"data-tag":l}});n=i.index+i[0].length}if(a&&n<t.length){let l=t.substring(n);this.appendTextWithHighlight(r,l,e)}a||this.appendTextWithHighlight(r,t,e)}parseMarkdownSegments(r){let t=[],e=new Map,s=0;r=r.replace(/\\([*_~`\[\]\\])/g,(o,c)=>{let h=`\0ESC${s}\0`;return e.set(h,c),s++,h});let n=[{regex:/\*\*\*(.*?)\*\*\*/g,type:"strong-em"},{regex:/___(.*?)___/g,type:"strong-em"},{regex:/\*\*(.*?)\*\*/g,type:"strong"},{regex:/__(.*?)__/g,type:"strong"},{regex:/~~(.*?)~~/g,type:"del"},{regex:/==(.*?)==/g,type:"highlight"},{regex:/`([^`]+?)`/g,type:"code"},{regex:/\[\[([^\]]+?)\]\]/g,type:"wikilink"},{regex:/\[([^\]]+)\]\(([^)]+)\)/g,type:"link"}],i=[];for(let o of n){let c;for(o.regex.lastIndex=0;(c=o.regex.exec(r))!==null;)if(o.type==="link")i.push({start:c.index,end:c.index+c[0].length,type:o.type,text:c[1],url:c[2]});else if(o.type==="wikilink"){let g=c[1].split("|"),u=g[0].trim(),m=g.length>1?g[1].trim():u;i.push({start:c.index,end:c.index+c[0].length,type:o.type,text:m,url:u})}else i.push({start:c.index,end:c.index+c[0].length,type:o.type,content:c[1]})}this.findItalicMatches(r,i),i.sort((o,c)=>o.start-c.start);let a=[];for(let o of i)(a.length===0||o.start>=a[a.length-1].end)&&a.push(o);let l=0;for(let o of a){if(o.start>l){let h=r.substring(l,o.start);h=h.replace(/\u0000ESC(\d+)\u0000/g,(g,u)=>{let m=`\0ESC${u}\0`;return e.get(m)||m}),t.push({type:"text",content:h})}let c=o.content;c&&(c=c.replace(/\u0000ESC(\d+)\u0000/g,(h,g)=>{let u=`\0ESC${g}\0`;return e.get(u)||u})),t.push({type:o.type,content:c,text:o.text,url:o.url}),l=o.end}if(l<r.length){let o=r.substring(l);o=o.replace(/\u0000ESC(\d+)\u0000/g,(c,h)=>{let g=`\0ESC${h}\0`;return e.get(g)||g}),t.push({type:"text",content:o})}return t}findItalicMatches(r,t){for(let e=0;e<r.length;e++)if(r[e]==="*"&&(e===0||r[e-1]!=="*")&&(e===r.length-1||r[e+1]!=="*")){for(let s=e+1;s<r.length;s++)if(r[s]==="*"&&(s===r.length-1||r[s+1]!=="*")&&(s===0||r[s-1]!=="*")){let n=r.substring(e+1,s);if(n.length>0&&!n.includes(`
`)){t.push({start:e,end:s+1,type:"em",content:n}),e=s;break}}}for(let e=0;e<r.length;e++)if(r[e]==="_"&&(e===0||r[e-1]!=="_")&&(e===r.length-1||r[e+1]!=="_")){let s=e>0?r[e-1]:" ",n=e<r.length-1?r[e+1]:" ",i=a=>/[a-zA-Z0-9]/.test(a);if(i(s)&&i(n))continue;for(let a=e+1;a<r.length;a++)if(r[a]==="_"&&(a===r.length-1||r[a+1]!=="_")&&(a===0||r[a-1]!=="_")){let l=a>0?r[a-1]:" ",o=a<r.length-1?r[a+1]:" ";if(i(l)&&i(o))continue;let c=r.substring(e+1,a);if(c.length>0&&!c.includes(`
`)){t.push({start:e,end:a+1,type:"em",content:c}),e=a;break}}}}appendTextWithHighlight(r,t,e){if(!e||e.length===0){r.appendText(t);return}let s=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),n=0,i;for(;(i=s.exec(t))!==null;){i.index>n&&r.appendText(t.substring(n,i.index));let a=r.createEl("mark",{cls:"task-search-match",text:i[0]});n=i.index+i[0].length}n<t.length&&r.appendText(t.substring(n)),n===0&&r.appendText(t)}createEmptyState(r,t="No tasks found"){let e=r.createDiv({cls:"task-empty-state"}),s=e.createDiv({cls:"task-empty-icon"});(0,q.setIcon)(s,"check-square");let n=e.createEl("p",{cls:"task-empty-text",text:t});return e}};var et=require("obsidian"),gt=class{constructor(r){this.plugin=r,this.app=r.app,this.vault=r.app.vault}shouldProcessFile(r){return!(r.extension!=="md"||this.plugin.settings.excludeExcalidraw&&r.name.endsWith(".excalidraw.md")||this.isFileExcluded(r.path))}isFileExcluded(r){let t=this.plugin.settings.fileFilters;if(!t||t.length===0)return!1;let e=r.replace(/\\/g,"/"),s=!1,n=!1,i=!1;for(let a of t){let l=a.path.replace(/\\/g,"/");(e===l||e.startsWith(l+"/"))&&(a.mode==="include"?n=!0:i=!0),a.mode==="include"&&(s=!0)}return n?!1:!!(s&&!n||i)}parseDateFromText(r){let t=this.plugin.settings.taskDateFormat||"YYYY-MM-DD",e=t.split(/[-/\s.]/),s=t.match(/[^YMDymd]/),n=s?s[0]:"-",i=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),a=t.replace(/YYYY/g,"(\\d{4})").replace(/YY/g,"(\\d{2})").replace(/MM/g,"(\\d{1,2})").replace(/DD/g,"(\\d{1,2})").replace(/M/g,"(\\d{1,2})").replace(/D/g,"(\\d{1,2})");a=a.replace(new RegExp(n,"g"),i);let l=new RegExp(a),o=r.match(l);if(o){let c=o[0],h=(0,et.moment)(c,t,!0);if(h.isValid())return{date:h.format("YYYY-MM-DD"),dateText:c}}}async scanAllTasks(r=!0,t=!0){let e=[],n=this.vault.getMarkdownFiles().filter(i=>this.shouldProcessFile(i));for(let i of n){let a=await this.scanFileForTasks(i,r,t);e.push(...a)}return e}async scanFileForTasks(r,t=!0,e=!0){var h;let s=[],i=(await this.vault.read(r)).split(`
`),a=/^(?:>+ ?)?(\s*)- \[([ xX!]|!?[123])\] (.+)$/,l=/^(#{1,6})\s+(.+)$/,o,c;for(let g=0;g<i.length;g++){let u=i[g],m=u.match(l);if(m){o=m[2].trim(),c=void 0;continue}let p=u.match(a);if(p){let[,y,v,S]=p,k=v.toLowerCase()==="x",I=v.startsWith("!"),H;v==="!1"?H=1:v==="!2"?H=2:v==="!3"&&(H=3);let T=y.replace(/\t/g,"    ").length,E=Math.floor(T/4);if(E>0&&!c&&(E=0),k&&!t)continue;let x=[];if(e)for(let D=g+1;D<i.length;D++){let N=i[D];if(N.match(a))break;if(N.trim()==="")continue;if((((h=N.match(/^(\s*)/))==null?void 0:h[1].replace(/\t/g,"    ").length)||0)>T)x.push(N);else break}let M=this.parseDateFromText(S),F={id:`${r.path}:${g}:${S}`,text:S,completed:k,flagged:I,priority:H,filePath:r.path,lineNumber:g,context:x,indentLevel:E,section:o,date:M==null?void 0:M.date,dateText:M==null?void 0:M.dateText};s.push(F),(E===0||c&&E<=c.indentLevel)&&(c=F)}else u.trim()!==""&&!u.match(/^[\s]/)&&(c=void 0)}return s}async toggleTaskCompletion(r){let t=this.vault.getAbstractFileByPath(r.filePath);if(!(t instanceof et.TFile))throw new Error(`File not found: ${r.filePath}`);let s=(await this.vault.read(t)).split(`
`),n=s[r.lineNumber];if(!n)throw new Error(`Line ${r.lineNumber} not found in ${r.filePath}`);let i=/^(>+ ?)?(\s*)- \[([ xX!]|!?[123])\] (.+)$/,a=n.match(i);if(!a)throw new Error(`No checkbox found at line ${r.lineNumber} in ${r.filePath}`);let[,l,o,c,h]=a,g=c.toLowerCase()==="x"?" ":"x",u=`${l||""}${o}- [${g}] ${h}`;s[r.lineNumber]=u;let m=s.join(`
`);return await this.vault.modify(t,m),{...r,completed:g==="x",flagged:!1}}async toggleTaskFlag(r){let t=this.vault.getAbstractFileByPath(r.filePath);if(!(t instanceof et.TFile))throw new Error(`File not found: ${r.filePath}`);let s=(await this.vault.read(t)).split(`
`),n=s[r.lineNumber];if(!n)throw new Error(`Line ${r.lineNumber} not found in ${r.filePath}`);let i=/^(>+ ?)?(\s*)- \[([ xX!]|!?[123])\] (.+)$/,a=n.match(i);if(!a)throw new Error(`No checkbox found at line ${r.lineNumber} in ${r.filePath}`);let[,l,o,c,h]=a,g;c==="!"?g=" ":g="!";let u=`${l||""}${o}- [${g}] ${h}`;s[r.lineNumber]=u;let m=s.join(`
`);return await this.vault.modify(t,m),{...r,flagged:g==="!"}}async setTaskPriority(r,t){let e=this.vault.getAbstractFileByPath(r.filePath);if(!(e instanceof et.TFile))throw new Error(`File not found: ${r.filePath}`);let n=(await this.vault.read(e)).split(`
`),i=n[r.lineNumber];if(!i)throw new Error(`Line ${r.lineNumber} not found in ${r.filePath}`);let a=/^(>+ ?)?(\s*)- \[([ xX!]|!?[123])\] (.+)$/,l=i.match(a);if(!l)throw new Error(`No checkbox found at line ${r.lineNumber} in ${r.filePath}`);let[,o,c,h,g]=l,u;t===null?h.toLowerCase()==="x"?u="x":u=" ":u=`!${t}`;let m=`${o||""}${c}- [${u}] ${g}`;n[r.lineNumber]=m;let p=n.join(`
`);return await this.vault.modify(e,p),{...r,priority:t!=null?t:void 0,flagged:u.startsWith("!")}}async updateTaskDate(r,t){let e=this.vault.getAbstractFileByPath(r.filePath);if(!(e instanceof et.TFile))throw new Error(`File not found: ${r.filePath}`);let n=(await this.vault.read(e)).split(`
`),i=n[r.lineNumber];if(!i)throw new Error(`Line ${r.lineNumber} not found in ${r.filePath}`);let a=/^(>+ ?)?(\s*)- \[([ xX!]|!?[123])\] (.+)$/,l=i.match(a);if(!l)throw new Error(`No checkbox found at line ${r.lineNumber} in ${r.filePath}`);let[,o,c,h,g]=l,u=g,m=this.parseDateFromText(g);m&&m.dateText&&(u=g.replace(m.dateText,"").trim());let p=u,y;t&&(p=`${t} ${u}`,y=this.parseDateFromText(p));let v=`${o||""}${c}- [${h}] ${p}`;n[r.lineNumber]=v;let S=n.join(`
`);return await this.vault.modify(e,S),{...r,text:p,date:y==null?void 0:y.date,dateText:y==null?void 0:y.dateText}}};var j=class{static parseHighlights(r,t=[]){let e=[],s=/<(span|font|mark)[^>]*>.*?<\/\1>/gis,n;for(;(n=s.exec(r))!==null;){let i=n.index,a=n.index+n[0].length,l=n[0];if(this.isInsideCodeBlock(i,a,t))continue;let o=this.parseHtmlTag(l,i);o&&e.push(o)}return e}static parseHtmlTag(r,t){try{let n=new DOMParser().parseFromString(r,"text/html").body.firstChild;if(!n)return null;let i=n.tagName.toLowerCase(),a=n.textContent||"";if(!a||a.trim()==="")return null;let l=null,o=null;if(i==="span"){let c=n.getAttribute("style"),h=n.getAttribute("class");if(c&&/background\s*:/i.test(c)){let g=c.match(/background\s*:\s*([^;]+)/i);g&&(l=this.parseHtmlColor(g[1]),o="span-background")}else h&&(l=this.getCssClassColor(h),o="span-class")}else if(i==="font"){let c=n.getAttribute("color");c&&(l=this.parseHtmlColor(c),o="font-color")}else i==="mark"&&(l="#ffff00",o="mark");return!l||!o?null:{text:a,color:l,startOffset:t,endOffset:t+r.length,tagType:o,fullMatch:r}}catch(e){return console.warn("Failed to parse HTML tag:",r,e),null}}static findHighlightAtOffset(r,t,e,s=[]){let i=this.parseHighlights(r,s).filter(o=>o.text===t);if(i.length===0)return null;let a=i[0],l=Math.abs(a.startOffset-e);for(let o of i){let c=Math.abs(o.startOffset-e);c<l&&(l=c,a=o)}return a}static isInsideCodeBlock(r,t,e){return e.some(s=>r>=s.start&&t<=s.end)}static parseHtmlColor(r){let t=r.trim().toLowerCase(),e={yellow:"#ffff00",red:"#ff0000",green:"#008000",blue:"#0000ff",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",cyan:"#00ffff",magenta:"#ff00ff",lime:"#00ff00",brown:"#a52a2a",gray:"#808080",grey:"#808080",black:"#000000",white:"#ffffff"};if(e[t])return e[t];if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t.length===4?"#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]:t;let s=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(s){let n=parseInt(s[1]),i=parseInt(s[2]),a=parseInt(s[3]);return"#"+n.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+a.toString(16).padStart(2,"0")}return null}static getCssClassColor(r){try{let t=document.createElement("span");t.className=r,t.style.visibility="hidden",t.style.position="absolute",document.body.appendChild(t);let s=window.getComputedStyle(t).backgroundColor;return document.body.removeChild(t),s&&s!=="rgba(0, 0, 0, 0)"&&s!=="transparent"?this.parseHtmlColor(s):null}catch(t){return null}}};var Z=class{static calculateFootnoteLength(r,t=0){let e=r.substring(t),s=0,n=0;for(;s<e.length;){let i=e.substring(s).match(/^(\s+)/);if(i&&(s+=i[0].length,s>=e.length))return n;let a=e.substring(s).match(/^\[\^[a-zA-Z0-9_-]+\]/);if(a){s+=a[0].length,n=s;continue}if(e.substring(s,s+2)==="^["){s+=2;let l=1;for(;s<e.length&&l>0;)e[s]==="["?l++:e[s]==="]"&&l--,s++;if(l!==0)break;n=s;continue}break}return n}isHtmlHighlight(r){return!r.isNativeComment&&!!r.color}extractInlineFootnotes(r,t){let e=[],s=r.substring(t),n=0;for(;n<s.length;){let i=s.substring(n).match(/^(\s*)/);if(i&&(n+=i[0].length),n>0&&!this.isValidFootnotePosition(s,n))break;let a=s.substring(n).match(/^\[\^[a-zA-Z0-9_-]+\]/);if(a){n+=a[0].length;continue}if(s.substring(n,n+2)==="^["){let l=n;n+=2;let o=1,c=n;for(;n<s.length&&o>0;)s[n]==="["?o++:s[n]==="]"&&o--,o>0&&n++;if(o===0){let h=s.substring(c,n);e.push({content:h,startIndex:t+l,endIndex:t+n+1}),n++}else break}else break}return e}isValidFootnotePosition(r,t){let e=r.substring(0,t),s=0;for(;s<e.length;){let n=e.substring(s).match(/^(\s+)/);if(n){s+=n[0].length;continue}let i=e.substring(s).match(/^\[\^[a-zA-Z0-9_-]+\]/);if(i){s+=i[0].length;continue}if(e.substring(s,s+2)==="^["){s+=2;let a=1;for(;s<e.length&&a>0;)e[s]==="["?a++:e[s]==="]"&&a--,s++;if(a!==0)return!1;continue}return!1}return!0}insertInlineFootnote(r,t,e){let s=r.getValue(),n=this.escapeRegex(t.text),i=null,a=1/0;if(t.type==="custom"&&t.fullMatch){let p=this.escapeRegex(t.fullMatch),y=new RegExp(p,"g"),v;for(;(v=y.exec(s))!==null;){let S=Math.abs(v.index-t.startOffset);S<a&&(a=S,i={index:v.index,length:v[0].length})}}else if(t.isNativeComment){let p=`<!--\\s*${n}\\s*-->`,y=new RegExp(p,"g"),v;for(;(v=y.exec(s))!==null;){let S=Math.abs(v.index-t.startOffset);S<a&&(a=S,i={index:v.index,length:v[0].length})}if(!i){let S=`%%${n}%%`,k=new RegExp(S,"g");for(;(v=k.exec(s))!==null;){let I=Math.abs(v.index-t.startOffset);I<a&&(a=I,i={index:v.index,length:v[0].length})}}}else if(this.isHtmlHighlight(t)){let p=j.findHighlightAtOffset(s,t.text,t.startOffset,[]);p&&(i={index:p.startOffset,length:p.endOffset-p.startOffset},a=0)}else{let p=`==${n}==`,y=new RegExp(p,"g"),v;for(;(v=y.exec(s))!==null;){let S=Math.abs(v.index-t.startOffset);S<a&&(a=S,i={index:v.index,length:v[0].length})}}if(!i)return{success:!1,contentLength:e.length};let l=i.index+i.length,c=s.substring(l).match(/^[^\r\n]*/),h=c?c[0]:"",g=Z.calculateFootnoteLength(h);if(g>0){let p=h.substring(g),y=p.match(/^[ \t]+/);y&&p.substring(y[0].length).length===0&&(g+=y[0].length)}l+=g;let u=`^[${e}]`,m=r.offsetToPos(l);return r.replaceRange(u,m),{success:!0,insertPos:{line:m.line,ch:m.ch},contentLength:e.length}}escapeRegex(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var K=class{static parseQuery(r){if(!r.trim())return{ast:null};try{return this.tokens=this.tokenize(r),this.position=0,this.depth=0,{ast:this.parseExpression()}}catch(t){return console.warn("Search parsing error:",t),{ast:null}}}static tokenize(r){let t=[],e=0,s=0,n=r.length*2;for(;e<r.length&&s<n;){if(s++,/\s/.test(r[e])){e++;continue}if(r[e]==="("){t.push({type:"LPAREN",value:"("}),e++;continue}if(r[e]===")"){t.push({type:"RPAREN",value:")"}),e++;continue}if(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))){t.push({type:"AND",value:"AND"}),e+=3;continue}if(r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))){t.push({type:"OR",value:"OR"}),e+=2;continue}if(r[e]==='"'){e++;let o=e;for(;e<r.length&&r[e]!=='"';)e++;if(e<r.length){let c=r.substring(o,e);c.trim()&&t.push({type:"TEXT",value:c}),e++}else{let c=r.substring(o-1);t.push({type:"TEXT",value:c}),e=r.length}continue}let i=r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_/-]+)/);if(i){let o=i[1]==="-",c=i[2],h=i[3];t.push({type:"FILTER",value:h,filterType:c==="#"?"tag":"collection",exclude:o}),e+=i[0].length;continue}let a=e,l="";for(;e<r.length&&!(r.substr(e,3)==="AND"&&(e+3>=r.length||/\s/.test(r[e+3]))||r.substr(e,2)==="OR"&&(e+2>=r.length||/\s/.test(r[e+2]))||r[e]==="("||r[e]===")"||r[e]==='"'||r.substr(e).match(/^(-?)([#@])([a-zA-Z0-9_-]+)/));)l+=r[e],e++;l=l.trim(),l?t.push({type:"TEXT",value:l}):e===a&&e++}return t}static parseExpression(){var e;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parseAndExpression(),t=0;for(;((e=this.current())==null?void 0:e.type)==="OR"&&t<100;){this.advance();let s=this.parseAndExpression();if(!s)break;r={type:"operator",operator:"OR",left:r,right:s},t++}return this.depth--,r}static parseAndExpression(){var e,s;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.parsePrimary(),t=0;for(;(((e=this.current())==null?void 0:e.type)==="AND"||this.isImplicitAnd())&&t<100;){((s=this.current())==null?void 0:s.type)==="AND"&&this.advance();let n=this.parsePrimary();if(!n)break;r={type:"operator",operator:"AND",left:r,right:n},t++}return this.depth--,r}static parsePrimary(){var t;if(++this.depth>this.MAX_DEPTH)throw new Error("Maximum parsing depth exceeded");let r=this.current();if(!r)return this.depth--,null;if(r.type==="LPAREN"){this.advance();let e=this.parseExpression();return((t=this.current())==null?void 0:t.type)==="RPAREN"&&this.advance(),this.depth--,e}if(r.type==="FILTER"){this.advance();let e={type:"filter",filterType:r.filterType,value:r.value,exclude:r.exclude||!1};return this.depth--,e}if(r.type==="TEXT"){this.advance();let e={type:"text",value:r.value};return this.depth--,e}return this.depth--,null}static current(){return this.tokens[this.position]}static advance(){this.position++}static isImplicitAnd(){let r=this.current();return!!r&&(r.type==="FILTER"||r.type==="TEXT"||r.type==="LPAREN")}static getTokensFromQuery(r){let t=[],e=this.parseQuery(r);return e.ast&&this.extractTokensFromAST(e.ast,t),t}static extractTokensFromAST(r,t){if(r.type==="filter"){let e=r;t.push({type:e.filterType,value:e.value,exclude:e.exclude})}else if(r.type==="text"){let e=r;t.push({type:"text",value:e.value,exclude:!1})}else if(r.type==="operator"){let e=r;this.extractTokensFromAST(e.left,t),this.extractTokensFromAST(e.right,t)}}};K.tokens=[],K.position=0,K.depth=0,K.MAX_DEPTH=50;var ut=class{constructor(r,t,e,s){this.currentSuggestions=[];this.selectedIndex=-1;this.input=r,this.container=t,this.onSearchChange=e,this.suggestions=s,this.createDropdown(),this.createPreview(),this.setupEventListeners()}createDropdown(){this.dropdown=this.container.createDiv({cls:"simple-search-dropdown"}),this.dropdown.classList.add("sh-hidden")}createPreview(){this.previewElement=this.container.createDiv({cls:"simple-search-preview"}),this.previewElement.classList.add("sh-hidden")}setupEventListeners(){this.input.addEventListener("input",()=>{this.handleInput()}),this.input.addEventListener("keydown",r=>{this.handleKeydown(r)}),this.input.addEventListener("focus",()=>{this.updateAutocomplete()}),this.input.addEventListener("blur",()=>{window.setTimeout(()=>this.hideDropdown(),150)})}handleInput(){let r=this.input.value,t=K.parseQuery(r);this.updatePreview(t),this.updateAutocomplete(),this.onSearchChange(r,t)}handleKeydown(r){if(!this.dropdown.classList.contains("sh-hidden"))switch(r.key){case"ArrowDown":r.preventDefault(),this.selectNext();break;case"ArrowUp":r.preventDefault(),this.selectPrevious();break;case"Enter":r.preventDefault(),this.applySuggestion();break;case"Escape":r.preventDefault(),this.hideDropdown();break}}updateAutocomplete(){let r=this.input.value,t=this.input.selectionStart||0,e=r.substring(0,t),s=e.match(/-?#([a-zA-Z0-9_/-]*)$/),n=e.match(/-?@([a-zA-Z0-9_-]*)$/);s?this.showSuggestions("tag",s[1],s[0].startsWith("-")):n?this.showSuggestions("collection",n[1],n[0].startsWith("-")):this.hideDropdown()}showSuggestions(r,t,e){let s=r==="tag"?this.suggestions.tags:this.suggestions.collections;if(this.currentSuggestions=s.filter(n=>n.toLowerCase().includes(t.toLowerCase())).slice(0,8),this.dropdown.empty(),this.selectedIndex=-1,this.currentSuggestions.length===0){this.hideDropdown();return}this.currentSuggestions.forEach((n,i)=>{let a=this.dropdown.createDiv({cls:"simple-search-suggestion"}),l=a.createSpan({cls:"simple-search-suggestion-icon",text:r==="tag"?"#":"@"});e&&l.classList.add("exclude");let o=this.formatNestedTag(n);a.createSpan({cls:"simple-search-suggestion-text",text:o}),a.addEventListener("click",()=>{this.selectedIndex=i,this.applySuggestion()}),a.addEventListener("mouseenter",()=>{this.setSelected(i)})}),this.dropdown.classList.remove("sh-hidden")}selectNext(){this.currentSuggestions.length!==0&&this.setSelected((this.selectedIndex+1)%this.currentSuggestions.length)}selectPrevious(){this.currentSuggestions.length!==0&&this.setSelected(this.selectedIndex<=0?this.currentSuggestions.length-1:this.selectedIndex-1)}setSelected(r){let t=this.dropdown.querySelectorAll(".simple-search-suggestion");t.forEach(e=>e.classList.remove("selected")),r>=0&&r<t.length&&(t[r].classList.add("selected"),this.selectedIndex=r)}applySuggestion(){if(this.selectedIndex<0||this.selectedIndex>=this.currentSuggestions.length)return;let r=this.currentSuggestions[this.selectedIndex],t=this.input.value,e=this.input.selectionStart||0,s=t.substring(0,e),n=t.substring(e),i=s.match(/-?#([a-zA-Z0-9_-]*)$/),a=s.match(/-?@([a-zA-Z0-9_-]*)$/),l,o;if(i){let h=(i[0].startsWith("-")?"-#":"#")+r+" ";l=s.replace(/-?#[a-zA-Z0-9_/-]*$/,h)+n,o=s.replace(/-?#[a-zA-Z0-9_/-]*$/,h).length}else if(a){let h=(a[0].startsWith("-")?"-@":"@")+r+" ";l=s.replace(/-?@[a-zA-Z0-9_-]*$/,h)+n,o=s.replace(/-?@[a-zA-Z0-9_-]*$/,h).length}else return;this.input.value=l,this.input.setSelectionRange(o,o),this.hideDropdown(),this.handleInput()}hideDropdown(){this.dropdown.classList.add("sh-hidden"),this.selectedIndex=-1}updatePreview(r){if(this.previewElement.empty(),!this.input.value.trim()){this.previewElement.classList.add("sh-hidden");return}if(this.previewElement.classList.remove("sh-hidden"),!r.ast){this.previewElement.createSpan({cls:"simple-search-preview-text",text:"Use #tag @collection (-# to exclude)"});return}let t=r.ast?this.generateDescription(r.ast):"Invalid search query";this.previewElement.createSpan({cls:"simple-search-preview-label",text:"Matching: "}),this.previewElement.createSpan({cls:"simple-search-preview-logic",text:t})}generateDescription(r){return r?this.generateNodeDescription(r):"Invalid"}generateNodeDescription(r){if(r.type==="filter"){let t=r,e=t.exclude?"-":"",s=t.filterType==="tag"?"#":"@";return`${e}${s}${t.value}`}else{if(r.type==="text")return`"${r.value}"`;if(r.type==="operator"){let t=r,e=this.generateNodeDescription(t.left),s=this.generateNodeDescription(t.right);return`${e} ${t.operator} ${s}`}}return""}updateSuggestions(r){this.suggestions=r,this.updateAutocomplete()}clear(){this.input.value="",this.hideDropdown(),this.handleInput()}setValue(r){this.input.value=r,this.handleInput()}formatNestedTag(r){return r}};var nt=/(\s*\[\^(\w+)\])(?!:)/g,ot=/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\])\s*)*\s*$/;var W=require("obsidian");var pt=class extends W.AbstractInputSuggest{constructor(t,e,s){super(t,e);this.inputEl=e,this.dateFormat=s;let n=(0,W.moment)().day(5),i=(0,W.moment)().day();(i===0||i===6)&&n.add(1,"week"),this.dateSuggestions=[{label:d("dateSuggestions.today"),date:(0,W.moment)()},{label:d("dateSuggestions.tomorrow"),date:(0,W.moment)().add(1,"day")},{label:d("dateSuggestions.endOfWeek"),date:n},{label:d("dateSuggestions.inOneWeek"),date:(0,W.moment)().add(1,"week")},{label:d("dateSuggestions.inTwoWeeks"),date:(0,W.moment)().add(2,"weeks")}]}getSuggestions(t){let e=t.toLowerCase().trim();if(e&&/^\d{1,4}[-/]\d/.test(e))return[];if(!e)return this.dateSuggestions;let s=this.dateSuggestions.filter(a=>a.label.toLowerCase().includes(e)),n=this.generateDynamicSuggestions(e),i=[...s,...n];return i.length>0?i:this.dateSuggestions}generateDynamicSuggestions(t){let e=[],s=t.match(/^(\d+)\s*(.*)/);if(s){let i=parseInt(s[1]),a=s[2];(!a||"d".startsWith(a)||"day".includes(a))&&(e.push({label:d(i===1?"dateSuggestions.dayFromNow":"dateSuggestions.daysFromNow",{count:i}),date:(0,W.moment)().add(i,"days")}),i>0&&e.push({label:d(i===1?"dateSuggestions.dayAgo":"dateSuggestions.daysAgo",{count:i}),date:(0,W.moment)().subtract(i,"days")})),(!a||"w".startsWith(a)||"week".includes(a))&&(e.push({label:d(i===1?"dateSuggestions.weekFromNow":"dateSuggestions.weeksFromNow",{count:i}),date:(0,W.moment)().add(i,"weeks")}),i>0&&e.push({label:d(i===1?"dateSuggestions.weekAgo":"dateSuggestions.weeksAgo",{count:i}),date:(0,W.moment)().subtract(i,"weeks")})),(!a||"m".startsWith(a)||"month".includes(a))&&(e.push({label:d(i===1?"dateSuggestions.monthFromNow":"dateSuggestions.monthsFromNow",{count:i}),date:(0,W.moment)().add(i,"months")}),i>0&&e.push({label:d(i===1?"dateSuggestions.monthAgo":"dateSuggestions.monthsAgo",{count:i}),date:(0,W.moment)().subtract(i,"months")}))}if(t.startsWith("next")||t.startsWith("last")){let i=t.startsWith("next")?"next":"last",a=d(`dateSuggestions.${i}`);["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(o=>{let c=d(`dateSuggestions.${o}`),h=`${a} ${c}`;if(h.toLowerCase().includes(t)){let g=this.getNamedDayDate(i,o);g&&e.push({label:h,date:g})}})}if(t.startsWith("this")){let i=d("dateSuggestions.this");["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(l=>{let o=d(`dateSuggestions.${l}`),c=`${i} ${o}`;if(c.toLowerCase().includes(t)){let h=this.getNamedDayDate("this",l);h&&e.push({label:c,date:h})}})}let n=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];return n.forEach(i=>{let a=d(`dateSuggestions.${i}`);if(a.toLowerCase().includes(t)||i.includes(t)){let l=this.getNamedDayDate("this",i),o=this.getNamedDayDate("next",i);if(l){let h=(0,W.moment)().day();n.indexOf(i)>=h&&e.push({label:`${d("dateSuggestions.this")} ${a}`,date:l}),o&&e.push({label:`${d("dateSuggestions.next")} ${a}`,date:o})}}}),e}getNamedDayDate(t,e){let n=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(e);if(n===-1)return null;let a=(0,W.moment)().day();if(t==="last"){let l=a>=n?a-n:7-(n-a);return(0,W.moment)().subtract(l===0?7:l,"days")}else if(t==="next"){let l=n>a?n-a:7-(a-n);return(0,W.moment)().add(l===0?7:l,"days")}else if(t==="this")return n>=a?(0,W.moment)().add(n-a,"days"):(0,W.moment)().add(7+(n-a),"days");return null}renderSuggestion(t,e){e.addClass("date-suggestion-item"),e.createSpan({text:t.label,cls:"date-suggestion-label"}),e.createSpan({text:t.date.format(this.dateFormat),cls:"date-suggestion-date"})}selectSuggestion(t){this.inputEl.value=t.date.format(this.dateFormat);let e=new Event("input");this.inputEl.dispatchEvent(e),this.close()}};var zt="highlights-sidebar",mt=class extends f.ItemView{constructor(t,e){super(t);this.highlightCommentsVisible=new Map;this.groupingMode="none";this.taskSecondaryGroupingMode="none";this.sortMode="none";this.commentsExpanded=!1;this.selectedTags=new Set;this.selectedCollections=new Set;this.selectedSpecialFilters=new Set;this.selectedHighlightIds=new Set;this.actionsButton=null;this.collectionNavButton=null;this.viewMode="current";this.currentCollectionId=null;this.currentTasks=[];this.cachedAllTasks=null;this.preservedScrollTop=0;this.isHighlightFocusing=!1;this.currentPage=0;this.itemsPerPage=100;this.totalHighlights=[];this.isPreservingPagination=!1;this.currentGroupPage=0;this.totalGroups=[];this.currentTaskPage=0;this.totalTasks=[];this.isColorChanging=!1;this.searchExpanded=!1;this.isRenderingTasks=!1;this.recentlyMovedTaskId=null;this.currentSearchTokens=[];this.currentParsedSearch={ast:null};this.dropdownManager=new ct;this.savedScrollPosition=0;this.showNativeComments=!0;this.collapsedSections=new Set;this.fileTaskCache=new Map;this.plugin=e,this.highlightRenderer=new ht(e),this.taskManager=new gt(e),this.taskRenderer=new dt(e),this.plugin.settings.tabSettings||(this.plugin.settings.tabSettings={}),this.groupingMode=e.settings.groupingMode||"none",this.sortMode=e.settings.sortMode||"none",this.taskSecondaryGroupingMode=e.settings.taskSecondaryGroupingMode||"none",this.showNativeComments=this.plugin.app.loadLocalStorage("sidebar-highlights-show-native-comments")!=="false"}getViewType(){return zt}getDisplayText(){return"Highlights"}getIcon(){return"highlighter"}getDefaultTabSettings(t){return t==="tasks"?{groupingMode:"none",sortMode:"none",commentsExpanded:!1,searchExpanded:!1}:{groupingMode:"none",sortMode:"none",commentsExpanded:!1,searchExpanded:!1}}saveCurrentTabSettings(){this.plugin.settings.tabSettings||(this.plugin.settings.tabSettings={}),this.plugin.settings.tabSettings[this.viewMode]={groupingMode:this.groupingMode,sortMode:this.sortMode,commentsExpanded:this.commentsExpanded,searchExpanded:this.searchExpanded,selectedTags:Array.from(this.selectedTags),selectedCollections:Array.from(this.selectedCollections),selectedSpecialFilters:Array.from(this.selectedSpecialFilters)},this.plugin.saveSettings()}restoreTabSettings(t){var i,a;let e=(i=this.plugin.settings.tabSettings)==null?void 0:i[t];if(e)this.groupingMode=e.groupingMode,this.sortMode=e.sortMode,this.commentsExpanded=e.commentsExpanded,this.searchExpanded=(a=e.searchExpanded)!=null?a:!1,this.selectedTags=new Set(e.selectedTags||[]),this.selectedCollections=new Set(e.selectedCollections||[]),this.selectedSpecialFilters=new Set(e.selectedSpecialFilters||[]),this.commentsExpanded?this.expandAllCommentsInMap():this.collapseAllCommentsInMap();else{let l=this.getDefaultTabSettings(t);this.groupingMode=l.groupingMode,this.sortMode=l.sortMode,this.commentsExpanded=l.commentsExpanded,this.searchExpanded=l.searchExpanded,this.selectedTags.clear(),this.selectedCollections.clear(),this.selectedSpecialFilters.clear(),this.collapseAllCommentsInMap()}let s=t==="tasks",n=this.sortMode==="priority"||this.sortMode==="date-asc"||this.sortMode==="date-desc";if(!s&&n&&(this.sortMode="none"),this.contentEl){let l=this.contentEl.querySelector(".highlights-group-button");l&&this.updateGroupButtonState(l),this.sortButton&&this.updateSortButtonState(this.sortButton),this.commentsToggleButton&&(this.commentsExpanded?this.commentsToggleButton.classList.add("active"):this.commentsToggleButton.classList.remove("active"),this.updateCommentsToggleIcon(this.commentsToggleButton)),this.showTagActive();let o=this.contentEl.querySelector(".highlights-search-input-container");this.searchButton&&o&&(this.searchExpanded?(o.classList.remove("sh-hidden"),this.searchButton.classList.add("active"),(0,f.setIcon)(this.searchButton,"x"),(0,f.setTooltip)(this.searchButton,d("toolbar.closeSearch"))):(o.classList.add("sh-hidden"),this.searchButton.classList.remove("active"),(0,f.setIcon)(this.searchButton,"search"),(0,f.setTooltip)(this.searchButton,d("toolbar.search"))))}}getViewMode(){return this.viewMode}extractTaskLines(t){let e=t.split(`
`),s=[],n=[],i=!1,a=null;for(let l=0;l<e.length;l++){let o=e[l],c=/^[\s]*[-*]\s*\[[ xX-]\]/.test(o);if(/^#{1,6}\s+/.test(o)&&(a=o.trim()),c)n.length>0&&s.push(n.join(`
`)),n=[],a&&n.push(a),n.push(o.trim()),i=!0;else if(i){let g=o.trim();g.length>0&&(o.startsWith(" ")||o.startsWith("	"))?n.push(o):(g.length,i=!1)}}return n.length>0&&s.push(n.join(`
`)),s}haveTasksChanged(t,e){let s=this.extractTaskLines(t),n=this.extractTaskLines(e);if(s.length!==n.length)return!0;for(let i=0;i<s.length;i++)if(s[i]!==n[i])return!0;return!1}async onOpen(t=!1){if(this.contentEl.empty(),this.contentEl.classList.add("highlights-sidebar-content"),this.plugin.settings.showToolbar){let o=this.contentEl.createDiv({cls:"highlights-search-container"}),c=o.createEl("button",{cls:"highlights-group-button"});this.searchButton=c,(0,f.setIcon)(c,"search"),(0,f.setTooltip)(c,d("toolbar.search")),c.addEventListener("click",()=>{this.toggleSearch()});let h=o.createEl("button",{cls:"highlights-group-button"});(0,f.setIcon)(h,"group"),(0,f.setTooltip)(h,d("toolbar.group")),this.updateGroupButtonState(h),h.addEventListener("click",y=>{let v=new f.Menu,S=this.viewMode==="tasks";v.addItem(k=>{k.setTitle(d("grouping.none")).setIcon("list").setChecked(this.groupingMode==="none").onClick(()=>{this.groupingMode="none",this.taskSecondaryGroupingMode!=="none"&&(this.taskSecondaryGroupingMode="none",this.saveTaskSecondaryGroupingModeToSettings()),this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),S||(v.addSeparator(),v.addItem(k=>{k.setTitle(d("grouping.color")).setIcon("palette").setChecked(this.groupingMode==="color").onClick(()=>{this.groupingMode="color",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addSeparator(),v.addItem(k=>{k.setTitle(d("grouping.commentsAsc")).setIcon("sort-asc").setChecked(this.groupingMode==="comments-asc").onClick(()=>{this.groupingMode="comments-asc",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addItem(k=>{k.setTitle(d("grouping.commentsDesc")).setIcon("sort-desc").setChecked(this.groupingMode==="comments-desc").onClick(()=>{this.groupingMode="comments-desc",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addSeparator(),v.addItem(k=>{k.setTitle(d("grouping.dateAsc")).setIcon("calendar").setChecked(this.groupingMode==="date-created-asc").onClick(()=>{this.groupingMode="date-created-asc",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addItem(k=>{k.setTitle(d("grouping.dateDesc")).setIcon("calendar").setChecked(this.groupingMode==="date-created-desc").onClick(()=>{this.groupingMode="date-created-desc",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})})),v.addSeparator(),S||v.addItem(k=>{k.setTitle(d("grouping.parent")).setIcon("folder").setChecked(this.groupingMode==="parent").onClick(()=>{this.groupingMode="parent",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),S&&(v.addSeparator(),v.addItem(k=>{k.setTitle(d("grouping.dueDate")).setIcon("calendar").setChecked(this.groupingMode==="date-asc").onClick(()=>{this.groupingMode="date-asc",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addSeparator()),S||v.addItem(k=>{k.setTitle(d("grouping.collection")).setIcon("folder-open").setChecked(this.groupingMode==="collection").onClick(()=>{this.groupingMode="collection",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.addItem(k=>{k.setTitle(d("grouping.filename")).setIcon("file-text").setChecked(this.groupingMode==="filename").onClick(()=>{this.groupingMode="filename",this.updateGroupButtonState(h),this.updateSortButtonState(this.sortButton),this.saveGroupingModeToSettings(),this.renderContent()})}),v.showAtMouseEvent(y)}),this.sortButton=o.createEl("button",{cls:"highlights-group-button"}),(0,f.setIcon)(this.sortButton,"arrow-up-down"),(0,f.setTooltip)(this.sortButton,d("toolbar.sort")),this.updateSortButtonState(this.sortButton),this.sortButton.addEventListener("click",y=>{let v=new f.Menu,S=this.viewMode==="tasks";v.addItem(k=>{k.setTitle(d("sorting.none")).setIcon("list").setChecked(this.sortMode==="none").onClick(()=>{this.sortMode="none",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})}),v.addSeparator(),v.addItem(k=>{k.setTitle(d("sorting.aToZ")).setIcon("sort-asc").setChecked(this.sortMode==="alphabetical-asc").onClick(()=>{this.sortMode="alphabetical-asc",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})}),v.addItem(k=>{k.setTitle(d("sorting.zToA")).setIcon("sort-desc").setChecked(this.sortMode==="alphabetical-desc").onClick(()=>{this.sortMode="alphabetical-desc",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})}),S&&(v.addSeparator(),v.addItem(k=>{k.setTitle(d("sorting.priority")).setIcon("flag").setChecked(this.sortMode==="priority").onClick(()=>{this.sortMode="priority",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})}),v.addSeparator(),v.addItem(k=>{k.setTitle(d("sorting.dateEarliestFirst")).setIcon("calendar-arrow-up").setChecked(this.sortMode==="date-asc").onClick(()=>{this.sortMode="date-asc",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})}),v.addItem(k=>{k.setTitle(d("sorting.dateLatestFirst")).setIcon("calendar-arrow-down").setChecked(this.sortMode==="date-desc").onClick(()=>{this.sortMode="date-desc",this.updateSortButtonState(this.sortButton),this.saveSortModeToSettings(),this.renderContent()})})),v.showAtMouseEvent(y)});let g=o.createEl("button",{cls:"highlights-group-button"});(0,f.setTooltip)(g,d("toolbar.toggleComments")),this.updateNativeCommentsToggleState(g),g.addEventListener("click",()=>{this.toggleNativeCommentsVisibility(),this.updateNativeCommentsToggleState(g),this.renderContent()}),this.commentsToggleButton=o.createEl("button",{cls:"highlights-group-button"}),(0,f.setTooltip)(this.commentsToggleButton,d("toolbar.toggleHighlightComments")),this.updateCommentsToggleIcon(this.commentsToggleButton),this.commentsToggleButton.addEventListener("click",()=>{this.toggleAllComments(),this.updateCommentsToggleIcon(this.commentsToggleButton),this.commentsExpanded?this.commentsToggleButton.classList.add("active"):this.commentsToggleButton.classList.remove("active"),this.renderContent()});let u=o.createEl("button",{cls:"highlights-group-button"});(0,f.setTooltip)(u,d("toolbar.revertColors")),(0,f.setIcon)(u,"rotate-ccw"),u.addEventListener("click",()=>{this.resetAllColors()});let m=o.createEl("button",{cls:"highlights-group-button highlights-tag-filter-button"});(0,f.setTooltip)(m,d("toolbar.filter")),(0,f.setIcon)(m,"list-filter"),m.addEventListener("click",y=>{this.showTagFilterMenu(y)}),this.collectionNavButton=o.createEl("button",{cls:"highlights-group-button"}),(0,f.setTooltip)(this.collectionNavButton,"Collection Navigation"),this.updateCollectionNavButton(this.collectionNavButton),this.collectionNavButton.addEventListener("click",()=>{this.viewMode==="collections"&&this.currentCollectionId?(this.currentCollectionId=null,this.renderContent()):this.showNewCollectionDialog()}),this.actionsButton=o.createEl("button",{cls:"highlights-group-button"}),(0,f.setTooltip)(this.actionsButton,d("toolbar.actions")),(0,f.setIcon)(this.actionsButton,"ellipsis"),this.actionsButton.style.display="none",this.actionsButton.addEventListener("click",y=>{this.showActionsMenu(y)});let p=this.contentEl.createDiv({cls:"highlights-search-input-container sh-hidden"});this.searchInputEl=p.createEl("input",{type:"text",placeholder:d("toolbar.searchPlaceholder"),cls:"highlights-search-input"}),this.simpleSearchManager=new ut(this.searchInputEl,p,(y,v)=>this.handleSearchInput(y,v),{tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}let e=this.contentEl.createDiv({cls:"highlights-tabs-container"}),s=!1,n=null;this.plugin.settings.showCurrentNoteTab&&(n=e.createEl("button",{cls:"highlights-tab"+(s?"":" active")}),(0,f.setIcon)(n,"file-text"),(0,f.setTooltip)(n,d("tabs.currentNote")),s||(this.viewMode="current",s=!0));let i=null;this.plugin.settings.showAllNotesTab&&(i=e.createEl("button",{cls:"highlights-tab"+(s?"":" active")}),(0,f.setIcon)(i,"files"),(0,f.setTooltip)(i,d("tabs.allNotes")),s||(this.viewMode="all",s=!0));let a=null;this.plugin.settings.showCollectionsTab&&(a=e.createEl("button",{cls:"highlights-tab"+(s?"":" active")}),(0,f.setIcon)(a,"folder-open"),(0,f.setTooltip)(a,d("tabs.collections")),s||(this.viewMode="collections",s=!0));let l=null;this.plugin.settings.showTasksTab&&(l=e.createEl("button",{cls:"highlights-tab"+(s?"":" active")}),(0,f.setIcon)(l,"circle-check"),(0,f.setTooltip)(l,d("tabs.tasks")),s||(this.viewMode="tasks",s=!0)),n&&n.addEventListener("click",()=>{this.viewMode!=="current"&&(n.classList.add("active"),i&&i.classList.remove("active"),a&&a.classList.remove("active"),l&&l.classList.remove("active"),this.viewMode="current",this.clearSelection(),this.restoreTabSettings("current"),this.updateContent())}),i&&i.addEventListener("click",()=>{this.viewMode!=="all"&&(i.classList.add("active"),n&&n.classList.remove("active"),a&&a.classList.remove("active"),l&&l.classList.remove("active"),this.viewMode="all",this.clearSelection(),this.restoreTabSettings("all"),this.updateContent())}),a&&a.addEventListener("click",()=>{this.viewMode!=="collections"&&(a.classList.add("active"),n&&n.classList.remove("active"),i&&i.classList.remove("active"),l&&l.classList.remove("active"),this.viewMode="collections",this.clearSelection(),this.restoreTabSettings("collections"),this.currentCollectionId=null,this.updateContent())}),l&&l.addEventListener("click",()=>{this.viewMode!=="tasks"&&(l.classList.add("active"),n&&n.classList.remove("active"),i&&i.classList.remove("active"),a&&a.classList.remove("active"),this.viewMode="tasks",this.clearSelection(),this.restoreTabSettings("tasks"),this.updateContent())}),this.contentAreaEl=this.contentEl.createDiv({cls:"highlights-list-area"}),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"}),this.registerEvent(this.app.vault.on("modify",async o=>{o instanceof f.TFile&&this.viewMode==="tasks"&&(this.taskRefreshTimeout&&window.clearTimeout(this.taskRefreshTimeout),this.taskRefreshTimeout=window.setTimeout(async()=>{let c=await this.app.vault.cachedRead(o);if(this.fileTaskCache.set(o.path,this.extractTaskLines(c)),this.cachedAllTasks){this.cachedAllTasks=this.cachedAllTasks.filter(g=>g.filePath!==o.path);let h=await this.taskManager.scanFileForTasks(o,!0,this.plugin.settings.showTaskContext);this.cachedAllTasks.push(...h)}else this.cachedAllTasks=null;this.renderContent()},300))})),this.registerEvent(this.app.vault.on("create",async o=>{if(o instanceof f.TFile&&this.viewMode==="tasks"){let c=await this.app.vault.cachedRead(o),h=this.extractTaskLines(c);h.length>0&&(this.fileTaskCache.set(o.path,h),this.cachedAllTasks=null,this.taskRefreshTimeout&&window.clearTimeout(this.taskRefreshTimeout),this.taskRefreshTimeout=window.setTimeout(()=>{this.renderContent()},300))}})),this.registerEvent(this.app.vault.on("delete",o=>{o instanceof f.TFile&&this.viewMode==="tasks"&&(this.fileTaskCache.delete(o.path),this.cachedAllTasks=null,this.taskRefreshTimeout&&window.clearTimeout(this.taskRefreshTimeout),this.taskRefreshTimeout=window.setTimeout(()=>{this.renderContent()},300))})),this.registerEvent(this.app.vault.on("rename",async(o,c)=>{if(o instanceof f.TFile&&this.viewMode==="tasks"){this.fileTaskCache.delete(c);let h=await this.app.vault.cachedRead(o);this.fileTaskCache.set(o.path,this.extractTaskLines(h)),this.cachedAllTasks=null,this.taskRefreshTimeout&&window.clearTimeout(this.taskRefreshTimeout),this.taskRefreshTimeout=window.setTimeout(()=>{this.renderContent()},300)}})),this.restoreTabSettings(this.viewMode),t||this.renderContent()}async onClose(){this.dropdownManager.cleanup(),this.highlightCommentsVisible.clear(),this.selectedTags.clear(),this.selectedSpecialFilters.clear()}navigateToCollection(t){if(!this.plugin.collectionsManager.getCollection(t)){new f.Notice("Collection not found");return}this.viewMode="collections",this.currentCollectionId=t;let s=this.contentEl.querySelectorAll(".highlights-tab");if(s.length>=3){let n=s[0],i=s[1],a=s[2];n.classList.remove("active"),i.classList.remove("active"),a.classList.remove("active"),a.classList.add("active")}this.selectedTags.clear(),this.selectedSpecialFilters.clear(),this.renderContent()}refresh(){this.selectedTags.clear(),this.selectedSpecialFilters.clear(),this.cachedAllTasks=null;let t=this.viewMode,e=this.currentCollectionId,s=this.isHighlightFocusing||this.isColorChanging,n=this.preservedScrollTop;s||this.captureScrollPosition(),this.onOpen(!0),this.viewMode=t,this.currentCollectionId=e,this.restoreTabSettings(this.viewMode),this.updateTabStates(),this.renderContent(),this.restoreSelectedHighlight(),s?requestAnimationFrame(()=>{this.contentAreaEl&&(this.contentAreaEl.scrollTop=n)}):this.restoreScrollPosition()}updateTabStates(){let t=this.contentEl.querySelectorAll(".highlights-tab");t.forEach(i=>i.classList.remove("active"));let e=0,s={};this.plugin.settings.showCurrentNoteTab&&(s.current=e++),this.plugin.settings.showAllNotesTab&&(s.all=e++),this.plugin.settings.showCollectionsTab&&(s.collections=e++),this.plugin.settings.showTasksTab&&(s.tasks=e++);let n=s[this.viewMode];n!==void 0&&t[n]&&t[n].classList.add("active")}resetToFirstVisibleTab(){this.plugin.settings.showCurrentNoteTab?this.viewMode="current":this.plugin.settings.showAllNotesTab?this.viewMode="all":this.plugin.settings.showCollectionsTab?(this.viewMode="collections",this.currentCollectionId=null):this.plugin.settings.showTasksTab&&(this.viewMode="tasks")}captureScrollPosition(){this.contentAreaEl&&(this.savedScrollPosition=this.contentAreaEl.scrollTop)}restoreScrollPosition(){this.contentAreaEl&&!this.isHighlightFocusing&&!this.isColorChanging&&requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.savedScrollPosition})}restoreSelectedHighlight(){this.plugin.selectedHighlightId&&requestAnimationFrame(()=>{this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(s=>{s.classList.remove("selected","highlight-selected"),s.style.removeProperty("border-left-color"),s.style.removeProperty("box-shadow")});let e=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(e){e.classList.add("selected");let s=this.plugin.selectedHighlightId?this.getHighlightById(this.plugin.selectedHighlightId):null;s&&(e.classList.add("highlight-selected"),this.applyHighlightColorStyling(e,s))}})}applyHighlightColorStyling(t,e){let s=e.color||this.plugin.settings.highlightColor;t.style.borderLeftColor=s,e.isNativeComment||(t.style.boxShadow=`0 0 0 1.5px ${s}, var(--shadow-s)`)}updateContent(){this.renderContent()}updateItem(t){var l;let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`);if(!e)return;let s=this.getHighlightById(t);if(!s){e.remove();return}let n=document.createElement("div"),i=this.viewMode==="all";this.createHighlightItem(n,s,this.getSearchTerm(),i);let a=n.firstElementChild;a&&((l=e.parentNode)==null||l.replaceChild(a,e),this.plugin.selectedHighlightId===t&&(a.classList.add("selected"),a.classList.add("highlight-selected"),this.applyHighlightColorStyling(a,s)))}getSearchTerm(){let t=this.containerEl.querySelector(".highlights-search-input");return(t==null?void 0:t.value)||""}renderContent(){this.captureScrollPosition(),this.viewMode==="collections"?this.currentCollectionId?(this.enableSearchAndToolbar(),this.renderCollectionDetailView(this.currentCollectionId)):(this.disableSearchAndToolbar(),this.renderCollectionsView()):this.viewMode==="tasks"?(this.enableSearchAndToolbar(),this.renderTasksView()):(this.enableSearchAndToolbar(),this.renderFilteredList()),this.collectionNavButton&&this.updateCollectionNavButton(this.collectionNavButton),this.restoreScrollPosition()}renderCollectionsView(){this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list collections-container"});let t=this.plugin.collectionsManager.getAllCollections();t.length===0?this.renderEmptyCollectionsState(this.listContainerEl):this.renderCollectionsGrid(this.listContainerEl,t),this.restoreScrollPosition()}renderEmptyCollectionsState(t){this.highlightRenderer.createEmptyState(t,d("emptyStates.noCollectionsYet"))}renderCollectionsGrid(t,e){let s=t.createDiv({cls:"collections-grid"});e.forEach(n=>{let i=s.createDiv({cls:"collection-card"});i.setAttribute("data-collection-id",n.id);let a=i.createDiv({cls:"collection-menu-btn"});(0,f.setIcon)(a,"ellipsis-vertical"),a.addEventListener("click",v=>{v.stopPropagation(),this.showCollectionMenu(v,n)});let l=i.createDiv({cls:"collection-name"});l.textContent=n.name;let o=i.createDiv({cls:"collection-description"});n.description&&n.description.trim()?o.textContent=n.description:(o.textContent=d("emptyStates.noDescription"),o.classList.add("collection-description-empty"));let c=i.createDiv({cls:"collection-stats"}),h=this.plugin.collectionsManager.getCollectionStats(n.id),g=c.createEl("small",{cls:"collection-info-line"}),u=g.createDiv({cls:"highlight-line-info"}),m=u.createDiv({cls:"line-icon"});if((0,f.setIcon)(m,"highlighter"),u.createSpan({text:`${h.highlightCount}`}),this.showNativeComments){let v=g.createDiv({cls:"highlight-line-info"}),S=v.createDiv({cls:"line-icon"});(0,f.setIcon)(S,"captions"),v.createSpan({text:`${h.nativeCommentsCount}`})}let p=g.createDiv({cls:"highlight-line-info"}),y=p.createDiv({cls:"line-icon"});(0,f.setIcon)(y,"file-text"),p.createSpan({text:`${h.fileCount}`}),i.addEventListener("click",()=>{this.currentCollectionId=n.id,this.renderContent()})})}getCurrentFileTasks(){var n;let t=this.plugin.app.workspace.getActiveFile();if(!t)return[];let e=((n=this.cachedAllTasks)==null?void 0:n.filter(i=>i.filePath===t.path))||[];this.plugin.settings.showCompletedTasks||(e=e.filter(i=>!i.completed));let s=this.getSearchTerm();return s&&s.length>0&&(e=e.filter(i=>i.text.toLowerCase().includes(s.toLowerCase())||i.filePath.toLowerCase().includes(s.toLowerCase()))),this.selectedTags.size>0&&(e=e.filter(i=>{let a=/#([a-zA-Z0-9_/-]+)/g,l=[],o;for(;(o=a.exec(i.text))!==null;)l.push(o[1]);return Array.from(this.selectedTags).some(c=>l.includes(c))})),this.selectedSpecialFilters.size>0&&(e=e.filter(i=>{let a=(0,f.moment)().startOf("day");return Array.from(this.selectedSpecialFilters).every(l=>{switch(l){case"flagged":return i.flagged;case"upcoming":if(!i.date)return!1;let o=(0,f.moment)(i.date,"YYYY-MM-DD"),c=(0,f.moment)().startOf("week"),h=(0,f.moment)().endOf("week");return o.isSameOrAfter(c)&&o.isSameOrBefore(h);case"completed":return i.completed;case"incomplete":return!i.completed;case"due-today":return i.date?(0,f.moment)(i.date,"YYYY-MM-DD").isSame(a,"day"):!1;case"overdue":return i.date?(0,f.moment)(i.date,"YYYY-MM-DD").isBefore(a)&&!i.completed:!1;case"no-date":return!i.date;case"created-last-7-days":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(7,"days").startOf("day");return p.isSameOrAfter(y)}case"created-last-30-days":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(30,"days").startOf("day");return p.isSameOrAfter(y)}case"created-last-year":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(1,"year").startOf("day");return p.isSameOrAfter(y)}default:return!0}})})),e}async renderCurrentNoteTasksSection(){let t=this.plugin.app.workspace.getActiveFile();if(!t)return;let e=this.getCurrentFileTasks();if(e.length===0)return;let n=this.contentAreaEl.createDiv({cls:"highlight-group-header current-note-group-header"}).createEl("span"),i=n.createSpan({cls:"tree-item-icon"});(0,f.setIcon)(i,"file-pen-line"),n.createSpan({text:t.basename}),n.createSpan({cls:"tree-item-flair",text:e.length.toString()});let a=this.contentAreaEl.createDiv({cls:"current-note-tasks-card"});e.sort((o,c)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let h=o.text.toLowerCase(),g=c.text.toLowerCase(),u=h.localeCompare(g);return this.sortMode==="alphabetical-asc"?u:-u}if(this.sortMode==="priority"){let h=o.priority||999,g=c.priority||999;return h!==g?h-g:o.lineNumber-c.lineNumber}if(this.sortMode==="date-asc"||this.sortMode==="date-desc"){let h=o.date||"9999-12-31",g=c.date||"9999-12-31",u=h.localeCompare(g);return u!==0?this.sortMode==="date-asc"?u:-u:o.lineNumber-c.lineNumber}return o.lineNumber-c.lineNumber}).forEach(o=>{this.taskRenderer.createTaskItem(a,o,{hideFilename:!0,hideDateBadge:!1,onTaskToggle:async(c,h)=>{await this.handleTaskToggle(c,h)},onTaskClick:(c,h)=>{this.handleTaskClick(c,h)},onFileNameClick:(c,h)=>{this.plugin.app.workspace.openLinkText(c,"")},onFlagToggle:async(c,h)=>{await this.handleFlagToggle(c,h)},onCalendarToggle:async c=>{await this.handleCalendarToggle(c)}})})}async renderTasksView(){if(!this.isRenderingTasks){this.isRenderingTasks=!0;try{this.captureScrollPosition(),this.preserveCollapsedSections(),this.contentAreaEl.empty();let t;if(this.cachedAllTasks!==null)t=this.cachedAllTasks;else{let i=this.contentAreaEl.createDiv({cls:"task-loading"});i.textContent=d("emptyStates.loadingTasks"),t=await this.taskManager.scanAllTasks(!0,this.plugin.settings.showTaskContext),this.cachedAllTasks=t,this.fileTaskCache.clear();let a=new Set(t.map(l=>l.filePath));for(let l of a){let o=this.app.vault.getAbstractFileByPath(l);if(o instanceof f.TFile){let c=await this.app.vault.cachedRead(o),h=this.extractTaskLines(c);this.fileTaskCache.set(l,h)}}i.remove()}if(this.plugin.settings.showCurrentNoteTasksSection&&await this.renderCurrentNoteTasksSection(),this.plugin.settings.showOnlyCurrentNoteTasks&&this.plugin.settings.showCurrentNoteTasksSection){this.restoreScrollPosition();return}this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list tasks-container"});let e=t;this.plugin.settings.showCompletedTasks||(e=t.filter(i=>!i.completed)),this.currentTasks=e;let s=this.getSearchTerm(),n=e;if(s&&s.length>0&&(n=e.filter(i=>i.text.toLowerCase().includes(s.toLowerCase())||i.filePath.toLowerCase().includes(s.toLowerCase()))),this.selectedTags.size>0&&(n=n.filter(i=>{let a=/#([a-zA-Z0-9_/-]+)/g,l=[],o;for(;(o=a.exec(i.text))!==null;)l.push(o[1]);return Array.from(this.selectedTags).some(c=>l.includes(c))})),this.selectedSpecialFilters.size>0&&(n=n.filter(i=>{let a=(0,f.moment)().startOf("day");return Array.from(this.selectedSpecialFilters).every(l=>{switch(l){case"flagged":return i.flagged;case"upcoming":if(!i.date)return!1;let o=(0,f.moment)(i.date,"YYYY-MM-DD"),c=(0,f.moment)().startOf("week"),h=(0,f.moment)().endOf("week");return o.isSameOrAfter(c)&&o.isSameOrBefore(h);case"completed":return i.completed;case"incomplete":return!i.completed;case"due-today":return i.date?(0,f.moment)(i.date,"YYYY-MM-DD").isSame(a,"day"):!1;case"overdue":return i.date?(0,f.moment)(i.date,"YYYY-MM-DD").isBefore(a)&&!i.completed:!1;case"no-date":return!i.date;case"created-last-7-days":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(7,"days").startOf("day");return p.isSameOrAfter(y)}case"created-last-30-days":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(30,"days").startOf("day");return p.isSameOrAfter(y)}case"created-last-year":{let m=this.plugin.app.vault.getAbstractFileByPath(i.filePath);if(!m||!(m instanceof f.TFile))return!1;let p=(0,f.moment)(m.stat.ctime),y=(0,f.moment)().subtract(1,"year").startOf("day");return p.isSameOrAfter(y)}default:return!0}})})),n.length===0){let i=s&&s.length>0||this.selectedTags.size>0||this.selectedSpecialFilters.size>0;this.taskRenderer.createEmptyState(this.listContainerEl,i?d("emptyStates.noMatchingTasks"):d("emptyStates.noTasksAcrossAll"))}else if(this.groupingMode==="none"){let i=n.sort((a,l)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let o=a.text.toLowerCase(),c=l.text.toLowerCase(),h=o.localeCompare(c);return this.sortMode==="alphabetical-asc"?h:-h}if(this.sortMode==="priority"){let o=a.priority||999,c=l.priority||999;return o!==c?o-c:a.lineNumber-l.lineNumber}if(this.sortMode==="date-asc"||this.sortMode==="date-desc"){let o=a.date||"9999-12-31",c=l.date||"9999-12-31",h=o.localeCompare(c);return h!==0?this.sortMode==="date-asc"?h:-h:a.lineNumber-l.lineNumber}return a.filePath!==l.filePath?a.filePath.localeCompare(l.filePath):a.lineNumber-l.lineNumber});this.renderTasksWithPagination(i,s)}else this.renderGroupedTasks(n,s,t);this.restoreScrollPosition(),this.showTagActive(),this.recentlyMovedTaskId&&(this.applyTaskFlashAnimation(this.recentlyMovedTaskId),this.recentlyMovedTaskId=null)}finally{this.isRenderingTasks=!1}}}applyTaskFlashAnimation(t){requestAnimationFrame(()=>{let e=this.listContainerEl.querySelector(`[data-task-id="${t}"]`);e&&(e.addClass("task-flash"),setTimeout(()=>{e.removeClass("task-flash")},600))})}renderGroupedTasks(t,e,s){let n=(0,f.moment)().startOf("day"),i=c=>{if(this.groupingMode==="date-asc")if(c.date){let h=(0,f.moment)(c.date,"YYYY-MM-DD");if(h.isBefore(n)&&!c.completed)return"OVERDUE";let g=h.diff(n,"days");if(g>=0&&g<=6)return c.date;if(h.year()===n.year()&&h.month()===n.month())return`${h.format("YYYY-MM")}-CURRENT-MONTH`;let u=(0,f.moment)(n).add(4,"months").endOf("month");return h.isSameOrBefore(u,"day")?h.format("YYYY-MM"):h.format("YYYY")}else return"No Date";else return this.groupingMode==="filename"?(c.filePath.split("/").pop()||c.filePath).replace(/\.md$/,""):"All Tasks"},a=new Map;t.forEach(c=>{let h=i(c);a.has(h)||a.set(h,[]),a.get(h).push(c)});let l=new Map;s&&s.forEach(c=>{let h=i(c);l.has(h)||l.set(h,[]),l.get(h).push(c)}),Array.from(a.entries()).sort(([c],[h])=>{if(this.groupingMode==="date-asc"){if(c==="OVERDUE"&&h==="OVERDUE")return 0;if(c==="OVERDUE")return-1;if(h==="OVERDUE")return 1;if(c==="No Date"&&h==="No Date")return 0;if(c==="No Date")return 1;if(h==="No Date")return-1;let g=u=>/^\d{4}-\d{2}-\d{2}$/.test(u)?u:u.endsWith("-CURRENT-MONTH")?`${u.replace("-CURRENT-MONTH","")}-32`:/^\d{4}-\d{2}$/.test(u)?`${u}-33`:/^\d{4}$/.test(u)?`${u}-13-34`:u;return g(c).localeCompare(g(h))}else return this.groupingMode==="filename",c.localeCompare(h)}).forEach(([c,h])=>{let u=this.listContainerEl.createDiv({cls:"highlight-group-header"}).createEl("span"),m=l.has(c)?l.get(c):h,p=m.filter(k=>k.completed).length,y=m.length,v=y>0?p/y*100:0;if(this.createTaskProgressCircle(u,v,p,y),u.createSpan({text:this.getGroupDisplayName(c)}),u.createSpan({cls:"tree-item-flair",text:y.toString()}),this.groupingMode==="date-asc"){let k=h.sort((T,E)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let x=T.text.toLowerCase(),M=E.text.toLowerCase(),F=x.localeCompare(M);return this.sortMode==="alphabetical-asc"?F:-F}if(this.sortMode==="priority"){let x=T.priority||999,M=E.priority||999;return x!==M?x-M:T.lineNumber-E.lineNumber}if(this.sortMode==="date-asc"||this.sortMode==="date-desc"){let x=T.date||"9999-12-31",M=E.date||"9999-12-31",F=x.localeCompare(M);return F!==0?this.sortMode==="date-asc"?F:-F:T.lineNumber-E.lineNumber}return T.lineNumber-E.lineNumber}),I=this.listContainerEl.createDiv({cls:"task-group-container"}),H=/^\d{4}-\d{2}-\d{2}$/.test(c)||c==="OVERDUE";k.forEach(T=>{let E;if(T.indentLevel>0){if(!T.date)return;this.cachedAllTasks&&(E=this.cachedAllTasks.find(x=>x.filePath===T.filePath&&x.lineNumber<T.lineNumber&&x.indentLevel<T.indentLevel))}if(this.taskRenderer.createTaskItem(I,T,{searchTerm:e,hideFilename:!1,hideDateBadge:H,parentTask:E,onTaskToggle:async(x,M)=>{await this.handleTaskToggle(x,M)},onTaskClick:(x,M)=>{this.handleTaskClick(x,M)},onFileNameClick:(x,M)=>{this.plugin.app.workspace.openLinkText(x,"")},onFlagToggle:async(x,M)=>{await this.handleFlagToggle(x,M)},onCalendarToggle:async x=>{await this.handleCalendarToggle(x)}}),T.indentLevel===0&&this.cachedAllTasks){let x=this.cachedAllTasks.filter(D=>D.filePath===T.filePath&&D.lineNumber>T.lineNumber&&D.indentLevel>T.indentLevel&&!D.date),M=this.cachedAllTasks.find(D=>D.filePath===T.filePath&&D.lineNumber>T.lineNumber&&D.indentLevel<=T.indentLevel);(M?x.filter(D=>D.lineNumber<M.lineNumber):x).forEach(D=>{this.taskRenderer.createTaskItem(I,D,{searchTerm:e,hideFilename:!1,hideDateBadge:H,onTaskToggle:async(N,P)=>{await this.handleTaskToggle(N,P)},onTaskClick:(N,P)=>{this.handleTaskClick(N,P)},onFileNameClick:(N,P)=>{this.plugin.app.workspace.openLinkText(N,"")},onFlagToggle:async(N,P)=>{await this.handleFlagToggle(N,P)},onCalendarToggle:async N=>{await this.handleCalendarToggle(N)}})})}})}else{let k=new Map;h.forEach(H=>{let T=H.section||d("emptyStates.noSection");k.has(T)||k.set(T,[]),k.get(T).push(H)}),Array.from(k.entries()).sort(([H],[T])=>H===d("emptyStates.noSection")&&T===d("emptyStates.noSection")?0:H===d("emptyStates.noSection")?-1:T===d("emptyStates.noSection")?1:H.localeCompare(T)).forEach(([H,T],E)=>{let x=[];if(H!==d("emptyStates.noSection")){let C=`${c}::${H}`,w=`${c}::__position__::${E}`,A=this.collapsedSections.has(C)||this.collapsedSections.has(w),L=this.listContainerEl.createDiv({cls:"task-section-header"});L.setAttribute("data-section-id",C),L.setAttribute("data-section-position-id",w),L.setAttribute("data-group-name",c),A&&L.addClass("collapsed");let R=L.createSpan({text:H}),B=L.createSpan({cls:"task-section-ellipsis",text:"..."});L.addEventListener("click",()=>{this.collapsedSections.has(C)?(this.collapsedSections.delete(C),this.collapsedSections.delete(w),L.removeClass("collapsed"),x.forEach(O=>O.style.display="")):(this.collapsedSections.add(C),this.collapsedSections.add(w),L.addClass("collapsed"),x.forEach(O=>O.style.display="none"))})}let M=`${c}::${H}`,F=`${c}::__position__::${E}`,D=H!==d("emptyStates.noSection")&&(this.collapsedSections.has(M)||this.collapsedSections.has(F)),N=T.sort((C,w)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let A=C.text.toLowerCase(),L=w.text.toLowerCase(),R=A.localeCompare(L);return this.sortMode==="alphabetical-asc"?R:-R}return C.lineNumber-w.lineNumber}),P=this.listContainerEl.createDiv({cls:"task-group-container"});D&&(P.style.display="none"),H!==d("emptyStates.noSection")&&x.push(P),N.forEach(C=>{let w;if(C.indentLevel>0){if(!C.date)return;this.cachedAllTasks&&(w=this.cachedAllTasks.find(A=>A.filePath===C.filePath&&A.lineNumber<C.lineNumber&&A.indentLevel<C.indentLevel))}if(this.taskRenderer.createTaskItem(P,C,{searchTerm:e,hideFilename:this.groupingMode!=="date-asc",hideDateBadge:this.groupingMode==="date-asc",parentTask:w,onTaskToggle:async(A,L)=>{await this.handleTaskToggle(A,L)},onTaskClick:(A,L)=>{this.handleTaskClick(A,L)},onFileNameClick:(A,L)=>{this.plugin.app.workspace.openLinkText(A,"")},onFlagToggle:async A=>{await this.handleFlagToggle(A)},onCalendarToggle:async A=>{await this.handleCalendarToggle(A)}}),C.indentLevel===0&&this.cachedAllTasks){let A=this.cachedAllTasks.filter(B=>B.filePath===C.filePath&&B.lineNumber>C.lineNumber&&B.indentLevel>C.indentLevel&&!B.date),L=this.cachedAllTasks.find(B=>B.filePath===C.filePath&&B.lineNumber>C.lineNumber&&B.indentLevel<=C.indentLevel);(L?A.filter(B=>B.lineNumber<L.lineNumber):A).forEach(B=>{this.taskRenderer.createTaskItem(P,B,{searchTerm:e,hideFilename:this.groupingMode!=="date-asc",hideDateBadge:this.groupingMode==="date-asc",onTaskToggle:async(V,O)=>{await this.handleTaskToggle(V,O)},onTaskClick:(V,O)=>{this.handleTaskClick(V,O)},onFileNameClick:(V,O)=>{this.plugin.app.workspace.openLinkText(V,"")},onFlagToggle:async V=>{await this.handleFlagToggle(V)},onCalendarToggle:async V=>{await this.handleCalendarToggle(V)}})})}})})}})}createTaskProgressCircle(t,e,s,n){let i=t.createDiv({cls:"task-progress-circle-container"});if(e===100&&n>0){(0,f.setIcon)(i,"circle-check"),i.addClass("task-progress-complete"),i.setAttribute("aria-label",`${s}/${n} tasks completed`),i.setAttribute("title",`${s}/${n} tasks completed`);return}let a=i.createSvg("svg",{attr:{width:"20",height:"20",viewBox:"0 0 20 20"}}),l=7.5,o=2*Math.PI*l,c=o-e/100*o;a.createSvg("circle",{attr:{cx:"10",cy:"10",r:l.toString(),fill:"none",stroke:"var(--interactive-accent)","stroke-width":"2.5",opacity:"0.2"}}),a.createSvg("circle",{cls:"task-progress-circle",attr:{cx:"10",cy:"10",r:l.toString(),fill:"none",stroke:"var(--interactive-accent)","stroke-width":"2.5","stroke-dasharray":o.toString(),"stroke-dashoffset":c.toString(),"stroke-linecap":"round",transform:"rotate(-90 10 10)"}}),i.setAttribute("aria-label",`${s}/${n} tasks completed`),i.setAttribute("title",`${s}/${n} tasks completed`)}preserveCollapsedSections(){if(!this.listContainerEl)return;let t=this.listContainerEl.querySelectorAll(".task-section-header.collapsed"),e=new Map;t.forEach(s=>{let n=s.getAttribute("data-group-name"),i=s.getAttribute("data-section-id"),a=s.getAttribute("data-section-position-id");n&&(e.has(n)||e.set(n,new Set),i&&e.get(n).add(i),a&&e.get(n).add(a))}),e.forEach((s,n)=>{let i=[];this.collapsedSections.forEach(a=>{a.startsWith(n+"::")&&i.push(a)}),i.forEach(a=>this.collapsedSections.delete(a)),s.forEach(a=>this.collapsedSections.add(a))})}updateGroupProgressCircle(t,e){if(this.groupingMode==="none")return;let s=(0,f.moment)().startOf("day"),n=l=>{if(this.groupingMode==="date-asc")if(l.date){let o=(0,f.moment)(l.date,"YYYY-MM-DD");if(o.isBefore(s)&&!l.completed)return"OVERDUE";let c=o.diff(s,"days");if(c>=0&&c<=6)return l.date;if(o.year()===s.year()&&o.month()===s.month())return`${o.format("YYYY-MM")}-CURRENT-MONTH`;let h=(0,f.moment)(s).add(4,"months").endOf("month");return o.isSameOrBefore(h,"day")?o.format("YYYY-MM"):o.format("YYYY")}else return"No Date";else return this.groupingMode==="filename"?(l.filePath.split("/").pop()||l.filePath).replace(/\.md$/,""):"All Tasks"},i=n(t);this.listContainerEl.querySelectorAll(".highlight-group-header").forEach(l=>{var h,g;let o=(h=l.querySelector("span"))==null?void 0:h.textContent,c=this.getGroupDisplayName(i);if(o&&o.includes(c)){let u=((g=this.currentTasks)==null?void 0:g.filter(S=>n(S)===i))||[],m=u.filter(S=>S.completed).length;t.completed!==e&&(m+=e?1:-1);let p=u.length,y=p>0?m/p*100:0,v=l.querySelector(".task-progress-circle-container");if(v){let S=y===100&&p>0,k=v.classList.contains("task-progress-complete");if(S&&!k)v.empty(),(0,f.setIcon)(v,"circle-check"),v.addClass("task-progress-complete");else if(!S&&k){v.empty(),v.removeClass("task-progress-complete");let I=v.createSvg("svg",{attr:{width:"20",height:"20",viewBox:"0 0 20 20"}}),H=7.5,T=2*Math.PI*H,E=T-y/100*T;I.createSvg("circle",{attr:{cx:"10",cy:"10",r:H.toString(),fill:"none",stroke:"var(--interactive-accent)","stroke-width":"2.5",opacity:"0.2"}}),I.createSvg("circle",{cls:"task-progress-circle",attr:{cx:"10",cy:"10",r:H.toString(),fill:"none",stroke:"var(--interactive-accent)","stroke-width":"2.5","stroke-dasharray":T.toString(),"stroke-dashoffset":E.toString(),"stroke-linecap":"round",transform:"rotate(-90 10 10)"}})}else if(!S&&!k){let I=v.querySelector(".task-progress-circle");if(I){let T=2*Math.PI*7.5,E=T-y/100*T;I.setAttribute("stroke-dashoffset",E.toString())}}v.setAttribute("aria-label",`${m}/${p} tasks completed`),v.setAttribute("title",`${m}/${p} tasks completed`)}}})}getSecondaryGroupKey(t){if(this.taskSecondaryGroupingMode==="tag"){let e=/#([a-zA-Z0-9_/-]+)/g,s=[],n;for(;(n=e.exec(t.text))!==null;)s.push(`#${n[1]}`);return s.length>0?s[0]:d("emptyStates.noTags")}else if(this.taskSecondaryGroupingMode==="date"){if(!t.date)return d("emptyStates.noDate");let e=(0,f.moment)(t.date,"YYYY-MM-DD"),s=(0,f.moment)().startOf("day");return e.isBefore(s)?d("emptyStates.overdue"):e.isSame(s,"day")?d("emptyStates.today"):d("emptyStates.upcoming")}else if(this.taskSecondaryGroupingMode==="flagged")return t.flagged?d("emptyStates.flagged"):d("emptyStates.unflagged");return""}sortSecondaryGroups(t){return t.sort(([e],[s])=>{if(this.taskSecondaryGroupingMode==="tag")return e===d("emptyStates.noTags")&&s===d("emptyStates.noTags")?0:e===d("emptyStates.noTags")?1:s===d("emptyStates.noTags")?-1:e.localeCompare(s);if(this.taskSecondaryGroupingMode==="date"){let n=[d("emptyStates.overdue"),d("emptyStates.today"),d("emptyStates.upcoming"),d("emptyStates.noDate")],i=n.indexOf(e),a=n.indexOf(s);return i-a}else return this.taskSecondaryGroupingMode==="flagged"?e===d("emptyStates.flagged")?-1:s===d("emptyStates.flagged")?1:0:e===d("emptyStates.noSection")&&s===d("emptyStates.noSection")?0:e===d("emptyStates.noSection")?1:s===d("emptyStates.noSection")?-1:e.localeCompare(s)})}async handleTaskToggle(t,e){let s=!t.completed,n=t.indentLevel>0,i=s?"checking":"unchecking";e.addClass(i),n?(0,f.setIcon)(e,s?"circle-check":"circle"):(0,f.setIcon)(e,s?"square-check":"square"),setTimeout(()=>{e.removeClass(i)},s?600:400),this.updateGroupProgressCircle(t,s);try{let l=await this.taskManager.toggleTaskCompletion(t);new f.Notice("Task updated")}catch(l){console.error("[Task Toggle] ERROR",l),e.removeClass(i),n?(0,f.setIcon)(e,t.completed?"circle-check":"circle"):(0,f.setIcon)(e,t.completed?"square-check":"square"),this.updateGroupProgressCircle(t,t.completed),new f.Notice(`Failed to toggle task: ${l.message}`)}}async handleFlagToggle(t,e){let s=new f.Menu;s.addItem(n=>n.setTitle("Priority 1 (High)").setIcon("flag").onClick(async()=>{try{this.updateTaskPriorityInCache(t,1),this.renderContent(),await this.taskManager.setTaskPriority(t,1),new f.Notice("Priority set to 1 (High)")}catch(i){new f.Notice(`Failed to set priority: ${i.message}`),this.cachedAllTasks=null,this.renderContent()}})),s.addItem(n=>n.setTitle("Priority 2 (Medium)").setIcon("flag").onClick(async()=>{try{this.updateTaskPriorityInCache(t,2),this.renderContent(),await this.taskManager.setTaskPriority(t,2),new f.Notice("Priority set to 2 (Medium)")}catch(i){new f.Notice(`Failed to set priority: ${i.message}`),this.cachedAllTasks=null,this.renderContent()}})),s.addItem(n=>n.setTitle("Priority 3 (Low)").setIcon("flag").onClick(async()=>{try{this.updateTaskPriorityInCache(t,3),this.renderContent(),await this.taskManager.setTaskPriority(t,3),new f.Notice("Priority set to 3 (Low)")}catch(i){new f.Notice(`Failed to set priority: ${i.message}`),this.cachedAllTasks=null,this.renderContent()}})),t.priority&&(s.addSeparator(),s.addItem(n=>n.setTitle("Remove priority").setIcon("flag-off").onClick(async()=>{try{this.updateTaskPriorityInCache(t,null),this.renderContent(),await this.taskManager.setTaskPriority(t,null),new f.Notice("Priority removed")}catch(i){new f.Notice(`Failed to remove priority: ${i.message}`),this.cachedAllTasks=null,this.renderContent()}}))),e?s.showAtMouseEvent(e):s.showAtPosition({x:0,y:0})}updateTaskPriorityInCache(t,e){if(this.cachedAllTasks){let s=this.cachedAllTasks.find(n=>n.id===t.id);s&&(s.priority=e!=null?e:void 0,s.flagged=e!==null)}t.priority=e!=null?e:void 0,t.flagged=e!==null}updateTaskDateInCache(t,e,s){if(this.cachedAllTasks){let i=this.cachedAllTasks.find(a=>a.id===t.id);if(i){let a=i.dateText;a&&i.text.includes(a)&&(i.text=i.text.replace(a,"").trim()),s&&e&&(i.text=`${s} ${i.text}`.trim()),i.date=e!=null?e:void 0,i.dateText=s!=null?s:void 0}}let n=t.dateText;n&&t.text.includes(n)&&(t.text=t.text.replace(n,"").trim()),s&&e&&(t.text=`${s} ${t.text}`.trim()),t.date=e!=null?e:void 0,t.dateText=s!=null?s:void 0}async handleCalendarToggle(t){let e=this.plugin.settings.taskDateFormat||"YYYY-MM-DD";t.date?new ft(this.plugin.app,e,t.dateText||"",async n=>{try{let i=null;if(n){let a=(0,f.moment)(n,e,!0);a.isValid()&&(i=a.format("YYYY-MM-DD"))}this.updateTaskDateInCache(t,i,n),this.recentlyMovedTaskId=t.id,this.renderContent(),await this.taskManager.updateTaskDate(t,n),new f.Notice(n?"Date updated":"Date removed")}catch(i){new f.Notice(`Failed to update date: ${i.message}`),this.cachedAllTasks=null,this.recentlyMovedTaskId=null,this.renderContent()}}).open():new ft(this.plugin.app,e,"",async n=>{if(n)try{let i=(0,f.moment)(n,e,!0),a=null;i.isValid()&&(a=i.format("YYYY-MM-DD")),this.updateTaskDateInCache(t,a,n),this.recentlyMovedTaskId=t.id,this.renderContent(),await this.taskManager.updateTaskDate(t,n),new f.Notice("Date added")}catch(i){new f.Notice(`Failed to add date: ${i.message}`),this.cachedAllTasks=null,this.recentlyMovedTaskId=null,this.renderContent()}}).open()}renderTasksWithPagination(t,e){this.totalTasks=t,this.isPreservingPagination||(this.currentTaskPage=0);let s=Math.max(0,Math.ceil(t.length/this.itemsPerPage)-1);this.currentTaskPage>s&&(this.currentTaskPage=s),this.renderCurrentTaskPage(e),this.renderTaskPaginationControls(),this.isPreservingPagination=!1}renderCurrentTaskPage(t){let e=this.currentTaskPage*this.itemsPerPage,s=Math.min(e+this.itemsPerPage,this.totalTasks.length),n=this.totalTasks.slice(e,s);this.listContainerEl.empty(),n.forEach(i=>{let a;if(i.indentLevel>0){if(!i.date)return;this.cachedAllTasks&&(a=this.cachedAllTasks.find(l=>l.filePath===i.filePath&&l.lineNumber<i.lineNumber&&l.indentLevel<i.indentLevel))}if(this.taskRenderer.createTaskItem(this.listContainerEl,i,{searchTerm:t,parentTask:a,onTaskToggle:async(l,o)=>{await this.handleTaskToggle(l,o)},onTaskClick:(l,o)=>{this.handleTaskClick(l,o)},onFileNameClick:(l,o)=>{this.plugin.app.workspace.openLinkText(l,"")},onFlagToggle:async l=>{await this.handleFlagToggle(l)},onCalendarToggle:async l=>{await this.handleCalendarToggle(l)}}),i.indentLevel===0&&this.cachedAllTasks){let l=this.cachedAllTasks.filter(h=>h.filePath===i.filePath&&h.lineNumber>i.lineNumber&&h.indentLevel>i.indentLevel&&!h.date),o=this.cachedAllTasks.find(h=>h.filePath===i.filePath&&h.lineNumber>i.lineNumber&&h.indentLevel<=i.indentLevel);(o?l.filter(h=>h.lineNumber<o.lineNumber):l).forEach(h=>{this.taskRenderer.createTaskItem(this.listContainerEl,h,{searchTerm:t,onTaskToggle:async(g,u)=>{await this.handleTaskToggle(g,u)},onTaskClick:(g,u)=>{this.handleTaskClick(g,u)},onFileNameClick:(g,u)=>{this.plugin.app.workspace.openLinkText(g,"")},onFlagToggle:async g=>{await this.handleFlagToggle(g)},onCalendarToggle:async g=>{await this.handleCalendarToggle(g)}})})}})}renderTaskPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=Math.ceil(this.totalTasks.length/this.itemsPerPage);if(e<=1)return;let s=this.listContainerEl.createDiv({cls:"pagination-controls"}),n=s.createEl("button",{cls:"clickable-icon"});n.disabled=this.currentTaskPage===0,(0,f.setIcon)(n,"chevron-left"),n.addEventListener("click",()=>{this.currentTaskPage>0&&(this.currentTaskPage--,this.renderCurrentTaskPage(this.getSearchTerm()),this.renderTaskPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let i=s.createSpan({text:`${this.currentTaskPage+1}/${e}`,cls:"pagination-info pagination-info-compact"}),a=s.createEl("button",{cls:"clickable-icon"});a.disabled=this.currentTaskPage>=e-1,(0,f.setIcon)(a,"chevron-right"),a.addEventListener("click",()=>{this.currentTaskPage<e-1&&(this.currentTaskPage++,this.renderCurrentTaskPage(this.getSearchTerm()),this.renderTaskPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}handleTaskClick(t,e){this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof f.TFile&&this.plugin.app.workspace.openLinkText(t.filePath,"",!1).then(()=>{let n=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(n){let i=n.editor,a=i.getLine(t.lineNumber),l=a.match(/^(\s*[-*]\s*\[[ xX-]\]\s*)/),o=l?l[1].length:0,c=a.length;i.setSelection({line:t.lineNumber,ch:o},{line:t.lineNumber,ch:c}),i.scrollIntoView({from:{line:t.lineNumber,ch:o},to:{line:t.lineNumber,ch:c}},!0)}})}renderCollectionDetailView(t){this.captureScrollPosition();let e=this.plugin.collectionsManager.getCollection(t);if(!e){new f.Notice("Collection not found"),this.currentCollectionId=null,this.renderContent();return}this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let s=this.plugin.collectionsManager.getHighlightsInCollection(t);s.length===0?this.renderEmptyCollectionState(this.listContainerEl,e):this.renderCollectionHighlights(s),this.showTagActive(),this.restoreScrollPosition()}renderEmptyCollectionState(t,e){this.highlightRenderer.createEmptyState(t,d("emptyStates.noHighlightsInCollection"))}renderCollectionHighlights(t){var n;let e=((n=this.searchInputEl)==null?void 0:n.value.toLowerCase().trim())||"",s=this.applyAllFilters(t);if(s.length===0){let i=e?d("emptyStates.noMatchingInCollection"):d("emptyStates.noHighlightsInCollection");this.highlightRenderer.createEmptyState(this.listContainerEl,i);return}this.groupingMode==="none"?s.sort((a,l)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let o=a.text.toLowerCase(),c=l.text.toLowerCase(),h=o.localeCompare(c);return this.sortMode==="alphabetical-asc"?h:-h}return a.filePath!==l.filePath?a.filePath.localeCompare(l.filePath):a.startOffset-l.startOffset}).forEach(a=>{this.createHighlightItem(this.listContainerEl,a,e,!0)}):this.renderGroupedHighlights(s,e,!0)}renderFilteredList(){if(!this.contentAreaEl||!this.listContainerEl)return;this.captureScrollPosition(),this.contentAreaEl.empty(),this.listContainerEl=this.contentAreaEl.createDiv({cls:"highlights-list"});let t=this.searchInputEl?this.searchInputEl.value.toLowerCase().trim():"";this.listContainerEl.empty();let e;if(this.viewMode==="current"){if(!this.plugin.app.workspace.getActiveFile()){this.highlightRenderer.createEmptyState(this.listContainerEl,d("emptyStates.noFileOpen")),this.restoreScrollPosition(),this.showTagActive();return}e=this.plugin.getCurrentFileHighlights()}else if(this.viewMode==="all"){e=[];for(let[n,i]of this.plugin.highlights)e.push(...i)}else return;e=e.filter(n=>{let i=this.plugin.app.vault.getAbstractFileByPath(n.filePath);return!i||!(i instanceof f.TFile)?!1:this.plugin.shouldProcessFile(i)});let s=this.applyAllFilters(e);if(s.length===0){let n;if(this.viewMode==="current"){let i=this.plugin.app.workspace.getActiveFile();i&&i.extension==="pdf"?n=d("emptyStates.pdfNotSupported"):n=t?d("emptyStates.noMatching"):d("emptyStates.noHighlightsInFile")}else n=t?d("emptyStates.noMatchingAcrossAll"):d("emptyStates.noHighlightsAcrossAll");this.highlightRenderer.createEmptyState(this.listContainerEl,n)}else if(this.groupingMode==="none"){let n=s.sort((i,a)=>{if(this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"){let l=i.text.toLowerCase(),o=a.text.toLowerCase(),c=l.localeCompare(o);return this.sortMode==="alphabetical-asc"?c:-c}return i.filePath!==a.filePath?i.filePath.localeCompare(a.filePath):i.startOffset-a.startOffset});this.viewMode==="all"?this.renderHighlightsWithPagination(n,t):n.forEach(i=>{this.createHighlightItem(this.listContainerEl,i,t,!1)})}else this.viewMode==="all"?this.renderGroupedHighlightsWithPagination(s,t):this.renderGroupedHighlights(s,t,!1);this.showTagActive(),this.restoreScrollPosition()}renderHighlightsWithPagination(t,e){this.totalHighlights=t,this.isPreservingPagination||(this.currentPage=0);let s=Math.max(0,Math.ceil(t.length/this.itemsPerPage)-1);this.currentPage>s&&(this.currentPage=s),this.renderCurrentPage(e),this.renderPaginationControls(),this.isPreservingPagination=!1}renderCurrentPage(t){let e=this.currentPage*this.itemsPerPage,s=Math.min(e+this.itemsPerPage,this.totalHighlights.length),n=this.totalHighlights.slice(e,s);this.listContainerEl.empty(),n.forEach(i=>{this.createHighlightItem(this.listContainerEl,i,t,!0)})}renderPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=Math.ceil(this.totalHighlights.length/this.itemsPerPage);if(e<=1)return;let s=this.listContainerEl.createDiv({cls:"pagination-controls"}),n=s.createEl("button",{cls:"clickable-icon"});n.disabled=this.currentPage===0,(0,f.setIcon)(n,"chevron-left"),n.addEventListener("click",()=>{this.currentPage>0&&(this.currentPage--,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let i=s.createSpan({text:`${this.currentPage+1}/${e}`,cls:"pagination-info pagination-info-compact"}),a=s.createEl("button",{cls:"clickable-icon"});a.disabled=this.currentPage>=e-1,(0,f.setIcon)(a,"chevron-right"),a.addEventListener("click",()=>{this.currentPage<e-1&&(this.currentPage++,this.renderCurrentPage(this.getSearchTerm()),this.renderPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}renderGroupedHighlightsWithPagination(t,e){let s=new Map,n=new Map;t.forEach(o=>{var h;let c;if(this.groupingMode==="color"){let g=o.color||this.plugin.settings.highlightColor;c=g,n.set(c,g)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let g=o.isNativeComment?0:((h=o.footnoteContents)==null?void 0:h.filter(u=>u.trim()!=="").length)||0;c=g===0?"No Comments":g===1?"1 Comment":`${g} Comments`}else if(this.groupingMode==="parent"){let g=o.filePath.split("/");g.length>1?c=g[g.length-2]:c="Root"}else if(this.groupingMode==="collection"){let g=this.plugin.collectionsManager.getAllCollections().filter(u=>u.highlightIds.includes(o.id));g.length===0?c="No Collections":g.length===1?c=g[0].name:c=g.map(u=>u.name).sort().join(", ")}else if(this.groupingMode==="filename")c=(o.filePath.split("/").pop()||o.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(o.createdAt){let g=new Date(o.createdAt),u=g.getFullYear(),m=String(g.getMonth()+1).padStart(2,"0"),p=String(g.getDate()).padStart(2,"0");c=`${u}-${m}-${p}`}else c="No Date";else c="Default";s.has(c)||s.set(c,[]),s.get(c).push(o)});let i=Array.from(s.entries()).map(([o,c])=>{let h;return this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?h=c.sort((g,u)=>{let m=g.createdAt||0,p=u.createdAt||0;return this.groupingMode==="date-created-asc"?m-p:p-m}):this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"?h=c.sort((g,u)=>{let m=g.text.toLowerCase(),p=u.text.toLowerCase(),y=m.localeCompare(p);return this.sortMode==="alphabetical-asc"?y:-y}):h=c.sort((g,u)=>g.startOffset-u.startOffset),[o,h]}).sort(([o],[c])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(o==="No Comments"&&c==="No Comments")return 0;if(o==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(c==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let h=parseInt(o.split(" ")[0])||0,g=parseInt(c.split(" ")[0])||0;return this.groupingMode==="comments-asc"?h-g:g-h}else{if(this.groupingMode==="tag")return o==="No Tags"&&c==="No Tags"?0:o==="No Tags"?1:c==="No Tags"?-1:o.localeCompare(c);if(this.groupingMode==="parent")return o==="Root"&&c==="Root"?0:o==="Root"?-1:c==="Root"?1:o.localeCompare(c);if(this.groupingMode==="collection")return o==="No Collections"&&c==="No Collections"?0:o==="No Collections"?1:c==="No Collections"?-1:o.localeCompare(c);if(this.groupingMode==="filename")return o.localeCompare(c);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(o==="No Date"&&c==="No Date")return 0;if(o==="No Date")return 1;if(c==="No Date")return-1;let h=new Date(o),g=new Date(c);return this.groupingMode==="date-created-asc"?h.getTime()-g.getTime():g.getTime()-h.getTime()}}return o.localeCompare(c)});this.totalGroups=i,this.isPreservingPagination||(this.currentGroupPage=0);let a=i.reduce((o,[,c])=>o+c.length,0),l=Math.max(0,Math.ceil(a/this.itemsPerPage)-1);this.currentGroupPage>l&&(this.currentGroupPage=l),this.renderCurrentGroupPage(e,n),this.renderGroupPaginationControls(),this.isPreservingPagination=!1}renderCurrentGroupPage(t,e){let s=this.currentGroupPage*this.itemsPerPage,n=s+this.itemsPerPage;this.listContainerEl.empty();let i=0,a=0;for(let[l,o]of this.totalGroups){let c=o.length;if(i+c>s&&i<n){let h=Math.max(0,s-i),g=Math.min(c,n-i),u=o.slice(h,g);u.length>0&&(this.renderGroupHeader(l,o,e),u.forEach(m=>{this.createHighlightItem(this.listContainerEl,m,t,!0),a++}))}if(i+=c,i>=n)break}}renderGroupHeader(t,e,s){let n=this.listContainerEl.createDiv({cls:"highlight-group-header"}),i=n.createSpan();if(this.groupingMode==="color"&&(s!=null&&s.has(t))){let S=s.get(t),k=i.createDiv({cls:"group-color-square",attr:{"data-color":S}});k.style.backgroundColor=S}if(this.groupingMode==="tag"){let S=i.createDiv({cls:"group-tag-icon"});(0,f.setIcon)(S,"tag")}let a=i.createSpan();a.textContent=this.getGroupDisplayName(t);let o=n.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),h=new Set(e.map(S=>S.filePath)).size,g=e.filter(S=>S.isNativeComment).length,u=e.filter(S=>!S.isNativeComment).length,m=o.createDiv({cls:"highlight-line-info"}),p=m.createDiv({cls:"line-icon"});if((0,f.setIcon)(p,"highlighter"),m.createSpan({text:`${u}`}),this.showNativeComments){let S=o.createDiv({cls:"highlight-line-info"}),k=S.createDiv({cls:"line-icon"});(0,f.setIcon)(k,"captions"),S.createSpan({text:`${g}`})}let y=o.createDiv({cls:"highlight-line-info"}),v=y.createDiv({cls:"line-icon"});(0,f.setIcon)(v,"files"),y.createSpan({text:`${h}`})}renderSingleGroup(t,e,s,n=!1,i){this.renderGroupHeader(t,e,i);let a;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?a=e.sort((l,o)=>{let c=l.createdAt||0,h=o.createdAt||0;return this.groupingMode==="date-created-asc"?c-h:h-c}):a=e.sort((l,o)=>l.startOffset-o.startOffset),a.forEach(l=>{this.createHighlightItem(this.listContainerEl,l,s,n)})}renderGroupPaginationControls(){let t=this.listContainerEl.querySelector(".pagination-controls");t&&t.remove();let e=this.totalGroups.reduce((o,[,c])=>o+c.length,0),s=Math.ceil(e/this.itemsPerPage);if(s<=1)return;let n=this.listContainerEl.createDiv({cls:"pagination-controls"}),i=n.createEl("button",{cls:"clickable-icon"});i.disabled=this.currentGroupPage===0,(0,f.setIcon)(i,"chevron-left"),i.addEventListener("click",()=>{this.currentGroupPage>0&&(this.currentGroupPage--,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))});let a=n.createSpan({text:`${this.currentGroupPage+1}/${s}`,cls:"pagination-info pagination-info-compact"}),l=n.createEl("button",{cls:"clickable-icon"});l.disabled=this.currentGroupPage>=s-1,(0,f.setIcon)(l,"chevron-right"),l.addEventListener("click",()=>{this.currentGroupPage<s-1&&(this.currentGroupPage++,this.renderCurrentGroupPage(this.getSearchTerm()),this.renderGroupPaginationControls(),requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=0}))})}updateGroupButtonState(t){this.groupingMode==="none"?t.classList.remove("active"):t.classList.add("active")}saveGroupingModeToSettings(){this.saveCurrentTabSettings(),this.plugin.settings.groupingMode=this.groupingMode}updateSecondaryGroupButtonState(t){let e=this.viewMode==="tasks",s=this.groupingMode!=="none";!e||!s?(t.classList.add("disabled"),t.classList.remove("active")):(t.classList.remove("disabled"),this.taskSecondaryGroupingMode==="none"?t.classList.remove("active"):t.classList.add("active"))}saveTaskSecondaryGroupingModeToSettings(){this.plugin.settings.taskSecondaryGroupingMode=this.taskSecondaryGroupingMode,this.plugin.saveSettings()}updateActionsButtonVisibility(){this.actionsButton&&(this.selectedHighlightIds.size>0?this.actionsButton.style.display="":this.actionsButton.style.display="none")}updateHighlightSelectionVisual(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`);if(e)if(this.selectedHighlightIds.has(t)){e.classList.add("selected","highlight-selected");let s=this.getHighlightById(t);if(s){let n=s.color||this.plugin.settings.highlightColor;s.isNativeComment||(e.style.boxShadow=`0 0 0 1.5px ${n}, var(--shadow-s)`)}}else e.classList.remove("selected","highlight-selected"),e.style.boxShadow=""}clearSelection(){this.selectedHighlightIds.clear(),this.containerEl.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("selected","highlight-selected"),e.style.boxShadow=""}),this.updateActionsButtonVisibility()}addSelectedHighlightsToCollection(t){this.selectedHighlightIds.forEach(e=>{this.plugin.collectionsManager.addHighlightToCollection(t,e)}),this.dropdownManager.closeActiveDropdown(),this.clearSelection(),this.renderContent()}removeSelectedHighlightsFromCollection(t){this.selectedHighlightIds.forEach(e=>{this.plugin.collectionsManager.removeHighlightFromCollection(t,e)}),this.dropdownManager.closeActiveDropdown(),this.clearSelection(),this.renderContent()}showActionsMenu(t){if(this.selectedHighlightIds.size===0)return;let e=this.selectedHighlightIds.size,s=this.plugin.collectionsManager.getAllCollections(),n=[];n.push({text:d("actions.moveToCollection"),icon:"folder-plus",className:s.length===0?"highlights-dropdown-item disabled":void 0,onClick:()=>{s.length!==0&&(this.dropdownManager.closeActiveDropdown(),this.showCollectionPickerForAdd(t))}});let i=s.filter(l=>Array.from(this.selectedHighlightIds).some(o=>l.highlightIds.includes(o)));i.length>0&&n.push({text:d("actions.removeFromCollection"),icon:"folder-minus",onClick:()=>{this.dropdownManager.closeActiveDropdown(),this.showCollectionPickerForRemove(t,i)}}),n.push({text:"",separator:!0}),n.push({text:d("actions.clearSelection"),icon:"x",onClick:()=>{this.clearSelection(),this.dropdownManager.closeActiveDropdown()}});let a=t.target;this.dropdownManager.showDropdown(a,n)}showCollectionPickerForAdd(t){let s=this.plugin.collectionsManager.getAllCollections().map(i=>({text:i.name,icon:"folder",onClick:()=>{this.addSelectedHighlightsToCollection(i.id)}})),n=t.target;this.dropdownManager.showDropdown(n,s)}showCollectionPickerForRemove(t,e){let s=e.map(i=>({text:i.name,icon:"folder",onClick:()=>{this.removeSelectedHighlightsFromCollection(i.id)}})),n=t.target;this.dropdownManager.showDropdown(n,s)}updateSortButtonState(t){let e=this.viewMode==="tasks",s=this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc";if((0,f.setIcon)(t,"arrow-up-down"),!e&&s)t.disabled=!0,t.classList.remove("active"),(0,f.setTooltip)(t,d("toolbar.sort"));else if(t.disabled=!1,this.sortMode==="none")t.classList.remove("active"),(0,f.setTooltip)(t,d("toolbar.sort"));else switch(t.classList.add("active"),this.sortMode){case"alphabetical-asc":(0,f.setTooltip)(t,`${d("toolbar.sort")}: ${d("sorting.aToZ")}`);break;case"alphabetical-desc":(0,f.setTooltip)(t,`${d("toolbar.sort")}: ${d("sorting.zToA")}`);break;case"priority":(0,f.setTooltip)(t,`${d("toolbar.sort")}: ${d("sorting.priority")}`);break;case"date-asc":(0,f.setTooltip)(t,`${d("toolbar.sort")}: ${d("sorting.dateEarliestFirst")}`);break;case"date-desc":(0,f.setTooltip)(t,`${d("toolbar.sort")}: ${d("sorting.dateLatestFirst")}`);break;default:(0,f.setTooltip)(t,d("toolbar.sort"))}}saveSortModeToSettings(){this.saveCurrentTabSettings(),this.plugin.settings.sortMode=this.sortMode}createHighlightItem(t,e,s,n=!1){let l={searchTerm:this.currentSearchTokens.filter(o=>o.type==="text"&&!o.exclude).map(o=>o.value).join(" ")||s,showFilename:this.plugin.settings.showFilenames&&n,showTimestamp:this.plugin.settings.showTimestamps,showHighlightActions:this.plugin.settings.showHighlightActions,isCommentsVisible:this.getHighlightCommentsVisibility(e),dateFormat:this.plugin.settings.dateFormat,onCommentToggle:o=>{let c=this.highlightCommentsVisible.get(o)||!1;this.highlightCommentsVisible.set(o,!c),this.rerenderCurrentView()},onCollectionsMenu:(o,c)=>{this.showCollectionsMenu(o,c)},onColorChange:(o,c)=>{this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isColorChanging=!0,window.setTimeout(()=>{this.isColorChanging=!1},2e3),this.changeHighlightColor(o,c),this.rerenderCurrentView(),requestAnimationFrame(()=>{if(this.contentAreaEl&&this.isColorChanging&&(this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isColorChanging=!1,this.plugin.selectedHighlightId)){let h=this.containerEl.querySelector(`[data-highlight-id="${this.plugin.selectedHighlightId}"]`);if(h){let g=this.getHighlightById(this.plugin.selectedHighlightId);if(g){let u=g.color||this.plugin.settings.highlightColor;h.style.borderLeftColor=u,g.isNativeComment||(h.style.boxShadow=`0 0 0 1.5px ${u}, var(--shadow-s)`)}}}})},onHighlightClick:(o,c)=>{c&&(c.metaKey||c.ctrlKey)?(this.selectedHighlightIds.has(o.id)?this.selectedHighlightIds.delete(o.id):this.selectedHighlightIds.add(o.id),this.updateHighlightSelectionVisual(o.id),this.updateActionsButtonVisibility()):this.focusHighlightInEditor(o,c)},onAddComment:async o=>{this.isPreservingPagination=!0,await this.focusHighlightInEditor(o),this.addFootnoteToHighlightWithTargetedUpdate(o)},onCommentClick:(o,c,h)=>{var m;let g=-1,u=0;for(let p=0;p<(((m=o.footnoteContents)==null?void 0:m.length)||0);p++)if(o.footnoteContents[p].trim()!==""){if(u===c){g=p;break}u++}g!==-1&&this.focusFootnoteInEditor(o,g,h)},onTagClick:o=>{this.selectedTags.has(o)?this.selectedTags.delete(o):this.selectedTags.add(o),this.saveCurrentTabSettings(),this.renderFilteredList(),this.showTagActive()},onFileNameClick:(o,c)=>{this.isPreservingPagination=!0,this.plugin.app.workspace.openLinkText(o,o,f.Keymap.isModEvent(c))}};return this.highlightRenderer.createHighlightItem(t,e,l)}rerenderCurrentView(){this.viewMode==="collections"&&this.currentCollectionId?this.renderCollectionDetailView(this.currentCollectionId):this.renderFilteredList()}async addFootnoteToHighlightWithTargetedUpdate(t){let e=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(!e)return;let s=e.editor,n=e.file;if(!n)return;let i=s.getValue(),a=null;if(t.type==="custom"&&t.fullMatch){let l=this.escapeRegex(t.fullMatch),o=new RegExp(l,"g"),c=null,h=1/0,g;for(;(g=o.exec(i))!==null;){let u=Math.abs(g.index-t.startOffset);u<h&&(h=u,c={index:g.index,length:g[0].length})}if(c){let u=c.index+c.length,m=s.offsetToPos(u),y=s.getLine(m.line).substring(m.ch),v=y.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),S=v?v[0].length:0;if(S>0&&y.length>S){let k=y.substring(S);if(!k.match(/^\S/)){let I=k.match(/^(\s+)/);I&&k.substring(I[0].length).length===0&&(S+=I[0].length)}}else if(S>0){let k=y.substring(S).match(/^\s+/);k&&(S+=k[0].length)}a={line:m.line,ch:m.ch+S}}}else if(t.isNativeComment){let o=`%%${this.escapeRegex(t.text)}%%`,c=new RegExp(o,"g"),h=null,g=1/0,u;for(;(u=c.exec(i))!==null;){let m=Math.abs(u.index-t.startOffset);m<g&&(g=m,h={index:u.index,length:u[0].length})}if(h){let m=h.index+h.length,p=s.offsetToPos(m),v=s.getLine(p.line).substring(p.ch),S=v.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),k=S?S[0].length:0;if(k>0&&v.length>k){let I=v.substring(k);if(!I.match(/^\S/)){let H=I.match(/^(\s+)/);H&&I.substring(H[0].length).length===0&&(k+=H[0].length)}}else if(k>0){let I=v.substring(k).match(/^\s+/);I&&(k+=I[0].length)}a={line:p.line,ch:p.ch+k}}}else if(this.isHtmlHighlight(t)){let l=this.plugin.getCodeBlockRanges(i),o=j.findHighlightAtOffset(i,t.text,t.startOffset,l);if(o){let c=o.endOffset,h=s.offsetToPos(c),u=s.getLine(h.line).substring(h.ch),m=u.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),p=m?m[0].length:0;if(p>0&&u.length>p){let y=u.substring(p);if(!y.match(/^\S/)){let v=y.match(/^(\s+)/);v&&y.substring(v[0].length).length===0&&(p+=v[0].length)}}else if(p>0){let y=u.substring(p).match(/^\s+/);y&&(p+=y[0].length)}a={line:h.line,ch:h.ch+p}}}else{let o=`==${this.escapeRegex(t.text)}==`,c=new RegExp(o,"g"),h=null,g=1/0,u;for(;(u=c.exec(i))!==null;){let m=Math.abs(u.index-t.startOffset);m<g&&(g=m,h={index:u.index,length:u[0].length})}if(h){let m=h.index+h.length,p=s.offsetToPos(m),v=s.getLine(p.line).substring(p.ch),S=v.match(/^(\s*(\[\^[a-zA-Z0-9_-]+\]|\^\[[^\]]+\]))*/),k=S?S[0].length:0;if(k>0&&v.length>k){let I=v.substring(k);if(!I.match(/^\S/)){let H=I.match(/^(\s+)/);H&&I.substring(H[0].length).length===0&&(k+=H[0].length)}}else if(k>0){let I=v.substring(k).match(/^\s+/);I&&(k+=I[0].length)}a={line:p.line,ch:p.ch+k}}}if(!a){new f.Notice("Could not find the highlight in the editor. It might have been modified.");return}if(this.plugin.settings.useInlineFootnotes){let l=this.plugin.inlineFootnoteManager.insertInlineFootnote(s,t,"");l.success&&l.insertPos?(setTimeout(()=>{if(l.contentLength>0){let o=l.insertPos.ch+2,c=o+l.contentLength;s.setSelection({line:l.insertPos.line,ch:o},{line:l.insertPos.line,ch:c})}else{let o={line:l.insertPos.line,ch:l.insertPos.ch+2};s.setCursor(o)}s.focus()},50),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,n)},100)):new f.Notice("Could not insert inline footnote.")}else s.setCursor(a),s.focus(),this.plugin.app.commands.executeCommandById("editor:insert-footnote"),setTimeout(async()=>{await this.updateSingleHighlightFromEditor(t,n)},100)}async updateSingleHighlightFromEditor(t,e){let s=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(!s)return;let n=s.editor.getValue(),i=this.plugin.extractFootnotes(n),a=this.findAndParseHighlight(n,t,i);if(a){let l=this.plugin.highlights.get(e.path)||[],o=l.findIndex(c=>c.id===t.id);o!==-1&&(l[o]=a,this.plugin.highlights.set(e.path,l),await this.plugin.saveSettings(),this.updateItem(t.id))}}findAndParseHighlight(t,e,s){let n=e.isNativeComment?new RegExp(`%%${this.escapeRegex(e.text)}%%`,"g"):new RegExp(`==${this.escapeRegex(e.text)}==`,"g"),i;for(;(i=n.exec(t))!==null;)if(Math.abs(i.index-e.startOffset)<100){let a=t.slice(i.index+i[0].length),l=[];this.plugin.inlineFootnoteManager.extractInlineFootnotes(t,i.index+i[0].length).forEach(I=>{I.content.trim()&&l.push({type:"inline",index:I.startIndex,content:I.content.trim()})});let c=new RegExp(nt),h,g=0;for(;(h=c.exec(a))!==null;){let I=a.substring(g,h.index),H=ot.test(I);if(h.index===g||H){let T=h[2];if(s.has(T)){let E=s.get(T).trim();E&&l.push({type:"standard",index:i.index+i[0].length+h.index,content:E})}g=h.index+h[0].length}else break}let u=i.index+i[0].length,m=t.substring(u),p=Z.calculateFootnoteLength(m),y=m.substring(p);if(!/\n\s*\n/.test(y)){let I=y.match(/^\s*(%%([^%](?:[^%]|%[^%])*?)%%)/);if(I){let H=I[2],T=u+p+I.index;H.trim()&&l.push({type:"inline",index:T,content:H.trim()})}if(this.plugin.settings.detectHtmlComments){let H=y.match(/^\s*(<!--([^]*?)-->)/);if(H){let T=H[2],E=u+p+H.index;T.trim()&&l.push({type:"inline",index:E,content:T.trim()})}}for(let H of this.plugin.settings.customPatterns)if(H.type==="comment")try{let T=new RegExp("^\\s*("+H.pattern+")"),E=y.match(T);if(E&&E[2]){let x=E[2],M=u+p+E.index;x.trim()&&l.push({type:"inline",index:M,content:x.trim()})}}catch(T){}}l.sort((I,H)=>I.index-H.index);let S=l.map(I=>I.content),k=S.length;return{...e,footnoteCount:k,footnoteContents:S,startOffset:i.index,endOffset:i.index+i[0].length}}return null}async focusHighlightInEditor(t,e){var o;this.isPreservingPagination=!0,this.containerEl.querySelectorAll(".selected, .highlight-selected").forEach(c=>{c.classList.remove("selected","highlight-selected"),c.style.removeProperty("border-left-color"),c.style.removeProperty("box-shadow")});let n=this.plugin.selectedHighlightId;this.plugin.selectedHighlightId=t.id;let i=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(i){i.classList.add("selected");let c=this.plugin.highlights.get(t.filePath),h=c==null?void 0:c.find(g=>g.id===t.id);if(h){i.classList.add("highlight-selected");let g=h.color||this.plugin.settings.highlightColor;i.style.borderLeftColor=g,h.isNativeComment||(i.style.boxShadow=`0 0 0 1.5px ${g}, var(--shadow-s)`)}}if(this.isHighlightFocusing)return;this.preservedScrollTop=this.contentAreaEl.scrollTop,this.isHighlightFocusing=!0,window.setTimeout(()=>{this.isHighlightFocusing=!1},2e3);let a=null,l=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(l&&l.file&&l.file.path===t.filePath)a=l;else{let c=this.plugin.app.workspace.getLeavesOfType("markdown");for(let h of c)if(h.view instanceof f.MarkdownView&&((o=h.view.file)==null?void 0:o.path)===t.filePath){a=h.view,this.plugin.app.workspace.setActiveLeaf(h,{focus:!0});break}}if(!a&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof f.TFile){let h=await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,e?f.Keymap.isModEvent(e):!1);return new Promise(g=>{let u=()=>{var p;let m=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);m&&((p=m.file)==null?void 0:p.path)===t.filePath?(this.performHighlightFocus(m,t),g()):window.setTimeout(u,50)};window.setTimeout(u,100)})}a&&requestAnimationFrame(()=>{this.performHighlightFocus(a,t)})}isHtmlHighlight(t){return t.type==="html"}performHighlightFocus(t,e){if(!t||!t.editor)return;this.contentAreaEl.scrollTop!==this.preservedScrollTop?requestAnimationFrame(()=>{this.contentAreaEl.scrollTop=this.preservedScrollTop,this.isHighlightFocusing=!1}):this.isHighlightFocusing=!1;let n=t.editor.getValue(),i=[];if(e.type==="custom"&&e.fullMatch){let g=this.escapeRegex(e.fullMatch),u=new RegExp(g,"g"),m;for(;(m=u.exec(n))!==null;){let p=m[0],y=p.indexOf(e.text);i.push({index:m.index,length:p.length,tagStartLength:y>=0?y:0,tagEndLength:y>=0?p.length-y-e.text.length:0})}}else if(e.isNativeComment){let g=`<!--\\s*${this.escapeRegex(e.text)}\\s*-->`,u=new RegExp(g,"g"),m;for(;(m=u.exec(n))!==null;){let p=m[0],y=p.indexOf(e.text);i.push({index:m.index,length:p.length,tagStartLength:y,tagEndLength:p.length-y-e.text.length})}if(i.length===0){let p=`%%${this.escapeRegex(e.text)}%%`,y=new RegExp(p,"g");for(;(m=y.exec(n))!==null;)i.push({index:m.index,length:m[0].length,tagStartLength:2,tagEndLength:2})}if(i.length===0){for(let p of this.plugin.settings.customPatterns)if(p.type==="comment"){try{let y=new RegExp(p.pattern,"g");for(;(m=y.exec(n))!==null;){let v=m[0],S=m[1]||"";if(S===e.text){let k=v.indexOf(S);i.push({index:m.index,length:v.length,tagStartLength:k,tagEndLength:v.length-k-S.length})}}}catch(y){console.error(`Error matching custom pattern "${p.name}":`,y)}if(i.length>0)break}}}else if(this.isHtmlHighlight(e)){let g=this.plugin.getCodeBlockRanges(n),u=j.findHighlightAtOffset(n,e.text,e.startOffset,g);if(u){let m=u.fullMatch,p=m.lastIndexOf(e.text),y=p,v=m.length-p-e.text.length;i.push({index:u.startOffset,length:u.endOffset-u.startOffset,tagStartLength:y,tagEndLength:v})}}else{let g=`==${this.escapeRegex(e.text)}==`,u=new RegExp(g,"g"),m;for(;(m=u.exec(n))!==null;)i.push({index:m.index,length:m[0].length,tagStartLength:2,tagEndLength:2});if(i.length===0){for(let p of this.plugin.settings.customPatterns)if(p.type==="highlight"){try{let y=new RegExp(p.pattern,"g");for(;(m=y.exec(n))!==null;){let v=m[0],S=m[1]||"";if(S===e.text){let k=v.indexOf(S);i.push({index:m.index,length:v.length,tagStartLength:k,tagEndLength:v.length-k-S.length})}}}catch(y){console.error(`Error matching custom pattern "${p.name}":`,y)}if(i.length>0)break}}}if(i.length===0)return;let a=i[0],l=1/0,o=!1;for(let g of i){let u=Math.abs(g.index-e.startOffset);u<l&&(l=u,a=g,o=!0)}!o||l>50;let c=t.editor.offsetToPos(a.index+a.tagStartLength),h=t.editor.offsetToPos(a.index+a.length-a.tagEndLength);if(t.editor.setSelection(c,h),this.plugin.settings.autoToggleFold)try{this.plugin.app.commands.executeCommandById("editor:toggle-fold")}catch(g){console.warn("Failed to execute toggle fold command:",g)}t.editor.scrollIntoView({from:c,to:h},!0),t.editor.focus()}focusHighlight(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t}"]`)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async focusFootnoteInEditor(t,e,s){var a;let n=null,i=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(i&&i.file&&i.file.path===t.filePath)n=i;else{let l=this.plugin.app.workspace.getLeavesOfType("markdown");for(let o of l)if(o.view instanceof f.MarkdownView&&((a=o.view.file)==null?void 0:a.path)===t.filePath){n=o.view,this.plugin.app.workspace.setActiveLeaf(o,{focus:!0});break}}if(!n&&this.plugin.app.vault.getAbstractFileByPath(t.filePath)instanceof f.TFile){await this.plugin.app.workspace.openLinkText(t.filePath,t.filePath,s?f.Keymap.isModEvent(s):!1),window.setTimeout(()=>this.focusFootnoteInEditor(t,e,s),200);return}window.setTimeout(()=>{let l=this.plugin.app.workspace.getActiveViewOfType(f.MarkdownView);if(!l||!l.editor){new f.Notice("Could not access the editor.");return}let o=l.editor,c=o.getValue(),h=this.escapeRegex(t.text),g=null,u=1/0;if(t.type==="custom"&&t.fullMatch){let F=this.escapeRegex(t.fullMatch),D=new RegExp(F,"g"),N;for(;(N=D.exec(c))!==null;){let P=Math.abs(N.index-t.startOffset);P<u&&(u=P,g={index:N.index,length:N[0].length})}}else if(t.isNativeComment){let F=`%%${h}%%`,D=new RegExp(F,"g"),N;for(;(N=D.exec(c))!==null;){let P=Math.abs(N.index-t.startOffset);P<u&&(u=P,g={index:N.index,length:N[0].length})}}else if(this.isHtmlHighlight(t)){let F=this.plugin.getCodeBlockRanges(c),D=j.findHighlightAtOffset(c,t.text,t.startOffset,F);D&&(g={index:D.startOffset,length:D.endOffset-D.startOffset},u=0)}else{let F=`==${h}==`,D=new RegExp(F,"g"),N;for(;(N=D.exec(c))!==null;){let P=Math.abs(N.index-t.startOffset);P<u&&(u=P,g={index:N.index,length:N[0].length})}}if(!g){new f.Notice("Could not find the highlight in the editor.");return}let m=new Z,p=c.substring(g.index+g.length),y=[];m.extractInlineFootnotes(c,g.index+g.length).forEach(F=>{y.push({type:"inline",content:F.content,startIndex:F.startIndex,endIndex:F.endIndex})});let S=/<!--([^]*?)-->/g,k;for(;(k=S.exec(p))!==null;){let F=k[1].trim();y.push({type:"inline",content:F,startIndex:g.index+g.length+k.index,endIndex:g.index+g.length+k.index+k[0].length})}let I=/%%([^%](?:[^%]|%[^%])*?)%%/g,H;for(;(H=I.exec(p))!==null;){let F=H[1].trim();y.push({type:"inline",content:F,startIndex:g.index+g.length+H.index,endIndex:g.index+g.length+H.index+H[0].length})}for(let F of this.plugin.settings.customPatterns)if(F.type==="comment")try{let D=new RegExp(F.pattern,"g"),N;for(;(N=D.exec(p))!==null;){let P=N[1];P&&P.trim()&&y.push({type:"inline",content:P.trim(),startIndex:g.index+g.length+N.index,endIndex:g.index+g.length+N.index+N[0].length})}}catch(D){console.error(`Error processing custom pattern "${F.name}":`,D)}let T=new RegExp(nt),E,x=0;for(;(E=T.exec(p))!==null;){let F=p.substring(x,E.index),D=ot.test(F);if(E.index===x||D)y.push({type:"standard",content:E[2],startIndex:g.index+g.length+E.index,endIndex:g.index+g.length+E.index+E[0].length}),x=E.index+E[0].length;else break}if(y.sort((F,D)=>F.startIndex-D.startIndex),y.length===0){new f.Notice("No footnotes found for this highlight.");return}if(e>=y.length){new f.Notice("Footnote index out of range.");return}let M=y[e];if(M.type==="inline"){let F=c.substring(M.startIndex,M.endIndex);if(F.startsWith("<!--")&&F.endsWith("-->")){let D=M.startIndex,N=o.offsetToPos(D);if(this.plugin.settings.selectTextOnCommentClick){let P=M.startIndex+4,C=M.endIndex-3,w=o.offsetToPos(P),A=o.offsetToPos(C);o.scrollIntoView({from:w,to:A},!0),o.setSelection(w,A),o.focus()}else o.scrollIntoView({from:N,to:N},!0),o.setCursor(N),o.focus()}else if(F.startsWith("%%")&&F.endsWith("%%")){let D=M.startIndex,N=o.offsetToPos(D);if(this.plugin.settings.selectTextOnCommentClick){let P=M.startIndex+2,C=M.endIndex-2,w=o.offsetToPos(P),A=o.offsetToPos(C);o.scrollIntoView({from:w,to:A},!0),o.setSelection(w,A),o.focus()}else o.scrollIntoView({from:N,to:N},!0),o.setCursor(N),o.focus()}else{let D=!1;for(let N of this.plugin.settings.customPatterns)if(N.type==="comment")try{let C=new RegExp(N.pattern).exec(F);if(C&&C[1]){D=!0;let w=M.startIndex,A=o.offsetToPos(w);if(this.plugin.settings.selectTextOnCommentClick){let L=F.indexOf(C[1]),R=L+C[1].length,B=M.startIndex+L,V=M.startIndex+R,O=o.offsetToPos(B),z=o.offsetToPos(V);o.scrollIntoView({from:O,to:z},!0),o.setSelection(O,z),o.focus()}else o.scrollIntoView({from:A,to:A},!0),o.setCursor(A),o.focus();break}}catch(P){console.error(`Error matching custom pattern "${N.name}":`,P)}if(!D){let N=F.indexOf("^"),P=M.startIndex+N,C=o.offsetToPos(P);if(this.plugin.settings.selectTextOnCommentClick){let w=M.startIndex+F.indexOf("[")+1,A=M.startIndex+F.lastIndexOf("]"),L=o.offsetToPos(w),R=o.offsetToPos(A);o.scrollIntoView({from:L,to:R},!0),o.setSelection(L,R),o.focus()}else o.scrollIntoView({from:C,to:C},!0),o.setCursor(C),o.focus()}}}else{let F=M.content,D=new RegExp(`^\\[\\^${this.escapeRegex(F)}\\]:\\s*(.+)$`,"m"),N=c.match(D);if(!N){new f.Notice("Could not find footnote definition.");return}let P=c.indexOf(N[0]),C=o.offsetToPos(P);if(this.plugin.settings.selectTextOnCommentClick){let w=N[1],A=P+N[0].indexOf(w),L=A+w.length,R=o.offsetToPos(A),B=o.offsetToPos(L);o.scrollIntoView({from:R,to:B},!0),o.setSelection(R,B),o.focus()}else o.scrollIntoView({from:C,to:C},!0),o.setCursor(C),o.focus()}},150)}changeHighlightColor(t,e){this.plugin.updateHighlight(t.id,{color:e||void 0},t.filePath)}getColorName(t){let e=this.plugin.settings.customColorNames,s=this.plugin.settings.customColors;return t===s.yellow&&e.yellow.trim()?e.yellow.trim():t===s.red&&e.red.trim()?e.red.trim():t===s.teal&&e.teal.trim()?e.teal.trim():t===s.blue&&e.blue.trim()?e.blue.trim():t===s.green&&e.green.trim()?e.green.trim():t}getGroupDisplayName(t){switch(t){case"No Comments":return d("emptyStates.noComments");case"No Tags":return d("emptyStates.noTags");case"Root":return d("emptyStates.root");case"No Collections":return d("emptyStates.noCollections");case"No Date":return d("emptyStates.noDate");case"No section":return d("emptyStates.noSection");case"All Tasks":return d("emptyStates.allTasks");case"Default":return d("emptyStates.default");case"OVERDUE":return d("emptyStates.overdue");default:if(this.groupingMode==="color")return this.getColorName(t);if(this.groupingMode==="date-asc"||this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(t.endsWith("-CURRENT-MONTH")){let e=t.replace("-CURRENT-MONTH",""),s=(0,f.moment)(e,"YYYY-MM"),i=(0,f.moment)().startOf("day").date()+7,a=s.endOf("month").date();return`${s.format("MMMM")} ${i}-${a}`}if(/^\d{4}-\d{2}$/.test(t))return(0,f.moment)(t,"YYYY-MM").format("MMMM");if(/^\d{4}$/.test(t))return t;if(/^\d{4}-\d{2}-\d{2}$/.test(t)){let e=(0,f.moment)(t,"YYYY-MM-DD"),s=(0,f.moment)().startOf("day"),n=e.diff(s,"days");return n===0?d("emptyStates.today"):n===1?d("dateSuggestions.tomorrow"):n>=2&&n<=6?e.format("dddd"):e.format("MMM DD")}}return t}}renderGroupedHighlights(t,e,s=!1){let n=new Map,i=new Map;t.forEach(l=>{var c;let o;if(this.groupingMode==="color"){let h=l.color||this.plugin.settings.highlightColor;o=h,i.set(o,h)}else if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){let h=l.isNativeComment?0:((c=l.footnoteContents)==null?void 0:c.filter(g=>g.trim()!=="").length)||0;o=h===0?"No Comments":h===1?"1 Comment":`${h} Comments`}else if(this.groupingMode==="parent"){let h=l.filePath.split("/");h.length>1?o=h[h.length-2]:o="Root"}else if(this.groupingMode==="collection"){let h=this.plugin.collectionsManager.getAllCollections().filter(g=>g.highlightIds.includes(l.id));h.length===0?o="No Collections":h.length===1?o=h[0].name:o=h.map(g=>g.name).sort().join(", ")}else if(this.groupingMode==="filename")o=(l.filePath.split("/").pop()||l.filePath).replace(/\.md$/,"");else if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc")if(l.createdAt){let h=new Date(l.createdAt),g=h.getFullYear(),u=String(h.getMonth()+1).padStart(2,"0"),m=String(h.getDate()).padStart(2,"0");o=`${g}-${u}-${m}`}else o="No Date";else o="Default";n.has(o)||n.set(o,[]),n.get(o).push(l)}),Array.from(n.entries()).sort(([l],[o])=>{if(this.groupingMode==="comments-asc"||this.groupingMode==="comments-desc"){if(l==="No Comments"&&o==="No Comments")return 0;if(l==="No Comments")return this.groupingMode==="comments-asc"?-1:1;if(o==="No Comments")return this.groupingMode==="comments-asc"?1:-1;let c=parseInt(l.split(" ")[0])||0,h=parseInt(o.split(" ")[0])||0;return this.groupingMode==="comments-asc"?c-h:h-c}else{if(this.groupingMode==="tag")return l==="No Tags"&&o==="No Tags"?0:l==="No Tags"?1:o==="No Tags"?-1:l.localeCompare(o);if(this.groupingMode==="parent")return l==="Root"&&o==="Root"?0:l==="Root"?-1:o==="Root"?1:l.localeCompare(o);if(this.groupingMode==="collection")return l==="No Collections"&&o==="No Collections"?0:l==="No Collections"?1:o==="No Collections"?-1:l.localeCompare(o);if(this.groupingMode==="filename")return l.localeCompare(o);if(this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"){if(l==="No Date"&&o==="No Date")return 0;if(l==="No Date")return 1;if(o==="No Date")return-1;let c=new Date(l),h=new Date(o);return this.groupingMode==="date-created-asc"?c.getTime()-h.getTime():h.getTime()-c.getTime()}}return l.localeCompare(o)}).forEach(([l,o])=>{let c=this.listContainerEl.createDiv({cls:"highlight-group-header"}),h=c.createSpan();if(this.groupingMode==="color"&&i.has(l)){let x=i.get(l),M=h.createDiv({cls:"group-color-square",attr:{"data-color":x}});M.style.backgroundColor=x}if(this.groupingMode==="tag"){let x=h.createDiv({cls:"group-tag-icon"});(0,f.setIcon)(x,"tag")}let g=h.createSpan();g.textContent=this.getGroupDisplayName(l);let m=c.createDiv({cls:"collection-stats"}).createEl("small",{cls:"collection-info-line"}),y=new Set(o.map(x=>x.filePath)).size,v=o.filter(x=>x.isNativeComment).length,S=o.filter(x=>!x.isNativeComment).length,k=m.createDiv({cls:"highlight-line-info"}),I=k.createDiv({cls:"line-icon"});if((0,f.setIcon)(I,"highlighter"),k.createSpan({text:`${S}`}),this.showNativeComments){let x=m.createDiv({cls:"highlight-line-info"}),M=x.createDiv({cls:"line-icon"});(0,f.setIcon)(M,"captions"),x.createSpan({text:`${v}`})}let H=m.createDiv({cls:"highlight-line-info"}),T=H.createDiv({cls:"line-icon"});(0,f.setIcon)(T,"file-text"),H.createSpan({text:`${y}`});let E;this.groupingMode==="date-created-asc"||this.groupingMode==="date-created-desc"?E=o.sort((x,M)=>{let F=x.createdAt||0,D=M.createdAt||0;return this.groupingMode==="date-created-asc"?F-D:D-F}):this.sortMode==="alphabetical-asc"||this.sortMode==="alphabetical-desc"?E=o.sort((x,M)=>{let F=x.text.toLowerCase(),D=M.text.toLowerCase(),N=F.localeCompare(D);return this.sortMode==="alphabetical-asc"?N:-N}):E=o.sort((x,M)=>x.startOffset-M.startOffset),E.forEach(x=>{this.createHighlightItem(this.listContainerEl,x,e,s)})})}updateCommentsToggleIcon(t){t.empty();let s=this.areCommentsGloballyExpanded()?"chevrons-down-up":"chevrons-up-down";(0,f.setIcon)(t,s)}expandAllCommentsInMap(){let t=[];for(let[,e]of this.plugin.highlights)t.push(...e);t.forEach(e=>{var n;if(e.isNativeComment)return;(((n=e.footnoteContents)==null?void 0:n.filter(i=>i.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(e.id,!0)})}collapseAllCommentsInMap(){let t=[];for(let[,e]of this.plugin.highlights)t.push(...e);t.forEach(e=>{var n;if(e.isNativeComment)return;(((n=e.footnoteContents)==null?void 0:n.filter(i=>i.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(e.id,!1)})}toggleAllComments(){let t=[];for(let[,n]of this.plugin.highlights)t.push(...n);let s=!this.areCommentsGloballyExpanded();t.forEach(n=>{var a;if(n.isNativeComment)return;(((a=n.footnoteContents)==null?void 0:a.filter(l=>l.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.set(n.id,s)}),this.commentsExpanded=s,this.saveCurrentTabSettings()}areCommentsGloballyExpanded(){let t=[];for(let[,e]of this.plugin.highlights)t.push(...e);return t.some(e=>{var n;return e.isNativeComment?!1:(((n=e.footnoteContents)==null?void 0:n.filter(i=>i.trim()!=="").length)||0)>0&&this.highlightCommentsVisible.get(e.id)})}getHighlightCommentsVisibility(t){var s;let e=this.highlightCommentsVisible.get(t.id);if(e!==void 0)return e;if(!t.isNativeComment&&(((s=t.footnoteContents)==null?void 0:s.filter(i=>i.trim()!=="").length)||0)>0){let i=this.areCommentsGloballyExpanded();return this.highlightCommentsVisible.set(t.id,i),i}return!1}resetAllColors(){let t;if(this.viewMode==="current")t=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all"){t=[];for(let[,s]of this.plugin.highlights)t.push(...s)}else this.viewMode==="collections"&&this.currentCollectionId?t=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId):t=[];let e=!1;t.forEach(s=>{if(s.color){let n=this.plugin.highlights.get(s.filePath);if(n){let i=n.find(a=>a.id===s.id);if(i&&i.color){let a={...i,color:void 0},l=n.indexOf(i);n[l]=a,this.plugin.highlights.set(s.filePath,[...n]),e=!0}}}}),e&&(this.plugin.saveSettings(),this.renderContent())}extractTagsFromHighlight(t){let e=[];if(t.footnoteContents){for(let s of t.footnoteContents)if(s.trim()!==""){let n=s.match(/#[\p{L}\p{N}\p{M}_/-]+/gu);n&&n.forEach(i=>{let a=i.substring(1);e.includes(a)||e.push(a)})}}return e}getAllTagsInFile(){let t=new Set;if(this.viewMode==="current")this.plugin.getCurrentFileHighlights().forEach(s=>{this.extractTagsFromHighlight(s).forEach(i=>t.add(i))});else if(this.viewMode==="all")for(let[e,s]of this.plugin.highlights)s.forEach(n=>{this.extractTagsFromHighlight(n).forEach(a=>t.add(a))});else if(this.viewMode==="collections"&&this.currentCollectionId)this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId).forEach(s=>{this.extractTagsFromHighlight(s).forEach(i=>t.add(i))});else if(this.viewMode==="tasks"){let e=/#([a-zA-Z0-9_/-]+)/g;this.currentTasks&&this.currentTasks.forEach(s=>{let n,i=new RegExp(e);for(;(n=i.exec(s.text))!==null;)t.add(n[1])})}return Array.from(t).sort((e,s)=>e.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"}))}getAllCollectionsInCurrentScope(){let t=new Set,e=[];if(this.viewMode==="current")e=this.plugin.getCurrentFileHighlights();else if(this.viewMode==="all")for(let[n,i]of this.plugin.highlights)e.push(...i);else this.viewMode==="collections"&&this.currentCollectionId&&(e=this.plugin.collectionsManager.getHighlightsInCollection(this.currentCollectionId));return e.forEach(n=>{this.plugin.collectionsManager.getCollectionsForHighlight(n.id).forEach(a=>{t.add(a.id)})}),this.plugin.collectionsManager.getAllCollections().filter(n=>t.has(n.id))}getAvailableSpecialFilters(){let t=[];if(this.viewMode!=="tasks"||!this.currentTasks)return t;let e=(0,f.moment)().startOf("day");return this.currentTasks.some(h=>h.flagged)&&t.push({id:"flagged",label:d("filterMenu.flagged"),icon:"flag"}),this.currentTasks.some(h=>h.date?(0,f.moment)(h.date,"YYYY-MM-DD").isAfter(e):!1)&&t.push({id:"upcoming",label:d("filterMenu.upcoming"),icon:"calendar-arrow-up"}),this.currentTasks.some(h=>h.completed)&&t.push({id:"completed",label:d("filterMenu.completed"),icon:"check-circle"}),this.currentTasks.some(h=>!h.completed)&&t.push({id:"incomplete",label:d("filterMenu.incomplete"),icon:"circle"}),this.currentTasks.some(h=>h.date?(0,f.moment)(h.date,"YYYY-MM-DD").isSame(e,"day"):!1)&&t.push({id:"due-today",label:d("filterMenu.dueToday"),icon:"calendar-check"}),this.currentTasks.some(h=>h.date?(0,f.moment)(h.date,"YYYY-MM-DD").isBefore(e)&&!h.completed:!1)&&t.push({id:"overdue",label:d("filterMenu.overdue"),icon:"calendar-x"}),this.currentTasks.some(h=>!h.date)&&t.push({id:"no-date",label:d("filterMenu.noDate"),icon:"calendar-off"}),t}getNoteDateFilters(){return[{id:"created-last-7-days",label:d("filterMenu.last7Days"),icon:"calendar-days"},{id:"created-last-30-days",label:d("filterMenu.last30Days"),icon:"calendar-range"},{id:"created-last-year",label:d("filterMenu.lastYear"),icon:"calendar-clock"}]}showTagFilterMenu(t){let e=this.getAllTagsInFile(),s=this.getAllCollectionsInCurrentScope(),n=this.getAvailableSpecialFilters(),i=this.viewMode==="tasks"?this.getNoteDateFilters():[];if(e.length===0&&s.length===0&&n.length===0&&i.length===0){new f.Notice(d("emptyStates.noTagsOrFilters"));return}let a=s.sort((h,g)=>h.name.localeCompare(g.name,void 0,{numeric:!0,sensitivity:"base"})),l=[{text:d("filterMenu.clear"),icon:"x",className:"highlights-dropdown-clear",onClick:()=>{this.selectedTags.clear(),this.selectedCollections.clear(),this.selectedSpecialFilters.clear(),this.saveCurrentTabSettings(),this.renderContent(),this.showTagActive()}}],o=n.filter(h=>h.id==="flagged"||h.id==="completed"||h.id==="incomplete"),c=n.filter(h=>h.id==="overdue"||h.id==="due-today"||h.id==="upcoming"||h.id==="no-date");o.length>0&&l.push({id:"category-status",text:"Status",icon:"list-checks",expandable:!0,expanded:!1,children:o.map(h=>({id:`special-${h.id}`,text:h.label,uncheckedIcon:h.icon,checked:this.selectedSpecialFilters.has(h.id),onClick:()=>{this.selectedSpecialFilters.has(h.id)?this.selectedSpecialFilters.delete(h.id):this.selectedSpecialFilters.add(h.id),this.saveCurrentTabSettings(),this.renderContent(),this.showTagActive()}}))}),c.length>0&&l.push({id:"category-due-date",text:"Due Date",icon:"calendar",expandable:!0,expanded:!1,children:c.map(h=>({id:`special-${h.id}`,text:h.label,uncheckedIcon:h.icon,checked:this.selectedSpecialFilters.has(h.id),onClick:()=>{this.selectedSpecialFilters.has(h.id)?this.selectedSpecialFilters.delete(h.id):this.selectedSpecialFilters.add(h.id),this.saveCurrentTabSettings(),this.renderContent(),this.showTagActive()}}))}),i.length>0&&l.push({id:"category-note-created",text:d("filterMenu.noteCreated"),icon:"file-clock",expandable:!0,expanded:!1,children:i.map(h=>({id:`special-${h.id}`,text:h.label,uncheckedIcon:h.icon,checked:this.selectedSpecialFilters.has(h.id),onClick:()=>{this.selectedSpecialFilters.has(h.id)?this.selectedSpecialFilters.delete(h.id):this.selectedSpecialFilters.add(h.id),this.saveCurrentTabSettings(),this.renderContent(),this.showTagActive()}}))}),e.length>0&&l.push({id:"category-tags",text:"Tags",icon:"tag",expandable:!0,expanded:!1,children:e.map(h=>({id:`tag-${h}`,text:`#${h}`,uncheckedIcon:"tag",checked:this.selectedTags.has(h),onClick:()=>{this.selectedTags.has(h)?this.selectedTags.delete(h):this.selectedTags.add(h),this.renderContent(),this.showTagActive()}}))}),a.length>0&&l.push({id:"category-collections",text:"Collections",icon:"folder-open",expandable:!0,expanded:!1,children:a.map(h=>({id:`collection-${h.id}`,text:h.name,uncheckedIcon:"folder-open",checked:this.selectedCollections.has(h.name),onClick:()=>{this.selectedCollections.has(h.name)?this.selectedCollections.delete(h.name):this.selectedCollections.add(h.name),this.renderContent(),this.showTagActive()}}))}),this.dropdownManager.showDropdown(t.currentTarget,l)}showCollectionsMenu(t,e){let s=this.plugin.collectionsManager.getAllCollections(),n=[{text:d("filterMenu.clear"),icon:"x",className:"highlights-dropdown-clear",onClick:()=>{s.forEach(a=>{this.plugin.collectionsManager.removeHighlightFromCollection(a.id,e.id)}),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent();let i={};s.forEach(a=>{i[`collection-${a.id}`]=!1}),this.dropdownManager.updateAllCheckboxStates(i)}},{text:d("toolbar.newCollection"),icon:"plus",className:"highlights-dropdown-clear",onClick:()=>{this.showNewCollectionDialog(e.id)}}];s.length>0?n.push(...s.map(i=>({id:`collection-${i.id}`,text:i.name,uncheckedIcon:"folder-open",checked:i.highlightIds.includes(e.id),onClick:()=>{i.highlightIds.includes(e.id)?(this.plugin.collectionsManager.removeHighlightFromCollection(i.id,e.id),this.updateHighlightCollectionCount(e),this.viewMode==="collections"&&this.currentCollectionId===i.id&&this.renderContent(),this.groupingMode==="collection"&&this.renderContent()):(this.plugin.collectionsManager.addHighlightToCollection(i.id,e.id),this.updateHighlightCollectionCount(e),this.groupingMode==="collection"&&this.renderContent())}}))):n.push({text:d("emptyStates.noCollectionsAvailable"),className:"highlights-dropdown-empty",onClick:()=>{}}),this.dropdownManager.showDropdown(t.currentTarget,n)}updateCollectionNavButton(t){t.empty(),this.viewMode==="collections"&&this.currentCollectionId?((0,f.setIcon)(t,"arrow-left"),(0,f.setTooltip)(t,d("toolbar.backToCollections")),t.classList.add("active","collection-nav-back")):((0,f.setIcon)(t,"folder-plus"),(0,f.setTooltip)(t,d("toolbar.newCollection")),t.classList.remove("active","collection-nav-back"))}toggleSearch(){var e;if(!this.plugin.settings.showToolbar)return;this.searchExpanded=!this.searchExpanded;let t=this.contentEl.querySelector(".highlights-search-input-container");t&&(this.searchExpanded?(t.classList.remove("sh-hidden"),this.searchButton.classList.add("active"),(0,f.setIcon)(this.searchButton,"x"),(0,f.setTooltip)(this.searchButton,d("toolbar.closeSearch")),window.setTimeout(()=>this.searchInputEl.focus(),100)):(t.classList.add("sh-hidden"),this.searchButton.classList.remove("active"),(0,f.setIcon)(this.searchButton,"search"),(0,f.setTooltip)(this.searchButton,d("toolbar.search")),(e=this.simpleSearchManager)==null||e.clear(),this.currentSearchTokens=[],this.currentParsedSearch={ast:null},this.renderContent()),this.saveCurrentTabSettings())}enableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.remove("disabled"),this.searchInputEl&&this.searchInputEl.classList.remove("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((e,s)=>{let n=s===t.length-1,i=s===3,a=s===4,l=s===5;this.viewMode==="collections"&&!this.currentCollectionId&&!n&&!i||this.viewMode==="tasks"&&(i||a||l)?e.classList.add("disabled"):e.classList.remove("disabled")}),this.collectionNavButton&&this.updateCollectionNavButton(this.collectionNavButton)}disableSearchAndToolbar(){if(!this.plugin.settings.showToolbar)return;this.searchButton&&this.searchButton.classList.add("disabled"),this.searchInputEl&&this.searchInputEl.classList.add("disabled");let t=this.contentEl.querySelectorAll(".highlights-search-container button");t.forEach((e,s)=>{s===t.length-1?e.classList.remove("disabled"):e.classList.add("disabled")}),this.collectionNavButton&&this.updateCollectionNavButton(this.collectionNavButton)}updateHighlightCollectionCount(t){let e=this.containerEl.querySelector(`[data-highlight-id="${t.id}"]`);if(!e)return;let s=e.querySelector(".highlight-line-info:last-child span");if(s){let n=this.plugin.collectionsManager.getHighlightCollectionCount(t.id);s.textContent=`${n}`}}showTagActive(){if(!this.plugin.settings.showToolbar)return;let t=this.contentEl.querySelector(".highlights-tag-filter-button");t&&(this.selectedTags.size>0||this.selectedCollections.size>0||this.selectedSpecialFilters.size>0?t.classList.add("active"):t.classList.remove("active"))}showNewCollectionDialog(t){new lt(this.plugin.app,(e,s)=>{let n=this.plugin.collectionsManager.createCollection(e,s);t&&this.plugin.collectionsManager.addHighlightToCollection(n.id,t),this.animateCollectionCreation(n.id)}).open()}showCollectionMenu(t,e){let s=new f.Menu;s.addItem(n=>{n.setTitle(d("contextMenu.edit")).setIcon("edit").onClick(()=>{this.showEditCollectionDialog(e)})}),s.addItem(n=>{n.setTitle(d("contextMenu.delete")).setIcon("trash").onClick(async()=>{await this.animateCollectionDeletion(e.id)})}),s.showAtMouseEvent(t)}showEditCollectionDialog(t){new rt(this.plugin.app,t,(e,s)=>{t.name=e,t.description=s,this.plugin.saveSettings(),this.plugin.refreshSidebar()}).open()}updateNativeCommentsToggleState(t){this.showNativeComments?((0,f.setIcon)(t,"captions"),t.classList.remove("active"),(0,f.setTooltip)(t,d("toolbar.toggleComments"))):((0,f.setIcon)(t,"captions-off"),t.classList.add("active"),(0,f.setTooltip)(t,d("toolbar.toggleComments")))}animateCollectionCreation(t){this.plugin.refreshSidebar(),requestAnimationFrame(()=>{let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);e&&(e.classList.add("preparing-animation"),requestAnimationFrame(()=>{e.classList.remove("preparing-animation"),e.classList.add("animating-in"),window.setTimeout(()=>{e.classList.remove("animating-in")},400)}))})}async animateCollectionDeletion(t){let e=this.contentAreaEl.querySelector(`[data-collection-id="${t}"]`);if(!e)return await this.plugin.collectionsManager.deleteCollectionWithConfirmation(t);let s=this.plugin.collectionsManager.getCollection(t);return!s||!confirm(`Are you sure you want to delete "${s.name}"?`)?!1:(e.classList.add("animating-out"),new Promise(i=>{window.setTimeout(()=>{this.plugin.collectionsManager.deleteCollection(t),this.plugin.refreshSidebar(),i(!0)},220)}))}toggleNativeCommentsVisibility(){this.showNativeComments=!this.showNativeComments,this.plugin.app.saveLocalStorage("sidebar-highlights-show-native-comments",this.showNativeComments.toString())}handleSearchInput(t,e){this.currentParsedSearch=e,this.currentSearchTokens=K.getTokensFromQuery(t),this.renderContent()}removeSearchToken(t){this.simpleSearchManager.updateSuggestions({tags:this.getAvailableTags(),collections:this.getAvailableCollections()})}getHighlightById(t){for(let[e,s]of this.plugin.highlights){let n=s.find(i=>i.id===t);if(n)return n}return null}getAvailableTags(){let t=new Set;for(let e of this.plugin.highlights.values())for(let s of e)this.extractTagsFromHighlight(s).forEach(i=>t.add(i));return Array.from(t).sort()}getAvailableCollections(){return this.plugin.collectionsManager.getAllCollections().map(t=>t.name).sort()}applyAllFilters(t){return t.filter(e=>{if(!this.passesSmartSearchFilter(e))return!1;if(this.selectedTags.size>0){let i=this.extractTagsFromHighlight(e);if(!Array.from(this.selectedTags).some(l=>i.includes(l)))return!1}if(this.selectedCollections.size>0){let i=this.plugin.collectionsManager.getCollectionsForHighlight(e.id);if(!Array.from(this.selectedCollections).some(l=>i.some(o=>o.name===l)))return!1}if(!this.showNativeComments&&e.isNativeComment)return!1;let n=this.plugin.settings.minimumCharacterCount;return!(n>0&&(e.type==="highlight"||e.type==="html"||e.isNativeComment)&&e.text.length<n)})}passesSmartSearchFilter(t){return this.currentParsedSearch.ast?this.evaluateASTNode(this.currentParsedSearch.ast,t):!0}evaluateASTNode(t,e){if(t.type==="filter"){let s=t,n=this.highlightMatchesFilter(e,s);return s.exclude?!n:n}else if(t.type==="text"){let s=t;return e.text.toLowerCase().includes(s.value.toLowerCase())||e.filePath.toLowerCase().replace(/\.md$/,"").includes(s.value.toLowerCase())}else if(t.type==="operator"){let s=t,n=this.evaluateASTNode(s.left,e),i=this.evaluateASTNode(s.right,e);return s.operator==="AND"?n&&i:n||i}return!1}isConsecutiveTextNodes(t){return this.containsOnlyTextNodes(t.left)&&this.containsOnlyTextNodes(t.right)}containsOnlyTextNodes(t){if(t.type==="text")return!0;if(t.type==="operator"){let e=t;return e.operator==="AND"&&this.containsOnlyTextNodes(e.left)&&this.containsOnlyTextNodes(e.right)}return!1}extractConsecutiveText(t){if(t.type==="text")return t.value;if(t.type==="operator"){let e=t,s=this.extractConsecutiveText(e.left),n=this.extractConsecutiveText(e.right);return`${s} ${n}`}return""}highlightMatchesFilter(t,e){return e.filterType==="tag"?this.extractTagsFromHighlight(t).includes(e.value):e.filterType==="collection"?this.plugin.collectionsManager.getCollectionsForHighlight(t.id).map(i=>i.name).includes(e.value):!1}},ft=class extends f.Modal{constructor(t,e,s,n){super(t);this.dateFormat=e,this.currentDate=s,this.onSubmit=n}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:d("modals.taskDate.title")});e.style.marginBottom="20px";let s=t.createDiv({cls:"date-input-container"}),n=s.createEl("input",{type:"text",placeholder:this.dateFormat,value:this.currentDate,cls:"date-input-field"});this.dateSuggest=new pt(this.app,n,this.dateFormat);let i=s.createDiv({cls:"date-input-error"});i.style.display="none",n.focus(),setTimeout(()=>{this.currentDate||n.dispatchEvent(new Event("input")),n.select()},50);let a=p=>{let y=p.toLowerCase().trim();if(y==="today")return(0,f.moment)();if(y==="tomorrow")return(0,f.moment)().add(1,"day");if(y==="yesterday")return(0,f.moment)().subtract(1,"day");let v=/^(\d+)\s+(day|days|week|weeks|month|months|year|years)\s+(ago|from now)$/,S=y.match(v);if(S){let T=parseInt(S[1]),E=S[2].replace(/s$/,"");return S[3]==="ago"?(0,f.moment)().subtract(T,E):(0,f.moment)().add(T,E)}let k=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],I=/^(last|next|this)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/,H=y.match(I);if(H){let T=H[1],E=H[2],x=k.indexOf(E),F=(0,f.moment)().day();if(T==="last"){let D=F>=x?F-x:7-(x-F);return(0,f.moment)().subtract(D===0?7:D,"days")}else if(T==="next"){let D=x>F?x-F:7-(F-x);return(0,f.moment)().add(D===0?7:D,"days")}else if(T==="this")return x>=F?(0,f.moment)().add(x-F,"days"):(0,f.moment)().add(7+(x-F),"days")}return null},l=p=>{if(!p)return!0;let y=a(p);return y&&y.isValid()?!0:(0,f.moment)(p,this.dateFormat,!0).isValid()},o=p=>{i.textContent=p,i.style.display="block",n.addClass("has-error")},c=()=>{i.style.display="none",n.removeClass("has-error")},h=()=>{let p=n.value.trim();if(l(p)){c();let y=p||null;if(p){let v=a(p);v&&v.isValid()&&(y=v.format(this.dateFormat))}this.onSubmit(y),this.close()}else o(`Invalid date format. Please use ${this.dateFormat} or natural language (e.g., "today", "2 weeks from now")`)},g=t.createDiv({cls:"modal-button-container"});g.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",h),this.currentDate&&g.createEl("button",{text:"Remove Date",cls:"mod-warning"}).addEventListener("click",()=>{this.onSubmit(null),this.close()}),g.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()}),n.addEventListener("keydown",p=>{p.key==="Enter"?setTimeout(()=>{h()},0):p.key==="Escape"&&this.close()}),n.addEventListener("input",()=>{c()})}onClose(){let{contentEl:t}=this;t.empty()}};var st=require("obsidian");var at=require("obsidian"),Ct=class extends at.AbstractInputSuggest{constructor(t,e,s){super(t,e);this.inputEl=e,this.onSelectCallback=s,this.folders=this.app.vault.getAllFolders(!0).map(n=>(0,at.normalizePath)(n.path)).filter(n=>n!==""),this.files=this.app.vault.getFiles().map(n=>(0,at.normalizePath)(n.path))}getSuggestions(t){let e=t.toLowerCase().trim();if(!e)return this.folders.slice(0,10);let s=this.folders.filter(i=>i.toLowerCase().includes(e)),n=this.files.filter(i=>i.toLowerCase().includes(e));return[...s,...n].slice(0,20)}renderSuggestion(t,e){e.setText(t)}selectSuggestion(t){this.inputEl.value=t;let e=new Event("input");this.inputEl.dispatchEvent(e),this.close(),this.onSelectCallback&&this.onSelectCallback(t)}};var vt=class extends st.Modal{constructor(t,e,s,n){super(t);this.fileFilters=[...e],this.fileFilterMode=s,this.onUpdate=n}onOpen(){let{contentEl:t}=this;t.empty();let e=this.fileFilters.length;if(this.fileFilters=this.fileFilters.filter(u=>this.app.vault.getAbstractFileByPath(u.path)!==null),this.fileFilters.length<e){let u=e-this.fileFilters.length;this.onUpdate(this.fileFilters),new st.Notice(d("modals.excludedFiles.removedNonExistent",{count:u,paths:u===1?"path":"paths"}))}let s=t.createEl("div",{cls:"modal-title",text:d("modals.excludedFiles.title")});if(s.style.marginBottom="20px",this.fileFilters.length>0){let u=t.createDiv();u.style.borderTop="1px solid var(--background-modifier-border)",u.style.marginBottom="20px"}this.renderExcludedFilesList(t);let n=t.createDiv({cls:"setting-item"});n.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:d("modals.excludedFiles.filterLabel")});let l=n.createDiv({cls:"setting-item-control"}).createDiv({cls:"excluded-files-input-container"});l.style.display="flex",l.style.gap="8px",this.filterInput=l.createEl("input",{type:"text",placeholder:d("modals.excludedFiles.filterPlaceholder")}),this.filterInput.style.flex="1",this.fileFolderSuggest=new Ct(this.app,this.filterInput,u=>{this.addFilter()});let o=l.createEl("select");o.style.minWidth="100px";let c=o.createEl("option",{value:"exclude",text:d("modals.excludedFiles.exclude")}),h=o.createEl("option",{value:"include",text:d("modals.excludedFiles.include")});o.value=this.fileFilterMode,o.addEventListener("change",()=>{this.fileFilterMode=o.value}),l.createEl("button",{text:d("modals.excludedFiles.add")}).addEventListener("click",()=>this.addFilter()),this.filterInput.addEventListener("keydown",u=>{u.key==="Enter"&&this.addFilter()}),this.renderModalButtons(t)}renderExcludedFilesList(t){let e=t.querySelector(".excluded-files-list");if(e&&e.remove(),this.fileFilters.length>0){let s=t.querySelector(".setting-item"),n=t.createDiv({cls:"excluded-files-list"});s&&t.insertBefore(n,s);let i=this.fileFilters.filter(l=>l.mode==="include"),a=this.fileFilters.filter(l=>l.mode==="exclude");if(i.length>0){let l=n.createDiv({cls:"file-filter-header"});l.style.fontSize="var(--font-ui-small)",l.style.color="var(--text-muted)",l.style.fontWeight="600",l.style.textTransform="uppercase",l.style.letterSpacing="0.05em",l.style.marginTop="8px",l.style.marginBottom="8px",l.setText(d("modals.excludedFiles.included")),this.renderFilterItems(n,i)}if(a.length>0){let l=n.createDiv({cls:"file-filter-header"});l.style.fontSize="var(--font-ui-small)",l.style.color="var(--text-muted)",l.style.fontWeight="600",l.style.textTransform="uppercase",l.style.letterSpacing="0.05em",l.style.marginTop=i.length>0?"16px":"8px",l.style.marginBottom="8px",l.setText(d("modals.excludedFiles.excluded")),this.renderFilterItems(n,a)}}}renderFilterItems(t,e){e.forEach(s=>{let n=t.createDiv({cls:"setting-item excluded-file-item"});n.style.borderTop="none",n.style.paddingTop="4px",n.style.paddingBottom="4px",n.createDiv({cls:"setting-item-info"}).createDiv({cls:"setting-item-name",text:s.path});let l=n.createDiv({cls:"setting-item-control"}).createEl("button",{cls:"clickable-icon"});(0,st.setIcon)(l,"x"),l.addEventListener("click",()=>{this.removeFilter(s.path)})})}renderModalButtons(t){let e=t.createDiv({cls:"modal-button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="8px",e.style.marginTop="20px",e.createEl("button",{text:d("modals.excludedFiles.cancel")}).addEventListener("click",()=>this.close()),e.createEl("button",{text:d("modals.excludedFiles.save"),cls:"mod-cta"}).addEventListener("click",()=>this.close())}addFilter(){let t=this.filterInput.value.trim();if(t){if(this.fileFilters.some(e=>e.path===t)){new st.Notice(d("modals.excludedFiles.alreadyExists",{path:t}));return}this.fileFilters.push({path:t,mode:this.fileFilterMode}),this.filterInput.value="",this.refreshContent(),this.onUpdate(this.fileFilters)}}removeFilter(t){this.fileFilters=this.fileFilters.filter(e=>e.path!==t),this.refreshContent(),this.onUpdate(this.fileFilters)}refreshContent(){this.renderExcludedFilesList(this.contentEl)}onClose(){let{contentEl:t}=this;t.empty()}};var Ht=require("obsidian");var yt=class extends Ht.Modal{constructor(t,e,s,n){super(t);this.selectedBackup=null;this.restoreButton=null;this.backups=e,this.countHighlights=s,this.onRestore=n}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:d("modals.backupSelector.title")});if(e.style.marginBottom="20px",this.backups.length>0){let i=t.createDiv();i.style.borderTop="1px solid var(--background-modifier-border)",i.style.marginBottom="20px"}if(this.backups.length===0){let i=t.createDiv({cls:"setting-item-description"});i.setText(d("settings.backupRestore.noBackups")),i.style.textAlign="center",i.style.padding="20px"}else this.renderBackupList(t);let s=t.createDiv({cls:"modal-button-container"});s.style.display="flex",s.style.justifyContent="flex-end",s.style.gap="10px",s.style.marginTop="20px",s.createEl("button",{text:d("settings.backupRestore.cancel")}).addEventListener("click",()=>this.close()),this.restoreButton=s.createEl("button",{text:d("settings.backupRestore.restore"),cls:"mod-cta"}),this.restoreButton.disabled=!0,this.restoreButton.addEventListener("click",async()=>{if(!this.selectedBackup)return;let i=Object.keys(this.selectedBackup.data.collections||{}).length,a=this.countHighlights(this.selectedBackup.data.collections||{});await this.onRestore(this.selectedBackup.path,i,a),this.close()})}renderBackupList(t){let e=t.createDiv({cls:"backup-list"});e.style.maxHeight="400px",e.style.overflowY="auto",this.backups.forEach(s=>{let n=Object.keys(s.data.collections||{}).length,i=this.countHighlights(s.data.collections||{}),a=e.createDiv({cls:"backup-item"});a.style.padding="6px 8px",a.style.cursor="pointer",a.style.borderRadius="4px",a.style.marginBottom="2px",a.style.display="flex",a.style.justifyContent="space-between",a.style.alignItems="center",a.style.transition="background-color 0.1s ease";let l=this.formatBackupDate(s.data.backupCreatedAt),o=this.getBackupTypeLabel(s.data.backupReason),c=a.createDiv();c.style.flex="1";let h=c.createDiv();h.setText(l),h.style.fontWeight="500";let g=c.createDiv();g.setText(o),g.style.fontSize="var(--font-ui-small)",g.style.color="var(--text-muted)",g.style.marginTop="2px";let u=c.createDiv();u.style.fontSize="var(--font-ui-small)",u.style.color="var(--text-muted)",u.style.marginTop="2px";let m=u.createSpan();m.style.color="var(--text-normal)",m.setText(n.toString()),u.appendText(" Collections \u2022 ");let p=u.createSpan();p.style.color="var(--text-normal)",p.setText(i.toString()),u.appendText(" Collection Highlights"),a.addEventListener("click",()=>{e.querySelectorAll(".backup-item").forEach(y=>{y.style.backgroundColor=""}),a.style.backgroundColor="var(--background-modifier-hover)",this.selectedBackup=s,this.restoreButton&&(this.restoreButton.disabled=!1)}),a.addEventListener("mouseenter",()=>{this.selectedBackup!==s&&(a.style.backgroundColor="var(--background-modifier-hover)")}),a.addEventListener("mouseleave",()=>{this.selectedBackup!==s&&(a.style.backgroundColor="")})})}formatBackupDate(t){return t?new Date(t).toLocaleString():d("settings.backupRestore.unknownDate")}getBackupTypeLabel(t){return t==="manual"?d("modals.backupSelector.manual"):d("modals.backupSelector.automatic")}onClose(){let{contentEl:t}=this;t.empty()}};var Q={settingsVersion:"1.14.0",highlightColor:"#ffd700",sidebarPosition:"right",highlights:{},collections:{},groupingMode:"none",taskSecondaryGroupingMode:"none",sortMode:"none",tabSettings:{},showFilenames:!0,showTimestamps:!0,showHighlightActions:!0,showToolbar:!0,autoToggleFold:!1,useInlineFootnotes:!1,selectTextOnCommentClick:!1,excludeExcalidraw:!0,excludedFiles:[],fileFilters:[],fileFilterMode:"exclude",dateFormat:"YYYY-MM-DD HH:mm",minimumCharacterCount:0,highlightFontSize:11,detailsFontSize:11,commentFontSize:11,highlightFontWeight:400,taskFontWeight:400,detectHtmlComments:!1,detectAdjacentNativeComments:!0,customPatterns:[],customColors:{yellow:"#ffd700",red:"#ff6b6b",teal:"#4ecdc4",blue:"#45b7d1",green:"#96ceb4"},customColorNames:{yellow:"",red:"",teal:"",blue:"",green:""},showCurrentNoteTab:!0,showAllNotesTab:!0,showCollectionsTab:!0,showTasksTab:!1,showCompletedTasks:!0,showTaskContext:!0,taskDateFormat:"YYYY-MM-DD",showCurrentNoteTasksSection:!0,showOnlyCurrentNoteTasks:!1,displayModes:[],currentDisplayModeId:null},Tt="highlights-sidebar",wt=class extends b.Plugin{constructor(){super(...arguments);this.highlights=new Map;this.collections=new Map;this.sidebarView=null;this.ribbonIconEl=null;this.detectHighlightsTimeout=null;this.selectedHighlightId=null;this.collectionCommands=new Set;this.isScanningFiles=!1}async onload(){await this.loadSettings();try{await Mt.init()}catch(t){console.error("Failed to initialize i18n, plugin will continue with English defaults:",t)}await this.migrateBackupFilesToFolder(),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.collections=new Map(Object.entries(this.settings.collections||{})),this.collectionsManager=new kt(this),this.inlineFootnoteManager=new Z,"registerHoverLinkSource"in this.app.workspace&&this.app.workspace.registerHoverLinkSource("sidebar-highlights",{display:"Sidebar Highlights",defaultMod:!0}),this.registerView(Tt,t=>(this.sidebarView=new mt(t,this),this.sidebarView)),this.ribbonIconEl=this.addRibbonIcon("highlighter","Open highlights",()=>{this.activateView()}),this.addCommand({id:"create-highlight",name:d("commands.createHighlight"),editorCallback:t=>{this.createHighlight(t)}}),this.addCommand({id:"open-highlights-sidebar",name:d("commands.toggle"),callback:()=>{this.toggleView()}}),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,s)=>{e.getSelection()&&t.addItem(n=>{n.setTitle("Create highlight").setIcon("highlighter").onClick(()=>{this.createHighlight(e)})})})),this.registerEvent(this.app.workspace.on("file-open",t=>{t?this.loadHighlightsFromFile(t):(this.selectedHighlightId=null,this.sidebarView&&this.sidebarView.updateContent())})),this.registerEvent(this.app.workspace.on("editor-change",(t,e)=>{e instanceof b.MarkdownView&&this.debounceDetectMarkdownHighlights(t,e)})),this.addSettingTab(new Ft(this.app,this)),this.addStyles(),this.registerCollectionCommands(),this.registerDisplayModeCommands(),this.app.workspace.onLayoutReady(async()=>{await this.fixDuplicateTimestamps(),this.scanAllFilesForHighlights(),this.updateCustomColorStyles(),this.registerEvent(this.app.vault.on("create",t=>{t instanceof b.TFile&&this.shouldProcessFile(t)&&this.handleFileCreate(t)})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof b.TFile&&this.shouldProcessFile(t)&&this.handleFileRename(t,e)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof b.TFile&&this.shouldProcessFile(t)&&this.handleFileDelete(t)}))})}onunload(){this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}async loadSettings(){let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==Q.settingsVersion?await this.migrateSettings(t):(this.settings=this.safeMergeSettings(t),this.settings.settingsVersion||(this.settings.settingsVersion=Q.settingsVersion,await this.saveSettings())),this.settings.excludedFiles&&this.settings.excludedFiles.length>0&&(!this.settings.fileFilters||this.settings.fileFilters.length===0)&&(this.settings.fileFilters=this.settings.excludedFiles.map(e=>({path:e,mode:"exclude"})),this.settings.excludedFiles=[],await this.saveSettings())}safeMergeSettings(t){let e={...Q};return t&&(Object.assign(e,t),t.collections!==void 0&&(e.collections=t.collections),t.highlights!==void 0&&(e.highlights=t.highlights),t.customColorNames!==void 0&&(e.customColorNames=t.customColorNames)),e}async saveSettings(){this.settings.highlights=Object.fromEntries(this.highlights),this.settings.collections=Object.fromEntries(this.collections),await this.saveData(this.settings),this.updateStyles()}addStyles(){let t=document.createElement("style");t.id="highlight-comments-plugin-styles",this.updateCustomColorStyles(),document.head.appendChild(t)}updateStyles(){this.updateCustomColorStyles()}removeStyles(){let t=document.getElementById("highlight-comments-plugin-styles");t&&t.remove(),document.body.style.removeProperty("--sh-highlight-yellow"),document.body.style.removeProperty("--sh-highlight-red"),document.body.style.removeProperty("--sh-highlight-teal"),document.body.style.removeProperty("--sh-highlight-blue"),document.body.style.removeProperty("--sh-highlight-green"),document.body.style.removeProperty("--sh-quote-font-size"),document.body.style.removeProperty("--sh-details-font-size"),document.body.style.removeProperty("--sh-comment-font-size"),document.body.style.removeProperty("--sh-highlight-font-weight"),document.body.style.removeProperty("--sh-task-font-weight")}updateCustomColorStyles(){document.body.style.setProperty("--sh-highlight-yellow",this.settings.customColors.yellow),document.body.style.setProperty("--sh-highlight-red",this.settings.customColors.red),document.body.style.setProperty("--sh-highlight-teal",this.settings.customColors.teal),document.body.style.setProperty("--sh-highlight-blue",this.settings.customColors.blue),document.body.style.setProperty("--sh-highlight-green",this.settings.customColors.green),document.body.style.setProperty("--sh-quote-font-size",`${this.settings.highlightFontSize}px`),document.body.style.setProperty("--sh-details-font-size",`${this.settings.detailsFontSize}px`),document.body.style.setProperty("--sh-comment-font-size",`${this.settings.commentFontSize}px`),document.body.style.setProperty("--sh-highlight-font-weight",`${this.settings.highlightFontWeight}`),document.body.style.setProperty("--sh-task-font-weight",`${this.settings.taskFontWeight}`)}async activateView(){let{workspace:t}=this.app,e=null,s=t.getLeavesOfType(Tt);s.length>0?e=s[0]:(e=this.settings.sidebarPosition==="left"?t.getLeftLeaf(!1):t.getRightLeaf(!1),await(e==null?void 0:e.setViewState({type:Tt,active:!0}))),e&&t.revealLeaf(e)}async toggleView(){let{workspace:t}=this.app,e=t.getLeavesOfType(Tt);e.length>0?e.forEach(s=>s.detach()):await this.activateView()}async createHighlight(t){let e=t.getSelection();if(!e){new b.Notice("Please select some text first");return}let s=this.app.workspace.getActiveFile();if(!s){new b.Notice("No active file");return}let n=t.getCursor("from"),i=t.getCursor("to"),a=t.posToOffset(n),l=t.posToOffset(i),c={id:this.generateId(),text:e,tags:[],line:n.line,startOffset:a,endOffset:l,filePath:s.path,createdAt:Date.now()},h=this.highlights.get(s.path)||[];h.push(c),this.highlights.set(s.path,h);let g=`==${e}==`;t.replaceSelection(g),this.refreshSidebar(),new b.Notice("Highlight created")}refreshSidebar(){this.sidebarView&&this.sidebarView.refresh()}createDisplayModeFromCurrent(t){return{id:Date.now().toString(),name:t,showFilenames:this.settings.showFilenames,showTimestamps:this.settings.showTimestamps,showHighlightActions:this.settings.showHighlightActions,showToolbar:this.settings.showToolbar,autoToggleFold:this.settings.autoToggleFold,dateFormat:this.settings.dateFormat,minimumCharacterCount:this.settings.minimumCharacterCount,showCurrentNoteTab:this.settings.showCurrentNoteTab,showAllNotesTab:this.settings.showAllNotesTab,showCollectionsTab:this.settings.showCollectionsTab,showTasksTab:this.settings.showTasksTab}}async applyDisplayMode(t){this.settings.showFilenames=t.showFilenames,this.settings.showTimestamps=t.showTimestamps,this.settings.showHighlightActions=t.showHighlightActions,this.settings.showToolbar=t.showToolbar,this.settings.autoToggleFold=t.autoToggleFold,this.settings.dateFormat=t.dateFormat,this.settings.minimumCharacterCount=t.minimumCharacterCount,this.settings.showCurrentNoteTab=t.showCurrentNoteTab,this.settings.showAllNotesTab=t.showAllNotesTab,this.settings.showCollectionsTab=t.showCollectionsTab,this.settings.showTasksTab=t.showTasksTab,this.settings.currentDisplayModeId=t.id,await this.saveSettings(),this.sidebarView&&this.sidebarView.resetToFirstVisibleTab(),this.refreshSidebar()}async updateDisplayMode(t){t.showFilenames=this.settings.showFilenames,t.showTimestamps=this.settings.showTimestamps,t.showHighlightActions=this.settings.showHighlightActions,t.showToolbar=this.settings.showToolbar,t.autoToggleFold=this.settings.autoToggleFold,t.dateFormat=this.settings.dateFormat,t.minimumCharacterCount=this.settings.minimumCharacterCount,t.showCurrentNoteTab=this.settings.showCurrentNoteTab,t.showAllNotesTab=this.settings.showAllNotesTab,t.showCollectionsTab=this.settings.showCollectionsTab,t.showTasksTab=this.settings.showTasksTab,this.settings.currentDisplayModeId=t.id,await this.saveSettings()}registerDisplayModeCommands(){this.settings.displayModes.forEach(t=>{this.addCommand({id:`apply-display-mode-${t.id}`,name:d("commands.applyDisplayMode",{name:t.name}),callback:()=>{this.applyDisplayMode(t),new b.Notice(d("notices.displayModeApplied",{name:t.name}))}})})}async reloadAllSettings(){await this.loadSettings(),this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),this.registerCollectionCommands(),this.updateStyles(),this.refreshSidebar()}async createBackup(t){try{let e=new Date().toISOString().replace(/[:.]/g,"-"),s=`data-backup-${t}-${e}.json`,n={settingsVersion:this.settings.settingsVersion,collections:this.settings.collections,customColorNames:this.settings.customColorNames,highlights:this.settings.highlights,backupReason:t,originalTimestamp:e,backupCreatedAt:Date.now(),retentionManaged:!0},i=".obsidian/plugins/sidebar-highlights/backups";try{await this.app.vault.adapter.mkdir(i)}catch(l){}let a=`${i}/${s}`;await this.app.vault.adapter.write(a,JSON.stringify(n,null,2)),(t==="migration"||t==="manual")&&new b.Notice(`Settings backup created: ${s}`),await this.cleanupOldBackups()}catch(e){console.error("Failed to create backup:",e),new b.Notice("Warning: Could not create settings backup")}}async listBackups(){try{let t=".obsidian/plugins/sidebar-highlights/backups",e=await this.app.vault.adapter.list(t),s=[];for(let n of e.files)if(n.endsWith(".json")&&n.includes("data-backup-"))try{let i=await this.app.vault.adapter.read(n),a=JSON.parse(i);s.push({path:n,filename:n.split("/").pop()||n,data:a})}catch(i){console.error(`Failed to read backup ${n}:`,i)}return s.sort((n,i)=>{let a=n.data.backupCreatedAt||0;return(i.data.backupCreatedAt||0)-a}),s}catch(t){return console.error("Failed to list backups:",t),[]}}async findBackupWithCollections(){let t=await this.listBackups();for(let e of t)if(e.data.collections&&typeof e.data.collections=="object"&&Object.keys(e.data.collections).length>0)return e;return null}async restoreFromBackup(t){let e=[],s=i=>{e.push(`[${new Date().toISOString()}] ${i}`)},n=Date.now();try{s("=== BACKUP RESTORATION STARTED ==="),s(`Start time: ${new Date().toISOString()}`),s(`
--- ENVIRONMENT ---`),s(`Plugin version: ${this.manifest.version}`),s(`Obsidian version: ${this.app.appVersion||"unknown"}`),s(`Platform: ${this.app.isMobile?"mobile":"desktop"}`);let i=t.split("/").pop()||"unknown";s(`
--- BACKUP FILE ---`),s(`Backup file: ${i}`);let a=await this.app.vault.adapter.read(t);s(`Backup file size: ${a.length} bytes`);let l=JSON.parse(a);s("\u2713 Backup file read and parsed successfully"),s(`Backup version: ${l.settingsVersion||"unknown"}`),s(`Backup reason: ${l.backupReason||"unknown"}`),s(`Backup timestamp: ${l.originalTimestamp||l.backupCreatedAt||"unknown"}`),s(`
--- CURRENT STATE BEFORE RESTORATION ---`);let o=Array.from(this.highlights.values()).reduce((x,M)=>x+M.length,0),c=this.collections.size;s(`Current highlights in memory: ${o}`),s(`Current collections in memory: ${c}`),s(`Current files with highlights: ${this.highlights.size}`),s(`
--- RESTORING COLLECTIONS ---`);let h=l.collections?Object.keys(l.collections).length:0;if(s(`Collections in backup: ${h}`),l.collections){this.settings.collections=l.collections,this.collections=new Map(Object.entries(l.collections));let x=0;for(let[M,F]of this.collections)x++,s(`  Collection #${x} (ID: ${M}): ${F.highlightIds.length} highlight IDs`);s("\u2713 Collections restored")}l.customColorNames&&(this.settings.customColorNames=l.customColorNames,s("\u2713 Custom color names restored"));let g=new Set;if(l.collections)for(let x in l.collections){let M=l.collections[x];for(let F of M.highlightIds)g.add(F)}s(`
Highlight IDs referenced in collections: ${g.size}`),s(`Collection highlight IDs: ${Array.from(g).join(", ")}`),s(`
--- RESTORING HIGHLIGHTS ---`),s("NOTE: File filtering is bypassed for collection restoration"),s("Collections are restored regardless of excluded files settings");let u=0,m=0,p=l.highlights?Object.keys(l.highlights).length:0,y=l.highlights?Object.values(l.highlights).reduce((x,M)=>x+M.length,0):0;if(s(`Files with highlights in backup: ${p}`),s(`Total highlights in backup: ${y}`),s(`Collection highlights to restore: ${g.size}`),l.highlights&&g.size>0){let x=new Map,M=0;for(let F in l.highlights){let D=Date.now();M++;let N=l.highlights[F],P=N.filter(B=>g.has(B.id));if(P.length===0){s(`
--- Skipping file #${M}: [REDACTED] ---`),s(`  No collection highlights in this file (${N.length} total highlights skipped)`);continue}s(`
--- Processing file #${M}: [REDACTED] ---`),s(`  Collection highlights in this file: ${P.length} (${N.length} total in backup)`);let C=this.app.vault.getAbstractFileByPath(F);if(!C||!(C instanceof b.TFile)){s(`  \u2717 File does not exist - marking ${P.length} collection highlights as orphaned`),m+=P.length;continue}s("  \u2713 File exists"),!this.shouldProcessFile(C)&&s("  \u2139 File would normally be filtered, but processing anyway for collection restoration");let A;try{A=await this.app.vault.read(C),s(`  \u2713 File content read (${A.length} characters)`)}catch(B){s(`  \u2717 Failed to read file: ${B}`),console.error(`Failed to read file #${M}:`,B),m+=P.length;continue}let L=[];for(let B of P){s(`
  Validating highlight ID: ${B.id}`),s(`    Text length: ${B.text.length} characters`),s("    Text preview: [REDACTED]"),s(`    Type: ${B.type||"highlight"}`),s(`    Native comment: ${B.isNativeComment||!1}`),s(`    Line number: ${B.line}`),s(`    Start offset: ${B.startOffset}`),s(`    End offset: ${B.endOffset}`);let V=B.text.includes(`
`),O=(B.text.match(/\n/g)||[]).length,z=/^\s/.test(B.text),Y=/\s$/.test(B.text);s(`    Contains newlines: ${V} (${O} newline(s))`),s(`    Starts with whitespace: ${z}`),s(`    Ends with whitespace: ${Y}`);let _=/[.*+?^${}()|[\]\\]/.test(B.text);s(`    Contains regex special chars: ${_}`);let it=A.includes(B.text);if(s(`    Text exists in file: ${it}`),!it){m++,s("    \u2717 ORPHANED - Exact text not found in file"),s("    Reason: The highlight text does not appear anywhere in the current file content"),s("    Possible causes: Text was edited, deleted, or moved to another file");continue}let X=!1,J="";B.isNativeComment?(J=`%%\\s*${this.escapeRegex(B.text)}\\s*%%`,X=new RegExp(J).test(A),s(`    Checking native comment pattern: ${X}`),s(`    Pattern: ${J}`)):(J=`==\\s*${this.escapeRegex(B.text)}\\s*==`,X=new RegExp(J).test(A),s(`    Checking highlight pattern: ${X}`),s(`    Pattern: ${J}`)),X?(L.push(B),u++,s("    \u2713 RECOVERED - Highlight pattern matched successfully")):(m++,s("    \u2717 ORPHANED - Text exists but pattern not matched"),s("    Reason: Text found in file but not wrapped with expected delimiters"),B.isNativeComment?s("    Expected: Text wrapped with %% %% (native comment)"):s("    Expected: Text wrapped with == == (highlight)"),s("    Possible causes: User removed highlight markers, or whitespace/newline differences"))}L.length>0?(x.set(F,L),s(`  Summary: ${L.length}/${P.length} collection highlights restored from this file`)):s(`  Summary: 0/${P.length} collection highlights restored from this file`);let R=Date.now()-D;s(`  Processing time: ${R}ms`)}this.highlights=x,this.settings.highlights=Object.fromEntries(x),s(`
\u2713 Highlight restoration complete`),s(`  Total recovered: ${u}`),s(`  Total orphaned: ${m}`)}if(l.collections){s(`
--- Cleaning up collection references ---`);let x=new Set;for(let F of this.highlights.values())for(let D of F)x.add(D.id);s(`Valid highlight IDs after restoration: ${x.size}`);let M=0;for(let[F,D]of this.collections){M++;let N=D.highlightIds.length;D.highlightIds=D.highlightIds.filter(C=>{let w=x.has(C);return w||s(`  Removing orphaned highlight ID "${C}" from collection #${M}`),w});let P=D.highlightIds.length;this.collections.set(F,D),s(`  Collection #${M}: ${N} \u2192 ${P} highlights`)}this.settings.collections=Object.fromEntries(this.collections),s("\u2713 Collection cleanup complete")}await this.saveSettings(),s("\u2713 Settings saved"),this.refreshSidebar(),s("\u2713 Sidebar refreshed");let v=Date.now()-n,S=Array.from(this.highlights.values()).reduce((x,M)=>x+M.length,0),k=this.collections.size,I=this.highlights.size;s(`
=== BACKUP RESTORATION COMPLETED SUCCESSFULLY ===`),s(`Total elapsed time: ${v}ms (${(v/1e3).toFixed(2)}s)`),s(`
--- FINAL STATISTICS ---`),s(`Collections restored: ${h}`),s(`Highlights attempted: ${g.size}`),s(`Highlights recovered: ${u}`),s(`Highlights orphaned: ${m}`),s(`Success rate: ${g.size>0?(u/g.size*100).toFixed(1):0}%`),s(`
--- FINAL STATE ---`),s(`Total highlights in memory: ${S}`),s(`Total collections: ${k}`),s(`Files with highlights: ${I}`),s(`
--- VALIDATION CHECKS ---`);let H=Array.from(this.collections.values()).filter(x=>x.highlightIds.length===0);s(`Empty collections: ${H.length}`);let T=new Set;for(let x of this.highlights.values())for(let M of x)T.add(M.id);let E=0;for(let x of this.collections.values())for(let M of x.highlightIds)T.has(M)||(E++,s(`WARNING: Collection contains invalid highlight ID: ${M}`));return s(`Broken collection references: ${E}`),s(`Validation status: ${E===0?"\u2713 PASSED":"\u2717 FAILED"}`),await this.writeRestoreLog(e.join(`
`)),{success:!0,orphanedCount:m,recoveredCount:u}}catch(i){let a=Date.now()-n;s(`
\u2717\u2717\u2717 RESTORATION FAILED \u2717\u2717\u2717`),s(`Failed at: ${new Date().toISOString()}`),s(`Time before failure: ${a}ms`),s(`Error type: ${i instanceof Error?i.constructor.name:typeof i}`),s(`Error message: ${i}`),i instanceof Error&&(s(`Error name: ${i.name}`),s(`Stack trace:
${i.stack}`));try{let l=Array.from(this.highlights.values()).reduce((o,c)=>o+c.length,0);s(`
--- PARTIAL STATE AT FAILURE ---`),s(`Highlights in memory: ${l}`),s(`Collections in memory: ${this.collections.size}`)}catch(l){s(`Could not retrieve partial state: ${l}`)}return console.error("Failed to restore from backup:",i),await this.writeRestoreLog(e.join(`
`)),{success:!1}}}async writeRestoreLog(t){try{let e=`${this.manifest.dir}/restore-log.txt`;await this.app.vault.adapter.write(e,t)}catch(e){console.error("Failed to write restore log:",e)}}async getRestoreLog(){try{let t=`${this.manifest.dir}/restore-log.txt`;return await this.app.vault.adapter.exists(t)?await this.app.vault.adapter.read(t):null}catch(t){return console.error("Failed to read restore log:",t),null}}validateHighlightInFile(t,e){return e.includes(t.text)?t.isNativeComment?new RegExp(`%%\\s*${this.escapeRegex(t.text)}\\s*%%`).test(e):new RegExp(`==\\s*${this.escapeRegex(t.text)}\\s*==`).test(e):!1}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}countOrphanedReferences(){let t=new Set;for(let[s,n]of this.highlights)for(let i of n)t.add(i.id);let e=0;for(let[s,n]of this.collections)for(let i of n.highlightIds)t.has(i)||e++;return e}cleanupOrphanedReferences(){let t=new Set;for(let[s,n]of this.highlights)for(let i of n)t.add(i.id);let e=0;for(let[s,n]of this.collections)n.highlightIds=n.highlightIds.filter(i=>{let a=t.has(i);return a||e++,a}),this.collections.set(s,n);return e}countHighlightsInCollections(t){let e=new Set;for(let s in t){let n=t[s];if(n.highlightIds)for(let i of n.highlightIds)e.add(i)}return e.size}async cleanupOldBackups(){try{let e=(await this.listBackups()).filter(s=>s.data.retentionManaged===!0&&s.data.backupReason!=="manual");if(e.length>20){let s=e.slice(20);for(let n of s)try{await this.app.vault.adapter.remove(n.path),console.log(`Deleted old backup: ${n.filename}`)}catch(i){console.error(`Failed to delete backup ${n.filename}:`,i)}}}catch(t){console.error("Failed to cleanup old backups:",t)}}async migrateBackupFilesToFolder(){try{let t=".obsidian/plugins/sidebar-highlights",e=`${t}/backups`;try{await this.app.vault.adapter.mkdir(e)}catch(a){}let n=(await this.app.vault.adapter.list(t)).files.filter(a=>a.includes("data-backup-")&&a.endsWith(".json")&&!a.includes("/backups/"));if(n.length===0)return;let i=0;for(let a of n)try{let l=a.split("/").pop(),o=`${e}/${l}`,c=await this.app.vault.adapter.read(a);await this.app.vault.adapter.write(o,c),await this.app.vault.adapter.remove(a),i++}catch(l){console.error(`Failed to migrate backup file ${a}:`,l)}}catch(t){console.error("Failed to migrate backup files:",t)}}async migrateSettings(t){try{await this.createBackup("migration");let e=t.settingsVersion||"1.13.0",s=Q.settingsVersion;e!==s&&new b.Notice(`Migrating settings from ${e} to ${s}...`);let n=t.collections||{},i=t.customColorNames||{},a=t.highlights||{};this.settings={...Q},this.settings.collections=n,this.settings.customColorNames={...Q.customColorNames,...i},this.settings.highlights=a,t.highlightColor!==void 0&&(this.settings.highlightColor=t.highlightColor),t.sidebarPosition!==void 0&&(this.settings.sidebarPosition=t.sidebarPosition),t.groupingMode!==void 0&&(this.settings.groupingMode=t.groupingMode),t.showFilenames!==void 0&&(this.settings.showFilenames=t.showFilenames),t.showTimestamps!==void 0&&(this.settings.showTimestamps=t.showTimestamps),t.showHighlightActions!==void 0&&(this.settings.showHighlightActions=t.showHighlightActions),t.showToolbar!==void 0&&(this.settings.showToolbar=t.showToolbar),t.useInlineFootnotes!==void 0&&(this.settings.useInlineFootnotes=t.useInlineFootnotes),t.selectTextOnCommentClick!==void 0&&(this.settings.selectTextOnCommentClick=t.selectTextOnCommentClick),t.excludeExcalidraw!==void 0&&(this.settings.excludeExcalidraw=t.excludeExcalidraw),t.excludedFiles!==void 0&&(this.settings.excludedFiles=t.excludedFiles),t.dateFormat!==void 0&&(this.settings.dateFormat=t.dateFormat),t.customColors!==void 0&&(this.settings.customColors={...Q.customColors,...t.customColors}),this.settings.settingsVersion=s,this.collections=new Map(Object.entries(this.settings.collections||{})),this.highlights=new Map(Object.entries(this.settings.highlights||{})),await this.saveSettings(),e!==s&&(new b.Notice(`Settings successfully migrated to ${s}`),await this.validateCollectionReferences())}catch(e){console.error("Migration failed:",e),new b.Notice("Error during settings migration. Please check console for details.")}}async validateCollectionReferences(){try{let t=new Set;for(let n of this.highlights.values())n.forEach(i=>t.add(i.id));let e=0,s=[];for(let n of this.collections.values()){let i=n.highlightIds.filter(a=>!t.has(a));i.length>0&&(e+=i.length,s.push({name:n.name,brokenCount:i.length,totalCount:n.highlightIds.length}),n.highlightIds=n.highlightIds.filter(a=>t.has(a)))}if(e>0){let n=s.map(i=>`\u2022 ${i.name}: ${i.brokenCount}/${i.totalCount} references`).join(`
`);new b.Notice(`Migration complete, but ${e} highlight reference(s) couldn't be restored:

${n}

Broken references have been cleaned up. You may need to manually re-add some highlights to these collections.`,8e3),await this.saveSettings()}else new b.Notice("Migration successful! All collections and highlights preserved.",3e3)}catch(t){console.error("Collection validation failed:",t),new b.Notice("Warning: Could not validate collection references after migration.")}}async onExternalSettingsChange(){try{await this.createBackup("external-sync");let t=await this.loadData();t&&t.settingsVersion&&t.settingsVersion!==Q.settingsVersion?await this.migrateSettings(t):await this.reloadAllSettings()}catch(t){console.error("Error handling external settings change:",t),await this.reloadAllSettings()}}registerCollectionCommands(){for(let t of this.collections.values()){let e=`go-to-collection-${t.id}`;this.addCommand({id:e,name:d("commands.goToCollection",{name:t.name}),callback:()=>{this.goToCollection(t.id)}}),this.collectionCommands.add(e)}}unregisterCollectionCommands(){for(let t of this.collectionCommands)this.removeCommand(t);this.collectionCommands.clear()}async goToCollection(t){await this.activateView(),this.sidebarView&&this.sidebarView.navigateToCollection(t)}updateHighlight(t,e,s){let n=s,i;if(n)i=this.highlights.get(n);else for(let[l,o]of this.highlights)if(o.some(c=>c.id===t)){n=l,i=o;break}if(!n&&!s){let l=this.app.workspace.getActiveFile();l&&(n=l.path,i=this.highlights.get(n))}if(!n||!i)return;let a=i.findIndex(l=>l.id===t);if(a!==-1){let l={...i[a],...e},o=[...i];o[a]=l,this.highlights.set(n,o),this.saveSettings(),this.sidebarView&&this.sidebarView.updateItem(t)}}async loadHighlightsFromFile(t){if(this.selectedHighlightId?(this.highlights.get(t.path)||[]).find(i=>i.id===this.selectedHighlightId)||(this.selectedHighlightId=null):this.selectedHighlightId=null,!this.shouldProcessFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}if(await this.isExcalidrawFile(t)){this.highlights.delete(t.path),this.sidebarView&&this.sidebarView.updateContent();return}let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t),this.sidebarView&&this.sidebarView.updateContent()}debounceDetectMarkdownHighlights(t,e){this.detectHighlightsTimeout&&window.clearTimeout(this.detectHighlightsTimeout),this.detectHighlightsTimeout=window.setTimeout(()=>{this.detectMarkdownHighlights(t,e)},1e3)}async detectMarkdownHighlights(t,e){let s=e.file;if(!s)return;let n=t.getValue();this.detectAndStoreMarkdownHighlights(n,s)}async scanAllFilesForHighlights(){if(this.isScanningFiles){console.log("Scan already in progress, skipping concurrent scan request");return}this.isScanningFiles=!0;try{let t=this.app.vault.getMarkdownFiles(),e=t.filter(o=>this.shouldProcessFile(o)),s=this.getFilesWithCollectionHighlights(),n=t.filter(o=>!this.shouldProcessFile(o)&&s.has(o.path)),i=[...e,...n],a=new Set(i.map(o=>o.path)),l=!1;for(let o of this.highlights.keys())a.has(o)||(!this.app.vault.getAbstractFileByPath(o)||!s.has(o))&&(this.highlights.delete(o),l=!0);for(let o of i)try{if(await this.isExcalidrawFile(o)){this.highlights.has(o.path)&&(this.highlights.delete(o.path),l=!0);continue}let c=await this.app.vault.read(o),h=this.highlights.get(o.path)||[];this.detectAndStoreMarkdownHighlights(c,o,!1);let g=this.highlights.get(o.path)||[],u=JSON.stringify(h.map(p=>({id:p.id,text:p.text,start:p.startOffset,end:p.endOffset,footnotes:p.footnoteCount}))),m=JSON.stringify(g.map(p=>({id:p.id,text:p.text,start:p.startOffset,end:p.endOffset,footnotes:p.footnoteCount})));u!==m&&(l=!0)}catch(c){}for(let o of this.collections.values()){let c=o.highlightIds.length;o.highlightIds=o.highlightIds.filter(h=>{for(let[g,u]of this.highlights)if(u.some(m=>m.id===h))return!0;return!1}),o.highlightIds.length!==c&&(l=!0)}l&&(await this.saveSettings(),this.refreshSidebar())}finally{this.isScanningFiles=!1}}detectAndStoreMarkdownHighlights(t,e,s=!0){let n=/==((?:[^=]|=[^=])+?)==/g,i=/%%([^%](?:[^%]|%[^%])*?)%%/g,a=[],l=this.highlights.get(e.path)||[],o=new Set,c=(T,E,x,M)=>{let F=l.find(P=>!o.has(P.id)&&P.text===T&&P.startOffset===E&&P.endOffset===x&&P.isNativeComment===M);if(F)return o.add(F.id),F;let D=l.find(P=>!o.has(P.id)&&P.text===T&&Math.abs(P.startOffset-E)<=50&&P.isNativeComment===M);if(D)return o.add(D.id),D;let N=l.find(P=>!o.has(P.id)&&P.text===T&&P.isNativeComment===M&&!l.some(C=>C!==P&&C.text===T&&C.isNativeComment===M));if(N)return o.add(N.id),N},h=this.extractFootnotes(t),g=this.getCodeBlockRanges(t),u=this.getMarkdownLinkRanges(t),m=[],p;for(;(p=n.exec(t))!==null;){if(this.isInsideCodeBlock(p.index,p.index+p[0].length,g)||this.isHighlightDelimiterInLink(p.index,p.index+p[0].length,t,u))continue;let T=t.charAt(p.index-1),E=t.charAt(p.index+p[0].length);T==="="||E==="="||m.push({match:p,type:"highlight"})}for(;(p=i.exec(t))!==null;){if(this.isInsideCodeBlock(p.index,p.index+p[0].length,g)||this.isHighlightDelimiterInLink(p.index,p.index+p[0].length,t,u))continue;let T=t.charAt(p.index-1),E=t.charAt(p.index+p[0].length);T==="%"||E==="%"||m.push({match:p,type:"comment"})}let y=[];if(this.settings.detectHtmlComments){let T=/<!--([^]*?)-->/g;for(;(p=T.exec(t))!==null;)this.isInsideCodeBlock(p.index,p.index+p[0].length,g)||this.isHighlightDelimiterInLink(p.index,p.index+p[0].length,t,u)||(m.push({match:p,type:"comment"}),y.push({start:p.index,end:p.index+p[0].length}))}this.settings.customPatterns.forEach(T=>{try{let E=new RegExp(T.pattern,"g"),x=0,M=1e3;for(;(p=E.exec(t))!==null;){if(x++,x>M){console.error(`Custom pattern "${T.name}" exceeded match limit. Pattern may be too broad.`),new b.Notice(`Custom pattern "${T.name}" is causing performance issues and has been skipped.`,8e3);break}p.index===E.lastIndex&&E.lastIndex++,!this.isInsideCodeBlock(p.index,p.index+p[0].length,g)&&!this.isInsideCodeBlock(p.index,p.index+p[0].length,u)&&!this.isInsideCodeBlock(p.index,p.index+p[0].length,y)&&m.push({match:p,type:T.type==="comment"?"comment":"highlight",isCustomPattern:!0})}}catch(E){console.error(`Invalid custom pattern "${T.name}":`,E),new b.Notice(`Custom pattern "${T.name}" caused an error and has been skipped.`,5e3)}});let v=[...g,...u];j.parseHighlights(t,v).forEach(T=>{let E=[T.fullMatch,T.text];E.index=T.startOffset,E.input=t,m.push({match:E,type:"html",color:T.color})}),m.sort((T,E)=>T.match.index-E.match.index);let k=new Map;for(let T=0;T<m.length-1;T++){let E=m[T],x=m[T+1];if((E.type==="highlight"||E.type==="html")&&x.type==="comment"){let M=E.match.index+E.match[0].length,F=x.match.index,D=t.substring(M,F),N=Z.calculateFootnoteLength(D),P=D.substring(N),C=/\n\s*\n/.test(P);if(/^\s*$/.test(P)&&!C){let w=x.match[0].startsWith("%%")&&x.match[0].endsWith("%%");this.settings.detectAdjacentNativeComments&&(k.set(T,{text:x.match[1].trim(),position:F}),m[T+1]={...x,type:"comment",skip:!0})}}}m.forEach(({match:T,type:E,color:x,skip:M,isCustomPattern:F},D)=>{if(M)return;let[,N]=T;if(!N||N.trim()==="")return;let P=c(N,T.index,T.index+T[0].length,E==="comment"),C=t.substring(0,T.index).split(`
`).length-1,w=[],A=0;if(E==="highlight"||E==="html"){let L=t.substring(T.index+T[0].length),R=[];this.inlineFootnoteManager.extractInlineFootnotes(t,T.index+T[0].length).forEach(Y=>{Y.content.trim()&&R.push({type:"inline",index:Y.startIndex,content:Y.content.trim()})});let V=new RegExp(nt),O,z=0;for(;(O=V.exec(L))!==null;){let Y=L.substring(z,O.index),_=ot.test(Y);if(O.index===z||_){let it=O[2];if(h.has(it)){let X=h.get(it).trim();X&&R.push({type:"standard",index:T.index+T[0].length+O.index,content:X})}z=O.index+O[0].length}else break}if(k.has(D)){let Y=k.get(D);R.push({type:"inline",index:Y.position,content:Y.text})}R.sort((Y,_)=>Y.index-_.index),w=R.map(Y=>Y.content),A=w.length}else E==="comment"&&(w=[N],A=1);if(P)a.push({...P,line:C,startOffset:T.index,endOffset:T.index+T[0].length,filePath:e.path,footnoteCount:A,footnoteContents:w,isNativeComment:E==="comment",color:E==="html"?x:P.color,createdAt:P.createdAt||Date.now(),type:F?"custom":E,fullMatch:F?T[0]:void 0});else{let L=e.stat.mtime+T.index%1e3;a.push({id:this.generateId(),text:N,tags:[],line:C,startOffset:T.index,endOffset:T.index+T[0].length,filePath:e.path,footnoteCount:A,footnoteContents:w,createdAt:L,isNativeComment:E==="comment",color:E==="html"?x:void 0,type:F?"custom":E,fullMatch:F?T[0]:void 0})}});let I=JSON.stringify(l.map(T=>{var E;return{id:T.id,start:T.startOffset,end:T.endOffset,text:T.text,footnotes:T.footnoteCount,contents:(E=T.footnoteContents)==null?void 0:E.filter(x=>x.trim()!==""),color:T.color,isNativeComment:T.isNativeComment}})),H=JSON.stringify(a.map(T=>{var E;return{id:T.id,start:T.startOffset,end:T.endOffset,text:T.text,footnotes:T.footnoteCount,contents:(E=T.footnoteContents)==null?void 0:E.filter(x=>x.trim()!==""),color:T.color,isNativeComment:T.isNativeComment}}));I!==H&&(this.highlights.set(e.path,a),s&&(this.saveSettings(),this.smartUpdateSidebar(l,a)))}smartUpdateSidebar(t,e){var c,h;if(!this.sidebarView)return;let s=this.sidebarView.getViewMode();if(s==="tasks"||s==="collections")return;let n=new Map,i=new Map;t.forEach(g=>n.set(g.id,g)),e.forEach(g=>i.set(g.id,g));let a=new Set(n.keys()),l=new Set(i.keys());if(a.size!==l.size||[...a].some(g=>!l.has(g))||[...l].some(g=>!a.has(g)))this.sidebarView.updateContent();else for(let[g,u]of i){let m=n.get(g);if(m){let p=JSON.stringify({text:m.text,footnotes:m.footnoteCount,contents:(c=m.footnoteContents)==null?void 0:c.filter(v=>v.trim()!==""),color:m.color,isNativeComment:m.isNativeComment}),y=JSON.stringify({text:u.text,footnotes:u.footnoteCount,contents:(h=u.footnoteContents)==null?void 0:h.filter(v=>v.trim()!==""),color:u.color,isNativeComment:u.isNativeComment});p!==y&&this.sidebarView.updateItem(g)}}}extractFootnotes(t){let e=new Map,s=/^\[\^(\w+)\]:\s*(.+)$/gm,n;for(;(n=s.exec(t))!==null;){let[,i,a]=n;e.set(i,a.trim())}return e}async handleFileCreate(t){try{let e=await this.app.vault.read(t);this.detectAndStoreMarkdownHighlights(e,t,!1);let s=this.highlights.get(t.path);s&&s.length>0&&(await this.saveSettings(),this.refreshSidebar())}catch(e){}}async handleFileRename(t,e){let s=this.highlights.get(e);if(s&&s.length>0){let n=s.map(i=>({...i,filePath:t.path}));this.highlights.delete(e),this.highlights.set(t.path,n),await this.saveSettings(),this.refreshSidebar()}}handleFileDelete(t){if(this.highlights.has(t.path)){let e=new Set((this.highlights.get(t.path)||[]).map(n=>n.id));this.highlights.delete(t.path);let s=!1;for(let n of this.collections.values()){let i=n.highlightIds.length;n.highlightIds=n.highlightIds.filter(a=>!e.has(a)),n.highlightIds.length!==i&&(s=!0)}this.saveSettings(),this.refreshSidebar()}}getCurrentFileHighlights(){let t=this.app.workspace.getActiveFile();return t?this.highlights.get(t.path)||[]:[]}generateId(){return Math.random().toString(36).substr(2,9)}getFilesWithCollectionHighlights(){let t=new Set;for(let e of this.collections.values())for(let s of e.highlightIds)for(let[n,i]of this.highlights)if(i.some(a=>a.id===s)){t.add(n);break}return t}isHighlightInCollection(t){for(let e of this.collections.values())if(e.highlightIds.includes(t))return!0;return!1}shouldProcessFile(t){return!(t.extension!=="md"||this.settings.excludeExcalidraw&&t.name.endsWith(".excalidraw.md")||this.isFileExcluded(t.path))}isFileExcluded(t){let e=this.settings.fileFilters;if(!e||e.length===0)return!1;let s=t.replace(/\\/g,"/"),n=!1,i=!1,a=!1;for(let l of e){let o=l.path.replace(/\\/g,"/");(s===o||s.startsWith(o+"/"))&&(l.mode==="include"?i=!0:a=!0),l.mode==="include"&&(n=!0)}return i?!1:!!(n&&!i||a)}async isExcalidrawFile(t){if(!this.settings.excludeExcalidraw)return!1;if(t.name.endsWith(".excalidraw.md"))return!0;try{let s=(await this.app.vault.read(t)).match(/^---\n([\s\S]*?)\n---/);if(s){let n=s[1];if(/excalidraw-plugin:\s*parsed/i.test(n)||/tags:\s*\[.*excalidraw.*\]/i.test(n))return!0}}catch(e){}return!1}async fixDuplicateTimestamps(){let t=!1;for(let[e,s]of this.highlights){let n=new Map;s.forEach(i=>{i.createdAt&&(n.has(i.createdAt)||n.set(i.createdAt,[]),n.get(i.createdAt).push(i))});for(let[i,a]of n)a.length>1&&(a.sort((l,o)=>l.startOffset-o.startOffset),a.forEach((l,o)=>{o>0&&(l.createdAt=i+o,t=!0)}))}t&&(await this.saveSettings(),this.refreshSidebar())}getCodeBlockRanges(t){let e=[],s=t.split(`
`),n=null,i=null,a=0;for(let c=0;c<s.length;c++){let h=s[c],g=a,u=a+h.length;h.match(/^```/)?i==="backtick"?(e.push({start:n,end:u}),n=null,i=null):n===null&&(n=g,i="backtick"):h.match(/^~~~/)&&(i==="wave"?(e.push({start:n,end:u}),n=null,i=null):n===null&&(n=g,i="wave")),a=u+1}n!==null&&e.push({start:n,end:t.length});let l=/`([^`\n]+?)`/g,o;for(;(o=l.exec(t))!==null;)e.push({start:o.index,end:o.index+o[0].length});return e}getMarkdownLinkRanges(t){let e=[],s=/\[([^\]]+)\]\(([^)]+)\)/g,n;for(;(n=s.exec(t))!==null;)e.push({start:n.index,end:n.index+n[0].length});return e}isInsideCodeBlock(t,e,s){return s.some(n=>t<n.end&&e>n.start)}isHighlightDelimiterInLink(t,e,s,n){for(let i of n){let l=s.substring(i.start,i.end).indexOf("](")+2,o=i.start+l,c=i.end-1,h=t+2;if(t>=o&&h<=c||e-2>=o&&e<=c)return!0}return!1}},xt=class extends b.Modal{constructor(t,e,s){super(t);this.pattern=e,this.onSubmit=s}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:this.pattern?d("modals.customPattern.editTitle"):d("modals.customPattern.addTitle")});e.style.marginBottom="20px",new b.Setting(t).setName(d("modals.customPattern.nameLabel")).setDesc(d("modals.customPattern.nameDesc")).addText(o=>{var c;this.nameInput=o.inputEl,o.setValue(((c=this.pattern)==null?void 0:c.name)||"").setPlaceholder(d("modals.customPattern.namePlaceholder"))});let s=document.createDocumentFragment();s.append(d("modals.customPattern.patternDesc"),document.createElement("br"),document.createElement("code")),s.lastChild.textContent="//(.+)//",s.append(" or ");let n=document.createElement("code");n.textContent="\\[\\[(.+?)\\]\\]",s.append(n),new b.Setting(t).setName(d("modals.customPattern.patternLabel")).setDesc(s).addText(o=>{var c;this.patternInput=o.inputEl,o.setValue(((c=this.pattern)==null?void 0:c.pattern)||"").setPlaceholder(d("modals.customPattern.patternPlaceholder")).then(h=>{h.inputEl.style.width="100%",h.inputEl.style.fontFamily="monospace"})}),new b.Setting(t).setName(d("modals.customPattern.typeLabel")).setDesc(d("modals.customPattern.typeDesc")).addDropdown(o=>{var c;this.typeSelect=o.selectEl,o.addOption("highlight",d("modals.customPattern.typeHighlight")).addOption("comment",d("modals.customPattern.typeComment")).setValue(((c=this.pattern)==null?void 0:c.type)||"highlight")});let i=t.createDiv({cls:"modal-button-container"});i.style.display="flex",i.style.justifyContent="flex-end",i.style.gap="10px",i.style.marginTop="20px",i.createEl("button",{text:d("modals.customPattern.cancel")}).addEventListener("click",()=>this.close()),i.createEl("button",{text:d("modals.customPattern.save"),cls:"mod-cta"}).addEventListener("click",()=>{let o=this.nameInput.value.trim(),c=this.patternInput.value.trim(),h=this.typeSelect.value;if(!o){new b.Notice(d("modals.customPattern.nameRequired"));return}if(!c){new b.Notice(d("modals.customPattern.patternRequired"));return}let g;try{g=new RegExp(c,"g")}catch(v){new b.Notice(d("modals.customPattern.invalidRegex")+": "+v.message);return}if(!c.includes("(")||!c.includes(")")){new b.Notice(d("modals.customPattern.capturingGroupRequired"));return}let u=[{pattern:/==/,name:"markdown highlights (==)"},{pattern:/%%/,name:"native comments (%%)"},{pattern:/<!--/,name:"HTML comments"}];for(let v of u)v.pattern.test(c)&&new b.Notice(d("modals.customPattern.conflictWarning",{name:v.name}),5e3);let m="Test text with ==highlights== and %% comments %% and more text to test the pattern.",p=Date.now(),y=100;try{let v=0,S,k=new RegExp(c,"g");for(;(S=k.exec(m))!==null&&v<100;){if(v++,Date.now()-p>y){new b.Notice("Pattern is too slow and may cause performance issues. Please simplify your pattern.",8e3);return}S.index===k.lastIndex&&k.lastIndex++}if(v>=100){new b.Notice("Pattern matches too frequently and may cause performance issues.",8e3);return}}catch(v){new b.Notice("Pattern test failed: "+v.message);return}this.onSubmit({name:o,pattern:c,type:h}),this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},bt=class extends b.Modal{constructor(t,e,s=""){super(t);this.onSubmit=e,this.currentName=s}onOpen(){let{contentEl:t}=this;t.empty();let e=t.createEl("div",{cls:"modal-title",text:this.currentName?d("modals.displayMode.renameTitle"):d("modals.displayMode.createTitle")});e.style.marginBottom="20px",new b.Setting(t).setName(d("modals.displayMode.nameLabel")).setDesc(d("modals.displayMode.nameDesc")).addText(a=>{this.nameInput=a.inputEl,a.setValue(this.currentName).setPlaceholder(d("modals.displayMode.namePlaceholder")),window.setTimeout(()=>{a.inputEl.focus(),this.currentName&&a.inputEl.select()},100)});let s=t.createDiv({cls:"modal-button-container"});s.style.display="flex",s.style.justifyContent="flex-end",s.style.gap="10px",s.style.marginTop="20px",s.createEl("button",{text:d("modals.displayMode.cancel")}).addEventListener("click",()=>this.close());let i=s.createEl("button",{text:d("modals.displayMode.save"),cls:"mod-cta"});i.addEventListener("click",()=>{let a=this.nameInput.value.trim();if(!a){new b.Notice(d("modals.displayMode.nameRequired")),this.nameInput.focus();return}this.onSubmit(a),this.close()}),t.addEventListener("keydown",a=>{a.key==="Enter"?i.click():a.key==="Escape"&&this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},Ft=class extends b.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new b.Setting(t).setHeading().setName(d("settings.display.heading")),new b.Setting(t).setName(d("settings.display.showTitles.name")).setDesc(d("settings.display.showTitles.desc")).addToggle(C=>C.setValue(this.plugin.settings.showFilenames).onChange(async w=>{this.plugin.settings.showFilenames=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.display.showTimestamps.name")).setDesc(d("settings.display.showTimestamps.desc")).addToggle(C=>C.setValue(this.plugin.settings.showTimestamps).onChange(async w=>{this.plugin.settings.showTimestamps=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.display.showActions.name")).setDesc(d("settings.display.showActions.desc")).addToggle(C=>C.setValue(this.plugin.settings.showHighlightActions).onChange(async w=>{this.plugin.settings.showHighlightActions=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.display.showToolbar.name")).setDesc(d("settings.display.showToolbar.desc")).addToggle(C=>C.setValue(this.plugin.settings.showToolbar).onChange(async w=>{this.plugin.settings.showToolbar=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.display.autoUnfold.name")).setDesc(d("settings.display.autoUnfold.desc")).addToggle(C=>C.setValue(this.plugin.settings.autoToggleFold).onChange(async w=>{this.plugin.settings.autoToggleFold=w,await this.plugin.saveSettings()})),new b.Setting(t).setName(d("settings.display.dateFormat.name")).setDesc(d("settings.display.dateFormat.desc")).addMomentFormat(C=>C.setValue(this.plugin.settings.dateFormat).setPlaceholder(d("settings.display.dateFormat.placeholder")).onChange(async w=>{this.plugin.settings.dateFormat=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.display.minimumCharCount.name")).setDesc(d("settings.display.minimumCharCount.desc")).addText(C=>C.setPlaceholder(d("settings.display.minimumCharCount.placeholder")).setValue(this.plugin.settings.minimumCharacterCount.toString()).onChange(async w=>{let A=parseInt(w)||0;this.plugin.settings.minimumCharacterCount=Math.max(0,A),await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setHeading().setName(d("settings.views.heading")),new b.Setting(t).setName(d("settings.views.showCurrentNoteTab.name")).setDesc(d("settings.views.showCurrentNoteTab.desc")).addToggle(C=>C.setValue(this.plugin.settings.showCurrentNoteTab).onChange(async w=>{this.plugin.settings.showCurrentNoteTab=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.views.showAllNotesTab.name")).setDesc(d("settings.views.showAllNotesTab.desc")).addToggle(C=>C.setValue(this.plugin.settings.showAllNotesTab).onChange(async w=>{this.plugin.settings.showAllNotesTab=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.views.showCollectionsTab.name")).setDesc(d("settings.views.showCollectionsTab.desc")).addToggle(C=>C.setValue(this.plugin.settings.showCollectionsTab).onChange(async w=>{this.plugin.settings.showCollectionsTab=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.views.showTasksTab.name")).setDesc(d("settings.views.showTasksTab.desc")).addToggle(C=>C.setValue(this.plugin.settings.showTasksTab).onChange(async w=>{this.plugin.settings.showTasksTab=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setHeading().setName(d("settings.displayModes.heading")),new b.Setting(t).setName(d("settings.displayModes.saveCurrentLabel")).setDesc(d("settings.displayModes.saveCurrentDesc")).addButton(C=>C.setButtonText(d("settings.displayModes.saveButton")).setCta().onClick(()=>{new bt(this.app,A=>{let L=this.plugin.createDisplayModeFromCurrent(A);this.plugin.settings.displayModes.push(L),this.plugin.saveSettings(),this.plugin.registerDisplayModeCommands(),this.display(),new b.Notice(d("notices.displayModeSaved",{name:A}))}).open()}));let e=t.createDiv();this.renderDisplayModes(e),new b.Setting(t).setHeading().setName(d("settings.typography.heading")),new b.Setting(t).setName(d("settings.typography.highlightTextSize.name")).setDesc(d("settings.typography.highlightTextSize.desc")).addText(C=>C.setPlaceholder(d("settings.typography.highlightTextSize.placeholder")).setValue(this.plugin.settings.highlightFontSize.toString()).onChange(async w=>{let A=parseInt(w);!isNaN(A)&&A>=8&&A<=32&&(this.plugin.settings.highlightFontSize=A,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new b.Setting(t).setName(d("settings.typography.detailsTextSize.name")).setDesc(d("settings.typography.detailsTextSize.desc")).addText(C=>C.setPlaceholder(d("settings.typography.detailsTextSize.placeholder")).setValue(this.plugin.settings.detailsFontSize.toString()).onChange(async w=>{let A=parseInt(w);!isNaN(A)&&A>=8&&A<=24&&(this.plugin.settings.detailsFontSize=A,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new b.Setting(t).setName(d("settings.typography.commentTextSize.name")).setDesc(d("settings.typography.commentTextSize.desc")).addText(C=>C.setPlaceholder(d("settings.typography.commentTextSize.placeholder")).setValue(this.plugin.settings.commentFontSize.toString()).onChange(async w=>{let A=parseInt(w);!isNaN(A)&&A>=8&&A<=24&&(this.plugin.settings.commentFontSize=A,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar())})),new b.Setting(t).setName(d("settings.typography.highlightTextWeight.name")).setDesc(d("settings.typography.highlightTextWeight.desc")).addDropdown(C=>C.addOption("300",d("settings.typography.fontWeight.light")).addOption("400",d("settings.typography.fontWeight.normal")).addOption("500",d("settings.typography.fontWeight.medium")).addOption("600",d("settings.typography.fontWeight.semiBold")).addOption("700",d("settings.typography.fontWeight.bold")).setValue(this.plugin.settings.highlightFontWeight.toString()).onChange(async w=>{this.plugin.settings.highlightFontWeight=parseInt(w),await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.typography.taskTextWeight.name")).setDesc(d("settings.typography.taskTextWeight.desc")).addDropdown(C=>C.addOption("300",d("settings.typography.fontWeight.light")).addOption("400",d("settings.typography.fontWeight.normal")).addOption("500",d("settings.typography.fontWeight.medium")).addOption("600",d("settings.typography.fontWeight.semiBold")).addOption("700",d("settings.typography.fontWeight.bold")).setValue(this.plugin.settings.taskFontWeight.toString()).onChange(async w=>{this.plugin.settings.taskFontWeight=parseInt(w),await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshSidebar()})),new b.Setting(t).setHeading().setName(d("settings.styling.heading")),new b.Setting(t).setName(d("settings.colors.heading")).setHeading();let s,n,i=new b.Setting(t).setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.yellow.toUpperCase()})).setDesc(d("settings.colors.customizeFirst")).addColorPicker(C=>(n=C,C.setValue(this.plugin.settings.customColors.yellow).onChange(async w=>{this.plugin.settings.customColors.yellow=w,await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(d("settings.colors.highlightColor",{color:w.toUpperCase()})),s==null||s.setName(d("settings.colorNames.nameFor",{color:w.toUpperCase()}))}))).addButton(C=>C.setButtonText(d("settings.colors.reset")).setTooltip(d("settings.colors.resetToYellow")).onClick(async()=>{this.plugin.settings.customColors.yellow="#ffd700",await this.plugin.saveSettings(),this.updateColorMappings(),i.setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.yellow.toUpperCase()})),n==null||n.setValue("#ffd700"),s==null||s.setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.yellow.toUpperCase()}))})),a,l,o=new b.Setting(t).setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.red.toUpperCase()})).setDesc(d("settings.colors.customizeSecond")).addColorPicker(C=>(l=C,C.setValue(this.plugin.settings.customColors.red).onChange(async w=>{this.plugin.settings.customColors.red=w,await this.plugin.saveSettings(),this.updateColorMappings(),o.setName(d("settings.colors.highlightColor",{color:w.toUpperCase()})),a==null||a.setName(d("settings.colorNames.nameFor",{color:w.toUpperCase()}))}))).addButton(C=>C.setButtonText(d("settings.colors.reset")).setTooltip(d("settings.colors.resetToRed")).onClick(async()=>{this.plugin.settings.customColors.red="#ff6b6b",await this.plugin.saveSettings(),this.updateColorMappings(),o.setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.red.toUpperCase()})),l==null||l.setValue("#ff6b6b"),a==null||a.setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.red.toUpperCase()}))})),c,h,g=new b.Setting(t).setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.teal.toUpperCase()})).setDesc(d("settings.colors.customizeThird")).addColorPicker(C=>(h=C,C.setValue(this.plugin.settings.customColors.teal).onChange(async w=>{this.plugin.settings.customColors.teal=w,await this.plugin.saveSettings(),this.updateColorMappings(),g.setName(d("settings.colors.highlightColor",{color:w.toUpperCase()})),c==null||c.setName(d("settings.colorNames.nameFor",{color:w.toUpperCase()}))}))).addButton(C=>C.setButtonText(d("settings.colors.reset")).setTooltip(d("settings.colors.resetToTeal")).onClick(async()=>{this.plugin.settings.customColors.teal="#4ecdc4",await this.plugin.saveSettings(),this.updateColorMappings(),g.setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.teal.toUpperCase()})),h==null||h.setValue("#4ecdc4"),c==null||c.setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.teal.toUpperCase()}))})),u,m,p=new b.Setting(t).setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.blue.toUpperCase()})).setDesc(d("settings.colors.customizeFourth")).addColorPicker(C=>(m=C,C.setValue(this.plugin.settings.customColors.blue).onChange(async w=>{this.plugin.settings.customColors.blue=w,await this.plugin.saveSettings(),this.updateColorMappings(),p.setName(d("settings.colors.highlightColor",{color:w.toUpperCase()})),u==null||u.setName(d("settings.colorNames.nameFor",{color:w.toUpperCase()}))}))).addButton(C=>C.setButtonText(d("settings.colors.reset")).setTooltip(d("settings.colors.resetToBlue")).onClick(async()=>{this.plugin.settings.customColors.blue="#45b7d1",await this.plugin.saveSettings(),this.updateColorMappings(),p.setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.blue.toUpperCase()})),m==null||m.setValue("#45b7d1"),u==null||u.setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.blue.toUpperCase()}))})),y,v,S=new b.Setting(t).setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.green.toUpperCase()})).setDesc(d("settings.colors.customizeFifth")).addColorPicker(C=>(v=C,C.setValue(this.plugin.settings.customColors.green).onChange(async w=>{this.plugin.settings.customColors.green=w,await this.plugin.saveSettings(),this.updateColorMappings(),S.setName(d("settings.colors.highlightColor",{color:w.toUpperCase()})),y==null||y.setName(d("settings.colorNames.nameFor",{color:w.toUpperCase()}))}))).addButton(C=>C.setButtonText(d("settings.colors.reset")).setTooltip(d("settings.colors.resetToGreen")).onClick(async()=>{this.plugin.settings.customColors.green="#96ceb4",await this.plugin.saveSettings(),this.updateColorMappings(),S.setName(d("settings.colors.highlightColor",{color:this.plugin.settings.customColors.green.toUpperCase()})),v==null||v.setValue("#96ceb4"),y==null||y.setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.green.toUpperCase()}))}));new b.Setting(t).setName(d("settings.colorNames.heading")).setHeading(),s=new b.Setting(t).setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.yellow.toUpperCase()})).setDesc(d("settings.colorNames.desc")).addText(C=>C.setPlaceholder(d("settings.colorNames.placeholder")).setValue(this.plugin.settings.customColorNames.yellow).onChange(async w=>{this.plugin.settings.customColorNames.yellow=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),a=new b.Setting(t).setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.red.toUpperCase()})).setDesc(d("settings.colorNames.desc")).addText(C=>C.setPlaceholder(d("settings.colorNames.placeholder")).setValue(this.plugin.settings.customColorNames.red).onChange(async w=>{this.plugin.settings.customColorNames.red=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),c=new b.Setting(t).setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.teal.toUpperCase()})).setDesc(d("settings.colorNames.desc")).addText(C=>C.setPlaceholder(d("settings.colorNames.placeholder")).setValue(this.plugin.settings.customColorNames.teal).onChange(async w=>{this.plugin.settings.customColorNames.teal=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),u=new b.Setting(t).setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.blue.toUpperCase()})).setDesc(d("settings.colorNames.desc")).addText(C=>C.setPlaceholder(d("settings.colorNames.placeholder")).setValue(this.plugin.settings.customColorNames.blue).onChange(async w=>{this.plugin.settings.customColorNames.blue=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),y=new b.Setting(t).setName(d("settings.colorNames.nameFor",{color:this.plugin.settings.customColors.green.toUpperCase()})).setDesc(d("settings.colorNames.desc")).addText(C=>C.setPlaceholder(d("settings.colorNames.placeholder")).setValue(this.plugin.settings.customColorNames.green).onChange(async w=>{this.plugin.settings.customColorNames.green=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setHeading().setName(d("settings.comments.heading")),new b.Setting(t).setName(d("settings.comments.useInlineFootnotes.name")).setDesc(d("settings.comments.useInlineFootnotes.desc")).addToggle(C=>C.setValue(this.plugin.settings.useInlineFootnotes).onChange(async w=>{this.plugin.settings.useInlineFootnotes=w,await this.plugin.saveSettings()})),new b.Setting(t).setName(d("settings.comments.selectTextOnClick.name")).setDesc(d("settings.comments.selectTextOnClick.desc")).addToggle(C=>C.setValue(this.plugin.settings.selectTextOnCommentClick).onChange(async w=>{this.plugin.settings.selectTextOnCommentClick=w,await this.plugin.saveSettings()})),new b.Setting(t).setName(d("settings.detection.detectHtmlComments.name")).setDesc(d("settings.detection.detectHtmlComments.desc")).addToggle(C=>C.setValue(this.plugin.settings.detectHtmlComments).onChange(async w=>{this.plugin.settings.detectHtmlComments=w,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()})),new b.Setting(t).setName(d("settings.detection.detectAdjacentNativeComments.name")).setDesc(d("settings.detection.detectAdjacentNativeComments.desc")).addToggle(C=>C.setValue(this.plugin.settings.detectAdjacentNativeComments).onChange(async w=>{this.plugin.settings.detectAdjacentNativeComments=w,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()}));let k=document.createDocumentFragment();k.append(d("settings.detection.customPatterns.heading")+" ");let I=document.createElement("span");I.textContent=d("settings.detection.customPatterns.experimental"),I.style.fontSize="0.8em",I.style.padding="2px 6px",I.style.borderRadius="3px",I.style.backgroundColor="var(--interactive-accent)",I.style.color="var(--text-on-accent)",I.style.fontWeight="500",I.style.marginLeft="6px",k.appendChild(I),new b.Setting(t).setHeading().setName(k);let H=document.createDocumentFragment();H.append(d("settings.detection.customPatterns.desc"),document.createElement("br"),d("settings.detection.customPatterns.examples"),document.createElement("code")),H.lastChild.textContent="//(.+)//",H.append(" "+d("settings.detection.customPatterns.forRegexMark")+" ");let T=document.createElement("code");T.textContent="\\[\\[(.+?)\\]\\]",H.append(T),H.append(" "+d("settings.detection.customPatterns.forWikilinks"));let E=new b.Setting(t).setDesc(H),x=t.createDiv("custom-patterns-container"),M=()=>{x.empty(),this.plugin.settings.customPatterns.forEach((C,w)=>{let A=new b.Setting(x).setName(C.name||`Pattern ${w+1}`).setDesc(`Type: ${C.type} | Pattern: ${C.pattern}`).addButton(L=>L.setButtonText(d("settings.detection.customPatterns.editButton")).onClick(()=>{new xt(this.app,C,async R=>{this.plugin.settings.customPatterns[w]=R,await this.plugin.saveSettings(),M(),this.plugin.scanAllFilesForHighlights()}).open()})).addButton(L=>L.setButtonText(d("settings.detection.customPatterns.deleteButton")).setWarning().onClick(async()=>{this.plugin.settings.customPatterns.splice(w,1),await this.plugin.saveSettings(),M(),this.plugin.scanAllFilesForHighlights()}))}),new b.Setting(x).addButton(C=>C.setButtonText(d("settings.detection.customPatterns.addButton")).setCta().onClick(()=>{new xt(this.app,null,async w=>{this.plugin.settings.customPatterns.push(w),await this.plugin.saveSettings(),M(),this.plugin.scanAllFilesForHighlights()}).open()}))};M(),new b.Setting(t).setHeading().setName(d("settings.filters.heading")),new b.Setting(t).setName(d("settings.filters.excludeExcalidraw.name")).setDesc(d("settings.filters.excludeExcalidraw.desc")).addToggle(C=>C.setValue(this.plugin.settings.excludeExcalidraw).onChange(async w=>{this.plugin.settings.excludeExcalidraw=w,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights()})),new b.Setting(t).setName(d("settings.filters.excludedFiles.name")).setDesc(d("settings.filters.excludedFiles.desc")).addButton(C=>{C.setButtonText(d("settings.filters.excludedFiles.manageButton")).onClick(()=>{new vt(this.app,this.plugin.settings.fileFilters,this.plugin.settings.fileFilterMode,async A=>{this.plugin.settings.fileFilters=A,await this.plugin.saveSettings(),this.plugin.scanAllFilesForHighlights(),this.plugin.refreshSidebar()}).open()})}),new b.Setting(t).setHeading().setName(d("settings.tasks.heading")),new b.Setting(t).setName(d("settings.tasks.showTaskContext.name")).setDesc(d("settings.tasks.showTaskContext.desc")).addToggle(C=>C.setValue(this.plugin.settings.showTaskContext).onChange(async w=>{this.plugin.settings.showTaskContext=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setName(d("settings.tasks.showCompletedTasks.name")).setDesc(d("settings.tasks.showCompletedTasks.desc")).addToggle(C=>C.setValue(this.plugin.settings.showCompletedTasks).onChange(async w=>{this.plugin.settings.showCompletedTasks=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));let F=new b.Setting(t).setName(d("settings.tasks.showCurrentNoteSection.name")).setDesc(d("settings.tasks.showCurrentNoteSection.desc")).addToggle(C=>C.setValue(this.plugin.settings.showCurrentNoteTasksSection).onChange(async w=>{this.plugin.settings.showCurrentNoteTasksSection=w,await this.plugin.saveSettings(),D.setDisabled(!w),D.settingEl.style.opacity=w?"1":"0.5",!w&&this.plugin.settings.showOnlyCurrentNoteTasks&&(this.plugin.settings.showOnlyCurrentNoteTasks=!1,await this.plugin.saveSettings()),this.plugin.refreshSidebar()})),D=new b.Setting(t).setName(d("settings.tasks.showOnlyCurrentNoteTasks.name")).setDesc(d("settings.tasks.showOnlyCurrentNoteTasks.desc")).addToggle(C=>C.setValue(this.plugin.settings.showOnlyCurrentNoteTasks).setDisabled(!this.plugin.settings.showCurrentNoteTasksSection).onChange(async w=>{this.plugin.settings.showOnlyCurrentNoteTasks=w,await this.plugin.saveSettings(),this.plugin.refreshSidebar()}));D.settingEl.style.opacity=this.plugin.settings.showCurrentNoteTasksSection?"1":"0.5",new b.Setting(t).setName(d("settings.tasks.taskDateFormat.name")).setDesc(d("settings.tasks.taskDateFormat.desc")).addText(C=>C.setPlaceholder(d("settings.tasks.taskDateFormat.placeholder")).setValue(this.plugin.settings.taskDateFormat).onChange(async w=>{this.plugin.settings.taskDateFormat=w||"YYYY-MM-DD",await this.plugin.saveSettings(),this.plugin.refreshSidebar()})),new b.Setting(t).setHeading().setName(d("settings.backupRestore.heading"));let N=new b.Setting(t).setName(d("settings.backupRestore.restoreLatest.name")).setDesc(d("settings.backupRestore.restoreLatest.desc")),P=async(C,w,A)=>{let L=await this.plugin.restoreFromBackup(C);if(L.success){let R=L.recoveredCount||0,B=L.orphanedCount||0,V=d("settings.backupRestore.restoreSuccess",{collections:w.toString(),highlights:R.toString()});B>0&&(V+=` ${d("settings.backupRestore.orphanedCleaned",{count:B.toString()})}`),new b.Notice(V),this.display()}else new b.Notice(d("settings.backupRestore.restoreFailed"))};N.addButton(C=>C.setButtonText(d("settings.backupRestore.restoreLatest.button")).setCta().onClick(async()=>{let w=await this.plugin.listBackups();if(w.length===0){new b.Notice(d("settings.backupRestore.noBackups"));return}let A=w[0],L=Object.keys(A.data.collections||{}).length,R=this.plugin.countHighlightsInCollections(A.data.collections||{});if(L===0&&R===0){new b.Notice(d("settings.backupRestore.emptyBackup"));return}let B=A.data.backupCreatedAt?new Date(A.data.backupCreatedAt).toLocaleString():d("settings.backupRestore.unknownDate"),V=d("settings.backupRestore.confirmRestore",{collections:L.toString(),highlights:R.toString(),date:B}),O=new b.Modal(this.app);O.titleEl.setText(d("settings.backupRestore.confirmTitle")),O.contentEl.createEl("p",{text:V});let z=O.contentEl.createDiv({cls:"modal-button-container"});z.style.marginTop="20px",z.style.display="flex",z.style.justifyContent="flex-end",z.style.gap="10px",z.createEl("button",{text:d("settings.backupRestore.cancel")}).addEventListener("click",()=>O.close()),z.createEl("button",{text:d("settings.backupRestore.restore"),cls:"mod-cta"}).addEventListener("click",async()=>{O.close(),await P(A.path,L,R)}),O.open()})),N.addButton(C=>C.setButtonText(d("settings.backupRestore.choose.button")).onClick(async()=>{let w=await this.plugin.listBackups();if(w.length===0){new b.Notice(d("settings.backupRestore.noBackups"));return}new yt(this.app,w,this.plugin.countHighlightsInCollections.bind(this.plugin),async(L,R,B)=>{let V=w.find(J=>J.path===L);if(!V)return;let O=V.data.backupCreatedAt?new Date(V.data.backupCreatedAt).toLocaleString():d("settings.backupRestore.unknownDate"),z=d("settings.backupRestore.confirmRestore",{collections:R.toString(),highlights:B.toString(),date:O}),Y=new b.Modal(this.app);Y.titleEl.setText(d("settings.backupRestore.confirmTitle")),Y.contentEl.createEl("p",{text:z});let _=Y.contentEl.createDiv({cls:"modal-button-container"});_.style.marginTop="20px",_.style.display="flex",_.style.justifyContent="flex-end",_.style.gap="10px",_.createEl("button",{text:d("settings.backupRestore.cancel")}).addEventListener("click",()=>Y.close()),_.createEl("button",{text:d("settings.backupRestore.restore"),cls:"mod-cta"}).addEventListener("click",async()=>{Y.close(),await P(L,R,B)}),Y.open()}).open()})),new b.Setting(t).setName(d("settings.backupRestore.createManual.name")).setDesc(d("settings.backupRestore.createManual.desc")).addButton(C=>C.setButtonText(d("settings.backupRestore.createManual.button")).onClick(async()=>{await this.plugin.createBackup("manual"),new b.Notice(d("settings.backupRestore.manualBackupCreated"))})),new b.Setting(t).setName("Activity log").setDesc("Copy recent restore activity for debugging.").addButton(C=>C.setButtonText("Copy").onClick(async()=>{let w=await this.plugin.getRestoreLog();if(!w){new b.Notice("No restore log found. Perform a backup restoration first.");return}await navigator.clipboard.writeText(w),new b.Notice("Restore log copied to clipboard!")}))}renderDisplayModes(t){if(t.empty(),this.plugin.settings.displayModes.length===0){t.createEl("p",{text:d("settings.displayModes.noModes"),cls:"setting-item-description"});return}this.plugin.settings.displayModes.forEach((e,s)=>{let n=this.plugin.settings.currentDisplayModeId===e.id;new b.Setting(t).setName(e.name).addButton(i=>(i.setButtonText(n?d("settings.displayModes.appliedButton"):d("settings.displayModes.applyButton")).onClick(async()=>{await this.plugin.applyDisplayMode(e),new b.Notice(d("notices.displayModeApplied",{name:e.name})),this.display()}),n&&i.buttonEl.addClass("mod-cta"),i)).addButton(i=>i.setButtonText(d("settings.displayModes.updateButton")).setTooltip(d("settings.displayModes.updateTooltip")).onClick(async()=>{await this.plugin.updateDisplayMode(e),new b.Notice(d("notices.displayModeUpdated",{name:e.name})),this.display()})).addButton(i=>i.setButtonText(d("settings.displayModes.renameButton")).onClick(()=>{new bt(this.app,l=>{e.name=l,this.plugin.saveSettings(),this.plugin.registerDisplayModeCommands(),this.renderDisplayModes(t),new b.Notice(d("notices.displayModeRenamed",{name:l}))},e.name).open()})).addButton(i=>i.setButtonText(d("settings.displayModes.deleteButton")).setWarning().onClick(()=>{this.plugin.settings.displayModes.splice(s,1),this.plugin.settings.currentDisplayModeId===e.id&&(this.plugin.settings.currentDisplayModeId=null),this.plugin.saveSettings(),this.plugin.registerDisplayModeCommands(),this.renderDisplayModes(t),new b.Notice(d("notices.displayModeDeleted",{name:e.name}))}))})}updateColorMappings(){this.plugin.refreshSidebar(),this.plugin.updateStyles()}},kt=class{constructor(r){this.plugin=r}createCollection(r,t){let e={id:this.plugin.generateId(),name:r,description:t,highlightIds:[],createdAt:Date.now()};return this.plugin.collections.set(e.id,e),this.plugin.saveSettings(),this.plugin.registerCollectionCommands(),e}deleteCollection(r){let t=`go-to-collection-${r}`;this.plugin.collectionCommands.has(t)&&(this.plugin.removeCommand(t),this.plugin.collectionCommands.delete(t)),this.plugin.collections.delete(r),this.plugin.saveSettings()}async deleteCollectionWithConfirmation(r){let t=this.plugin.collections.get(r);return t&&confirm(`Are you sure you want to delete "${t.name}"?`)?(this.deleteCollection(r),!0):!1}addHighlightToCollection(r,t){let e=this.plugin.collections.get(r);e&&!e.highlightIds.includes(t)&&(e.highlightIds.push(t),this.plugin.saveSettings())}removeHighlightFromCollection(r,t){let e=this.plugin.collections.get(r);e&&(e.highlightIds=e.highlightIds.filter(s=>s!==t),this.plugin.saveSettings())}getAllCollections(){return Array.from(this.plugin.collections.values())}getCollection(r){return this.plugin.collections.get(r)}getCollectionStats(r){let t=this.plugin.collections.get(r);if(!t)return{highlightCount:0,fileCount:0,nativeCommentsCount:0};let e=new Set,s=0,n=0;for(let i of t.highlightIds)for(let[a,l]of this.plugin.highlights){let o=l.find(c=>c.id===i);if(o){e.add(a),o.isNativeComment?n++:s++;break}}return{highlightCount:s,fileCount:e.size,nativeCommentsCount:n}}getHighlightsInCollection(r){let t=this.plugin.collections.get(r);if(!t)return[];let e=[];for(let s of t.highlightIds)for(let[n,i]of this.plugin.highlights){let a=i.find(l=>l.id===s);if(a){e.push(a);break}}return e}getHighlightCollectionCount(r){let t=0;for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t++;return t}getCollectionsForHighlight(r){let t=[];for(let e of this.plugin.collections.values())e.highlightIds.includes(r)&&t.push(e);return t}};

/* nosourcemap */